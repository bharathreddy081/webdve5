"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSauceEndpoint = getSauceEndpoint;
exports.detectBackend = detectBackend;
exports.initialisePlugin = initialisePlugin;
exports.validateConfig = validateConfig;

require("source-map-support/register");

const DEFAULT_HOSTNAME = '127.0.0.1';
const DEFAULT_PORT = 4444;
const DEFAULT_PROTOCOL = 'http';
const REGION_MAPPING = {
  'us': '',
  // default endpoint
  'eu': 'eu-central-1.'
};

function getSauceEndpoint(region) {
  const dc = region ? typeof REGION_MAPPING[region] !== 'undefined' ? REGION_MAPPING[region] : region + '.' : '';
  return `${dc}saucelabs.com`;
}
/**
 * helper to detect the Selenium backend according to given capabilities
 */


function detectBackend(options = {}) {
  const {
    port,
    hostname,
    user,
    key,
    protocol,
    region
  } = options;
  /**
   * browserstack
   * e.g. zHcv9sZ39ip8ZPsxBVJ2
   */

  if (typeof user === 'string' && key.length === 20) {
    return {
      hostname: 'hub.browserstack.com',
      port: 80
    };
  }
  /**
   * testingbot
   * e.g. ec337d7b677720a4dde7bd72be0bfc67
   */


  if (typeof user === 'string' && key.length === 32) {
    return {
      hostname: 'hub.testingbot.com',
      port: 80
    };
  }
  /**
   * Sauce Labs
   * e.g. 50aa152c-1932-B2f0-9707-18z46q2n1mb0
   */


  if (typeof user === 'string' && key.length === 36) {
    return {
      protocol: protocol || 'https',
      hostname: hostname || `ondemand.${getSauceEndpoint(region)}`,
      port: port || 443
    };
  }
  /**
   * no cloud provider detected, fallback to local browser driver
   */


  return {
    hostname: hostname || DEFAULT_HOSTNAME,
    port: port || DEFAULT_PORT,
    protocol: protocol || DEFAULT_PROTOCOL
  };
}
/**
 * Allows to safely require a package, it only throws if the package was found
 * but failed to load due to syntax errors
 * @param  {string} name  of package
 * @return {object}       package content
 */


function safeRequire(name) {
  try {
    return require(name);
  } catch (e) {
    if (!e.message.match(`Cannot find module '${name}'`)) {
      throw new Error(`Couldn't initialise "${name}".\n${e.stack}`);
    }

    return null;
  }
}
/**
 * initialise WebdriverIO compliant plugins like reporter or services in the following way:
 * 1. if package name is scoped (starts with "@"), require scoped package name
 * 2. otherwise try to require "@wdio/<name>-<type>"
 * 3. otherwise try to require "wdio-<name>-<type>"
 */


function initialisePlugin(name, type, target = 'default') {
  /**
   * directly import packages that are scoped
   */
  if (name[0] === '@') {
    const service = safeRequire(name);
    return service[target];
  }
  /**
   * check for scoped version of plugin first (e.g. @wdio/sauce-service)
   */


  const scopedPlugin = safeRequire(`@wdio/${name.toLowerCase()}-${type}`);

  if (scopedPlugin) {
    return scopedPlugin[target];
  }
  /**
   * check for old type of
   */


  const plugin = safeRequire(`wdio-${name.toLowerCase()}-${type}`);

  if (plugin) {
    return plugin[target];
  }

  throw new Error(`Couldn't find plugin "${name}" ${type}, neither as wdio scoped package ` + `"@wdio/${name.toLowerCase()}-${type}" nor as community package ` + `"wdio-${name.toLowerCase()}-${type}". Please make sure you have it installed!`);
}
/**
 * validates configurations based on default values
 * @param  {Object} defaults  object describing all allowed properties
 * @param  {Object} options   option to check agains
 * @return {Object}           validated config enriched with default values
 */


function validateConfig(defaults, options) {
  const params = {};

  for (const [name, expectedOption] of Object.entries(defaults)) {
    /**
     * check if options is given
     */
    if (typeof options[name] === 'undefined' && !expectedOption.default && expectedOption.required) {
      throw new Error(`Required option "${name}" is missing`);
    }

    if (typeof options[name] === 'undefined' && expectedOption.default) {
      params[name] = expectedOption.default;
    }

    if (typeof options[name] !== 'undefined') {
      if (typeof expectedOption.type === 'string' && typeof options[name] !== expectedOption.type) {
        throw new Error(`Expected option "${name}" to be type of ${expectedOption.type} but was ${typeof options[name]}`);
      }

      if (typeof expectedOption.type === 'function') {
        try {
          expectedOption.type(options[name]);
        } catch (e) {
          throw new Error(`Type check for option "${name}" failed: ${e.message}`);
        }
      }

      if (expectedOption.match && !options[name].match(expectedOption.match)) {
        throw new Error(`Option "${name}" doesn't match expected values: ${expectedOption.match}`);
      }

      params[name] = options[name];
    }
  }

  return params;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX0hPU1ROQU1FIiwiREVGQVVMVF9QT1JUIiwiREVGQVVMVF9QUk9UT0NPTCIsIlJFR0lPTl9NQVBQSU5HIiwiZ2V0U2F1Y2VFbmRwb2ludCIsInJlZ2lvbiIsImRjIiwiZGV0ZWN0QmFja2VuZCIsIm9wdGlvbnMiLCJwb3J0IiwiaG9zdG5hbWUiLCJ1c2VyIiwia2V5IiwicHJvdG9jb2wiLCJsZW5ndGgiLCJzYWZlUmVxdWlyZSIsIm5hbWUiLCJyZXF1aXJlIiwiZSIsIm1lc3NhZ2UiLCJtYXRjaCIsIkVycm9yIiwic3RhY2siLCJpbml0aWFsaXNlUGx1Z2luIiwidHlwZSIsInRhcmdldCIsInNlcnZpY2UiLCJzY29wZWRQbHVnaW4iLCJ0b0xvd2VyQ2FzZSIsInBsdWdpbiIsInZhbGlkYXRlQ29uZmlnIiwiZGVmYXVsdHMiLCJwYXJhbXMiLCJleHBlY3RlZE9wdGlvbiIsIk9iamVjdCIsImVudHJpZXMiLCJkZWZhdWx0IiwicmVxdWlyZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLE1BQU1BLGdCQUFnQixHQUFHLFdBQXpCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQXJCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsTUFBekI7QUFFQSxNQUFNQyxjQUFjLEdBQUc7QUFDbkIsUUFBTSxFQURhO0FBQ1Q7QUFDVixRQUFNO0FBRmEsQ0FBdkI7O0FBS08sU0FBU0MsZ0JBQVQsQ0FBMkJDLE1BQTNCLEVBQW1DO0FBQ3RDLFFBQU1DLEVBQUUsR0FBR0QsTUFBTSxHQUNiLE9BQU9GLGNBQWMsQ0FBQ0UsTUFBRCxDQUFyQixLQUFrQyxXQUFsQyxHQUNJRixjQUFjLENBQUNFLE1BQUQsQ0FEbEIsR0FDOEJBLE1BQU0sR0FBRyxHQUYxQixHQUdYLEVBSE47QUFJQSxTQUFRLEdBQUVDLEVBQUcsZUFBYjtBQUNIO0FBRUQ7Ozs7O0FBR08sU0FBU0MsYUFBVCxDQUF3QkMsT0FBTyxHQUFHLEVBQWxD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QUk7QUFDQVMsVUFBQUEsY0FBYyxDQUFDVCxJQUFmLENBQW9CaEIsT0FBTyxDQUFDUSxJQUFELENBQTNCO0FBQ0gsU0FGRCxDQUVFLE9BQU9FLENBQVAsRUFBVTtBQUNSLGdCQUFNLElBQUlHLEtBQUosQ0FBVywwQkFBeUJMLElBQUssYUFBWUUsQ0FBQyxDQUFDQyxPQUFRLEVBQS9ELENBQU47QUFDSDtBQUNKOztBQUVELFVBQUljLGNBQWMsQ0FBQ2IsS0FBZixJQUF3QixDQUFDWixPQUFPLENBQUNRLElBQUQsQ0FBUCxDQUFjSSxLQUFkLENBQW9CYSxjQUFjLENBQUNiLEtBQW5DLENBQTdCLEVBQXdFO0FBQ3BFLGNBQU0sSUFBSUMsS0FBSixDQUFXLFdBQVVMLElBQUssb0NBQW1DaUIsY0FBYyxDQUFDYixLQUFNLEVBQWxGLENBQU47QUFDSDs7QUFFRFksTUFBQUEsTUFBTSxDQUFDaEIsSUFBRCxDQUFOLEdBQWVSLE9BQU8sQ0FBQ1EsSUFBRCxDQUF0QjtBQUNIO0FBQ0o7O0FBRUQsU0FBT2dCLE1BQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IERFRkFVTFRfSE9TVE5BTUUgPSAnMTI3LjAuMC4xJ1xuY29uc3QgREVGQVVMVF9QT1JUID0gNDQ0NFxuY29uc3QgREVGQVVMVF9QUk9UT0NPTCA9ICdodHRwJ1xuXG5jb25zdCBSRUdJT05fTUFQUElORyA9IHtcbiAgICAndXMnOiAnJywgLy8gZGVmYXVsdCBlbmRwb2ludFxuICAgICdldSc6ICdldS1jZW50cmFsLTEuJ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2F1Y2VFbmRwb2ludCAocmVnaW9uKSB7XG4gICAgY29uc3QgZGMgPSByZWdpb24gP1xuICAgICAgICB0eXBlb2YgUkVHSU9OX01BUFBJTkdbcmVnaW9uXSAhPT0gJ3VuZGVmaW5lZCcgP1xuICAgICAgICAgICAgUkVHSU9OX01BUFBJTkdbcmVnaW9uXSA6IChyZWdpb24gKyAnLicpXG4gICAgICAgIDogJydcbiAgICByZXR1cm4gYCR7ZGN9c2F1Y2VsYWJzLmNvbWBcbn1cblxuLyoqXG4gKiBoZWxwZXIgdG8gZGV0ZWN0IHRoZSBTZWxlbml1bSBiYWNrZW5kIGFjY29yZGluZyB0byBnaXZlbiBjYXBhYmlsaXRpZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRldGVjdEJhY2tlbmQgKG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHsgcG9ydCwgaG9zdG5hbWUsIHVzZXIsIGtleSwgcHJvdG9jb2wsIHJlZ2lvbiB9ID0gb3B0aW9uc1xuXG4gICAgLyoqXG4gICAgICogYnJvd3NlcnN0YWNrXG4gICAgICogZS5nLiB6SGN2OXNaMzlpcDhaUHN4QlZKMlxuICAgICAqL1xuICAgIGlmICh0eXBlb2YgdXNlciA9PT0gJ3N0cmluZycgJiYga2V5Lmxlbmd0aCA9PT0gMjApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGhvc3RuYW1lOiAnaHViLmJyb3dzZXJzdGFjay5jb20nLFxuICAgICAgICAgICAgcG9ydDogODBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHRlc3Rpbmdib3RcbiAgICAgKiBlLmcuIGVjMzM3ZDdiNjc3NzIwYTRkZGU3YmQ3MmJlMGJmYzY3XG4gICAgICovXG4gICAgaWYgKHR5cGVvZiB1c2VyID09PSAnc3RyaW5nJyAmJiBrZXkubGVuZ3RoID09PSAzMikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaG9zdG5hbWU6ICdodWIudGVzdGluZ2JvdC5jb20nLFxuICAgICAgICAgICAgcG9ydDogODBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNhdWNlIExhYnNcbiAgICAgKiBlLmcuIDUwYWExNTJjLTE5MzItQjJmMC05NzA3LTE4ejQ2cTJuMW1iMFxuICAgICAqL1xuICAgIGlmICh0eXBlb2YgdXNlciA9PT0gJ3N0cmluZycgJiYga2V5Lmxlbmd0aCA9PT0gMzYpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHByb3RvY29sOiBwcm90b2NvbCB8fCAnaHR0cHMnLFxuICAgICAgICAgICAgaG9zdG5hbWU6IGhvc3RuYW1lIHx8IGBvbmRlbWFuZC4ke2dldFNhdWNlRW5kcG9pbnQocmVnaW9uKX1gLFxuICAgICAgICAgICAgcG9ydDogcG9ydCB8fCA0NDNcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIG5vIGNsb3VkIHByb3ZpZGVyIGRldGVjdGVkLCBmYWxsYmFjayB0byBsb2NhbCBicm93c2VyIGRyaXZlclxuICAgICAqL1xuICAgIHJldHVybiB7XG4gICAgICAgIGhvc3RuYW1lOiBob3N0bmFtZSB8fCBERUZBVUxUX0hPU1ROQU1FLFxuICAgICAgICBwb3J0OiBwb3J0IHx8IERFRkFVTFRfUE9SVCxcbiAgICAgICAgcHJvdG9jb2w6IHByb3RvY29sIHx8IERFRkFVTFRfUFJPVE9DT0xcbiAgICB9XG59XG5cbi8qKlxuICogQWxsb3dzIHRvIHNhZmVseSByZXF1aXJlIGEgcGFja2FnZSwgaXQgb25seSB0aHJvd3MgaWYgdGhlIHBhY2thZ2Ugd2FzIGZvdW5kXG4gKiBidXQgZmFpbGVkIHRvIGxvYWQgZHVlIHRvIHN5bnRheCBlcnJvcnNcbiAqIEBwYXJhbSAge3N0cmluZ30gbmFtZSAgb2YgcGFja2FnZVxuICogQHJldHVybiB7b2JqZWN0fSAgICAgICBwYWNrYWdlIGNvbnRlbnRcbiAqL1xuZnVuY3Rpb24gc2FmZVJlcXVpcmUgKG5hbWUpIHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gcmVxdWlyZShuYW1lKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKCFlLm1lc3NhZ2UubWF0Y2goYENhbm5vdCBmaW5kIG1vZHVsZSAnJHtuYW1lfSdgKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBpbml0aWFsaXNlIFwiJHtuYW1lfVwiLlxcbiR7ZS5zdGFja31gKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG59XG5cbi8qKlxuICogaW5pdGlhbGlzZSBXZWJkcml2ZXJJTyBjb21wbGlhbnQgcGx1Z2lucyBsaWtlIHJlcG9ydGVyIG9yIHNlcnZpY2VzIGluIHRoZSBmb2xsb3dpbmcgd2F5OlxuICogMS4gaWYgcGFja2FnZSBuYW1lIGlzIHNjb3BlZCAoc3RhcnRzIHdpdGggXCJAXCIpLCByZXF1aXJlIHNjb3BlZCBwYWNrYWdlIG5hbWVcbiAqIDIuIG90aGVyd2lzZSB0cnkgdG8gcmVxdWlyZSBcIkB3ZGlvLzxuYW1lPi08dHlwZT5cIlxuICogMy4gb3RoZXJ3aXNlIHRyeSB0byByZXF1aXJlIFwid2Rpby08bmFtZT4tPHR5cGU+XCJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpc2VQbHVnaW4gKG5hbWUsIHR5cGUsIHRhcmdldCA9ICdkZWZhdWx0Jykge1xuICAgIC8qKlxuICAgICAqIGRpcmVjdGx5IGltcG9ydCBwYWNrYWdlcyB0aGF0IGFyZSBzY29wZWRcbiAgICAgKi9cbiAgICBpZiAobmFtZVswXSA9PT0gJ0AnKSB7XG4gICAgICAgIGNvbnN0IHNlcnZpY2UgPSBzYWZlUmVxdWlyZShuYW1lKVxuICAgICAgICByZXR1cm4gc2VydmljZVt0YXJnZXRdXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY2hlY2sgZm9yIHNjb3BlZCB2ZXJzaW9uIG9mIHBsdWdpbiBmaXJzdCAoZS5nLiBAd2Rpby9zYXVjZS1zZXJ2aWNlKVxuICAgICAqL1xuICAgIGNvbnN0IHNjb3BlZFBsdWdpbiA9IHNhZmVSZXF1aXJlKGBAd2Rpby8ke25hbWUudG9Mb3dlckNhc2UoKX0tJHt0eXBlfWApXG4gICAgaWYgKHNjb3BlZFBsdWdpbikge1xuICAgICAgICByZXR1cm4gc2NvcGVkUGx1Z2luW3RhcmdldF1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBjaGVjayBmb3Igb2xkIHR5cGUgb2ZcbiAgICAgKi9cbiAgICBjb25zdCBwbHVnaW4gPSBzYWZlUmVxdWlyZShgd2Rpby0ke25hbWUudG9Mb3dlckNhc2UoKX0tJHt0eXBlfWApXG4gICAgaWYgKHBsdWdpbikge1xuICAgICAgICByZXR1cm4gcGx1Z2luW3RhcmdldF1cbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDb3VsZG4ndCBmaW5kIHBsdWdpbiBcIiR7bmFtZX1cIiAke3R5cGV9LCBuZWl0aGVyIGFzIHdkaW8gc2NvcGVkIHBhY2thZ2UgYCtcbiAgICAgICAgYFwiQHdkaW8vJHtuYW1lLnRvTG93ZXJDYXNlKCl9LSR7dHlwZX1cIiBub3IgYXMgY29tbXVuaXR5IHBhY2thZ2UgYCArXG4gICAgICAgIGBcIndkaW8tJHtuYW1lLnRvTG93ZXJDYXNlKCl9LSR7dHlwZX1cIi4gUGxlYXNlIG1ha2Ugc3VyZSB5b3UgaGF2ZSBpdCBpbnN0YWxsZWQhYFxuICAgIClcbn1cblxuXG4vKipcbiAqIHZhbGlkYXRlcyBjb25maWd1cmF0aW9ucyBiYXNlZCBvbiBkZWZhdWx0IHZhbHVlc1xuICogQHBhcmFtICB7T2JqZWN0fSBkZWZhdWx0cyAgb2JqZWN0IGRlc2NyaWJpbmcgYWxsIGFsbG93ZWQgcHJvcGVydGllc1xuICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zICAgb3B0aW9uIHRvIGNoZWNrIGFnYWluc1xuICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgICAgdmFsaWRhdGVkIGNvbmZpZyBlbnJpY2hlZCB3aXRoIGRlZmF1bHQgdmFsdWVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZUNvbmZpZyAoZGVmYXVsdHMsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBwYXJhbXMgPSB7fVxuXG4gICAgZm9yIChjb25zdCBbbmFtZSwgZXhwZWN0ZWRPcHRpb25dIG9mIE9iamVjdC5lbnRyaWVzKGRlZmF1bHRzKSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogY2hlY2sgaWYgb3B0aW9ucyBpcyBnaXZlblxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zW25hbWVdID09PSAndW5kZWZpbmVkJyAmJiAhZXhwZWN0ZWRPcHRpb24uZGVmYXVsdCAmJiBleHBlY3RlZE9wdGlvbi5yZXF1aXJlZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXF1aXJlZCBvcHRpb24gXCIke25hbWV9XCIgaXMgbWlzc2luZ2ApXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnNbbmFtZV0gPT09ICd1bmRlZmluZWQnICYmIGV4cGVjdGVkT3B0aW9uLmRlZmF1bHQpIHtcbiAgICAgICAgICAgIHBhcmFtc1tuYW1lXSA9IGV4cGVjdGVkT3B0aW9uLmRlZmF1bHRcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uc1tuYW1lXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZXhwZWN0ZWRPcHRpb24udHlwZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9wdGlvbnNbbmFtZV0gIT09IGV4cGVjdGVkT3B0aW9uLnR5cGUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIG9wdGlvbiBcIiR7bmFtZX1cIiB0byBiZSB0eXBlIG9mICR7ZXhwZWN0ZWRPcHRpb24udHlwZX0gYnV0IHdhcyAke3R5cGVvZiBvcHRpb25zW25hbWVdfWApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgZXhwZWN0ZWRPcHRpb24udHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkT3B0aW9uLnR5cGUob3B0aW9uc1tuYW1lXSlcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVHlwZSBjaGVjayBmb3Igb3B0aW9uIFwiJHtuYW1lfVwiIGZhaWxlZDogJHtlLm1lc3NhZ2V9YClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChleHBlY3RlZE9wdGlvbi5tYXRjaCAmJiAhb3B0aW9uc1tuYW1lXS5tYXRjaChleHBlY3RlZE9wdGlvbi5tYXRjaCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiBcIiR7bmFtZX1cIiBkb2Vzbid0IG1hdGNoIGV4cGVjdGVkIHZhbHVlczogJHtleHBlY3RlZE9wdGlvbi5tYXRjaH1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBwYXJhbXNbbmFtZV0gPSBvcHRpb25zW25hbWVdXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcGFyYW1zXG59XG4iXX0=