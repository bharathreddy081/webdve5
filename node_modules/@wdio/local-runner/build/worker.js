"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _child_process = _interopRequireDefault(require("child_process"));

var _events = _interopRequireDefault(require("events"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _transformStream = _interopRequireDefault(require("./transformStream"));

var _repl = _interopRequireDefault(require("./repl"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const log = (0, _logger.default)('wdio-local-runner');
/**
 * WorkerInstance
 * responsible for spawning a sub process to run the framework in and handle its
 * session lifetime.
 */

class WorkerInstance extends _events.default {
  /**
   * assigns paramters to scope of instance
   * @param  {object}   config      parsed configuration object
   * @param  {string}   cid         capability id (e.g. 0-1)
   * @param  {string}   configFile  path to config file (for sub process to parse)
   * @param  {object}   caps        capability object
   * @param  {string[]} specs       list of paths to test files to run in this worker
   * @param  {object}   server      configuration details about automation backend this session is using
   * @param  {object}   execArgv    execution arguments for the test run
   */
  constructor(config, {
    cid,
    configFile,
    caps,
    specs,
    server,
    execArgv
  }) {
    super();
    this.cid = cid;
    this.config = config;
    this.configFile = configFile;
    this.caps = caps;
    this.specs = specs;
    this.server = server;
    this.execArgv = execArgv;
    this.isBusy = false;
  }
  /**
   * spawns process to kick of wdio-runner
   */


  startProcess() {
    const {
      cid,
      execArgv
    } = this;
    const argv = process.argv.slice(2);
    const runnerEnv = Object.assign(process.env, this.config.runnerEnv, {
      WDIO_LOG_LEVEL: this.config.logLevel,
      WDIO_WORKER: true
    });

    if (this.config.logDir) {
      runnerEnv.WDIO_LOG_PATH = _path.default.join(this.config.logDir, `wdio-${cid}.log`);
    }

    log.info(`Start worker ${cid} with arg: ${argv}`);

    const childProcess = this.childProcess = _child_process.default.fork(_path.default.join(__dirname, 'run.js'), argv, {
      cwd: process.cwd(),
      env: runnerEnv,
      execArgv,
      silent: true
    });

    childProcess.on('message', this._handleMessage.bind(this));
    childProcess.on('error', this._handleError.bind(this));
    childProcess.on('exit', this._handleExit.bind(this));
    /* istanbul ignore if */

    if (!process.env.JEST_WORKER_ID) {
      childProcess.stdout.pipe(new _transformStream.default(cid)).pipe(process.stdout);
      childProcess.stderr.pipe(new _transformStream.default(cid)).pipe(process.stderr);
      process.stdin.pipe(childProcess.stdin);
    }

    return childProcess;
  }

  _handleMessage(payload) {
    const {
      cid,
      childProcess
    } = this;
    /**
     * resolve pending commands
     */

    if (payload.name === 'finisedCommand') {
      this.isBusy = false;
    }
    /**
     * store sessionId and connection data to worker instance
     */


    if (payload.name === 'sessionStarted') {
      this.sessionId = payload.content.sessionId;
      delete payload.content.sessionId;
      Object.assign(this.server, payload.content);
    }

    this.emit('message', Object.assign(payload, {
      cid
    }));
    /**
     * handle debug command called within worker process
     */

    if (payload.origin === 'debugger' && payload.name === 'start') {
      this.repl = new _repl.default(childProcess, _objectSpread({
        prompt: `[${cid}] \u203A `
      }, payload.params));
      this.repl.start().then(() => {
        const ev = {
          origin: 'debugger',
          name: 'stop'
        };
        childProcess.send(ev);
        this.emit('message', ev);
      });
    }
    /**
     * handle debugger results
     */


    if (this.repl && payload.origin === 'debugger' && payload.name === 'result') {
      this.repl.onResult(payload.params);
    }
  }

  _handleError(payload) {
    const {
      cid
    } = this;
    this.emit('error', Object.assign(payload, {
      cid
    }));
  }

  _handleExit(exitCode) {
    const {
      cid,
      childProcess
    } = this;
    /**
     * delete process of worker
     */

    delete this.childProcess;
    this.isBusy = false;
    log.debug(`Runner ${cid} finished with exit code ${exitCode}`);
    this.emit('exit', {
      cid,
      exitCode
    });
    childProcess.kill('SIGTERM');
  }
  /**
   * sends message to sub process to execute functions in wdio-runner
   * @param  {string} command  method to run in wdio-runner
   * @param  {object} argv     arguments for functions to call
   * @return null
   */


  postMessage(command, argv) {
    const {
      cid,
      configFile,
      caps,
      specs,
      server,
      isBusy
    } = this;

    if (isBusy && command !== 'endSession') {
      return log.info(`worker with cid ${cid} already busy and can't take new commands`);
    }
    /**
     * start up process if worker hasn't done yet or if child process
     * closes after running its job
     */


    if (!this.childProcess) {
      this.childProcess = this.startProcess();
    }

    this.childProcess.send({
      cid,
      command,
      configFile,
      argv,
      caps,
      specs,
      server
    });
    this.isBusy = true;
  }

}

exports.default = WorkerInstance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93b3JrZXIuanMiXSwibmFtZXMiOlsibG9nIiwiV29ya2VySW5zdGFuY2UiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImNpZCIsImNvbmZpZ0ZpbGUiLCJjYXBzIiwic3BlY3MiLCJzZXJ2ZXIiLCJleGVjQXJndiIsImlzQnVzeSIsInN0YXJ0UHJvY2VzcyIsImFyZ3YiLCJwcm9jZXNzIiwic2xpY2UiLCJydW5uZXJFbnYiLCJPYmplY3QiLCJhc3NpZ24iLCJlbnYiLCJXRElPX0xPR19MRVZFTCIsImxvZ0xldmVsIiwiV0RJT19XT1JLRVIiLCJsb2dEaXIiLCJXRElPX0xPR19QQVRIIiwicGF0aCIsImpvaW4iLCJpbmZvIiwiY2hpbGRQcm9jZXNzIiwiY2hpbGQiLCJmb3JrIiwiX19kaXJuYW1lIiwiY3dkIiwic2lsZW50Iiwib24iLCJfaGFuZGxlTWVzc2FnZSIsIl9oYW5kbGVFcnJvciIsIl9oYW5kbGVFeGl0IiwiSkVTVF9XT1JLRVJfSUQiLCJzdGRvdXQiLCJwaXBlIiwiUnVubmVyVHJhbnNmb3JtU3RyZWFtIiwic3RkZXJyIiwic3RkaW4iLCJwYXlsb2FkIiwibmFtZSIsInNlc3Npb25JZCIsImNvbnRlbnQiLCJlbWl0Iiwib3JpZ2luIiwicmVwbCIsIldESU9SZXBsIiwicHJvbXB0IiwicGFyYW1zIiwic3RhcnQiLCJ0aGVuIiwiZXYiLCJzZW5kIiwib25SZXN1bHQiLCJleGl0Q29kZSIsImRlYnVnIiwia2lsbCIsInBvc3RNZXNzYWdlIiwiY29tbWFuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7Ozs7Ozs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHLHFCQUFPLG1CQUFQLENBQVo7QUFFQTs7Ozs7O0FBS2UsTUFBTUMsY0FBTixTQUE2QkMsZUFBN0IsQ0FBMEM7QUFDckQ7Ozs7Ozs7Ozs7QUFVQUMsRUFBQUEsV0FBVyxDQUFFQyxNQUFGLEVBQVU7QUFB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QUFPLEtBQUssWUFBMUIsRUFBd0M7QUFDcEMsYUFBTy9ELEdBQUcsQ0FBQzJCLElBQUosQ0FBVSxtQkFBa0J0QixHQUFJLDJDQUFoQyxDQUFQO0FBQ0g7QUFFRDs7Ozs7O0FBSUEsUUFBSSxDQUFDLEtBQUt1QixZQUFWLEVBQXdCO0FBQ3BCLFdBQUtBLFlBQUwsR0FBb0IsS0FBS2hCLFlBQUwsRUFBcEI7QUFDSDs7QUFFRCxTQUFLZ0IsWUFBTCxDQUFrQjZCLElBQWxCLENBQXVCO0FBQUVwRCxNQUFBQSxHQUFGO0FBQU8wRCxNQUFBQSxPQUFQO0FBQWdCekQsTUFBQUEsVUFBaEI7QUFBNEJPLE1BQUFBLElBQTVCO0FBQWtDTixNQUFBQSxJQUFsQztBQUF3Q0MsTUFBQUEsS0FBeEM7QUFBK0NDLE1BQUFBO0FBQS9DLEtBQXZCO0FBQ0EsU0FBS0UsTUFBTCxHQUFjLElBQWQ7QUFDSDs7QUF0Sm9EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBjaGlsZCBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnXG5cbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuXG5pbXBvcnQgUnVubmVyVHJhbnNmb3JtU3RyZWFtIGZyb20gJy4vdHJhbnNmb3JtU3RyZWFtJ1xuaW1wb3J0IFdESU9SZXBsIGZyb20gJy4vcmVwbCdcblxuY29uc3QgbG9nID0gbG9nZ2VyKCd3ZGlvLWxvY2FsLXJ1bm5lcicpXG5cbi8qKlxuICogV29ya2VySW5zdGFuY2VcbiAqIHJlc3BvbnNpYmxlIGZvciBzcGF3bmluZyBhIHN1YiBwcm9jZXNzIHRvIHJ1biB0aGUgZnJhbWV3b3JrIGluIGFuZCBoYW5kbGUgaXRzXG4gKiBzZXNzaW9uIGxpZmV0aW1lLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXb3JrZXJJbnN0YW5jZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgLyoqXG4gICAgICogYXNzaWducyBwYXJhbXRlcnMgdG8gc2NvcGUgb2YgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gIHtvYmplY3R9ICAgY29uZmlnICAgICAgcGFyc2VkIGNvbmZpZ3VyYXRpb24gb2JqZWN0XG4gICAgICogQHBhcmFtICB7c3RyaW5nfSAgIGNpZCAgICAgICAgIGNhcGFiaWxpdHkgaWQgKGUuZy4gMC0xKVxuICAgICAqIEBwYXJhbSAge3N0cmluZ30gICBjb25maWdGaWxlICBwYXRoIHRvIGNvbmZpZyBmaWxlIChmb3Igc3ViIHByb2Nlc3MgdG8gcGFyc2UpXG4gICAgICogQHBhcmFtICB7b2JqZWN0fSAgIGNhcHMgICAgICAgIGNhcGFiaWxpdHkgb2JqZWN0XG4gICAgICogQHBhcmFtICB7c3RyaW5nW119IHNwZWNzICAgICAgIGxpc3Qgb2YgcGF0aHMgdG8gdGVzdCBmaWxlcyB0byBydW4gaW4gdGhpcyB3b3JrZXJcbiAgICAgKiBAcGFyYW0gIHtvYmplY3R9ICAgc2VydmVyICAgICAgY29uZmlndXJhdGlvbiBkZXRhaWxzIGFib3V0IGF1dG9tYXRpb24gYmFja2VuZCB0aGlzIHNlc3Npb24gaXMgdXNpbmdcbiAgICAgKiBAcGFyYW0gIHtvYmplY3R9ICAgZXhlY0FyZ3YgICAgZXhlY3V0aW9uIGFyZ3VtZW50cyBmb3IgdGhlIHRlc3QgcnVuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IgKGNvbmZpZywgeyBjaWQsIGNvbmZpZ0ZpbGUsIGNhcHMsIHNwZWNzLCBzZXJ2ZXIsIGV4ZWNBcmd2IH0pIHtcbiAgICAgICAgc3VwZXIoKVxuICAgICAgICB0aGlzLmNpZCA9IGNpZFxuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZ1xuICAgICAgICB0aGlzLmNvbmZpZ0ZpbGUgPSBjb25maWdGaWxlXG4gICAgICAgIHRoaXMuY2FwcyA9IGNhcHNcbiAgICAgICAgdGhpcy5zcGVjcyA9IHNwZWNzXG4gICAgICAgIHRoaXMuc2VydmVyID0gc2VydmVyXG4gICAgICAgIHRoaXMuZXhlY0FyZ3YgPSBleGVjQXJndlxuICAgICAgICB0aGlzLmlzQnVzeSA9IGZhbHNlXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogc3Bhd25zIHByb2Nlc3MgdG8ga2ljayBvZiB3ZGlvLXJ1bm5lclxuICAgICAqL1xuICAgIHN0YXJ0UHJvY2VzcyAoKSB7XG4gICAgICAgIGNvbnN0IHsgY2lkLCBleGVjQXJndiB9ID0gdGhpc1xuICAgICAgICBjb25zdCBhcmd2ID0gcHJvY2Vzcy5hcmd2LnNsaWNlKDIpXG5cbiAgICAgICAgY29uc3QgcnVubmVyRW52ID0gT2JqZWN0LmFzc2lnbihwcm9jZXNzLmVudiwgdGhpcy5jb25maWcucnVubmVyRW52LCB7XG4gICAgICAgICAgICBXRElPX0xPR19MRVZFTDogdGhpcy5jb25maWcubG9nTGV2ZWwsXG4gICAgICAgICAgICBXRElPX1dPUktFUjogdHJ1ZVxuICAgICAgICB9KVxuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5sb2dEaXIpIHtcbiAgICAgICAgICAgIHJ1bm5lckVudi5XRElPX0xPR19QQVRIID0gcGF0aC5qb2luKHRoaXMuY29uZmlnLmxvZ0RpciwgYHdkaW8tJHtjaWR9LmxvZ2ApXG4gICAgICAgIH1cblxuICAgICAgICBsb2cuaW5mbyhgU3RhcnQgd29ya2VyICR7Y2lkfSB3aXRoIGFyZzogJHthcmd2fWApXG4gICAgICAgIGNvbnN0IGNoaWxkUHJvY2VzcyA9IHRoaXMuY2hpbGRQcm9jZXNzID0gY2hpbGQuZm9yayhwYXRoLmpvaW4oX19kaXJuYW1lLCAncnVuLmpzJyksIGFyZ3YsIHtcbiAgICAgICAgICAgIGN3ZDogcHJvY2Vzcy5jd2QoKSxcbiAgICAgICAgICAgIGVudjogcnVubmVyRW52LFxuICAgICAgICAgICAgZXhlY0FyZ3YsXG4gICAgICAgICAgICBzaWxlbnQ6IHRydWVcbiAgICAgICAgfSlcblxuICAgICAgICBjaGlsZFByb2Nlc3Mub24oJ21lc3NhZ2UnLCA6OnRoaXMuX2hhbmRsZU1lc3NhZ2UpXG4gICAgICAgIGNoaWxkUHJvY2Vzcy5vbignZXJyb3InLCA6OnRoaXMuX2hhbmRsZUVycm9yKVxuICAgICAgICBjaGlsZFByb2Nlc3Mub24oJ2V4aXQnLCA6OnRoaXMuX2hhbmRsZUV4aXQpXG5cbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovXG4gICAgICAgIGlmICghcHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQpIHtcbiAgICAgICAgICAgIGNoaWxkUHJvY2Vzcy5zdGRvdXQucGlwZShuZXcgUnVubmVyVHJhbnNmb3JtU3RyZWFtKGNpZCkpLnBpcGUocHJvY2Vzcy5zdGRvdXQpXG4gICAgICAgICAgICBjaGlsZFByb2Nlc3Muc3RkZXJyLnBpcGUobmV3IFJ1bm5lclRyYW5zZm9ybVN0cmVhbShjaWQpKS5waXBlKHByb2Nlc3Muc3RkZXJyKVxuICAgICAgICAgICAgcHJvY2Vzcy5zdGRpbi5waXBlKGNoaWxkUHJvY2Vzcy5zdGRpbilcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjaGlsZFByb2Nlc3NcbiAgICB9XG5cbiAgICBfaGFuZGxlTWVzc2FnZSAocGF5bG9hZCkge1xuICAgICAgICBjb25zdCB7IGNpZCwgY2hpbGRQcm9jZXNzIH0gPSB0aGlzXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlc29sdmUgcGVuZGluZyBjb21tYW5kc1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHBheWxvYWQubmFtZSA9PT0gJ2ZpbmlzZWRDb21tYW5kJykge1xuICAgICAgICAgICAgdGhpcy5pc0J1c3kgPSBmYWxzZVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHN0b3JlIHNlc3Npb25JZCBhbmQgY29ubmVjdGlvbiBkYXRhIHRvIHdvcmtlciBpbnN0YW5jZVxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHBheWxvYWQubmFtZSA9PT0gJ3Nlc3Npb25TdGFydGVkJykge1xuICAgICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSBwYXlsb2FkLmNvbnRlbnQuc2Vzc2lvbklkXG4gICAgICAgICAgICBkZWxldGUgcGF5bG9hZC5jb250ZW50LnNlc3Npb25JZFxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnNlcnZlciwgcGF5bG9hZC5jb250ZW50KVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5lbWl0KCdtZXNzYWdlJywgT2JqZWN0LmFzc2lnbihwYXlsb2FkLCB7IGNpZCB9KSlcblxuICAgICAgICAvKipcbiAgICAgICAgICogaGFuZGxlIGRlYnVnIGNvbW1hbmQgY2FsbGVkIHdpdGhpbiB3b3JrZXIgcHJvY2Vzc1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHBheWxvYWQub3JpZ2luID09PSAnZGVidWdnZXInICYmIHBheWxvYWQubmFtZSA9PT0gJ3N0YXJ0Jykge1xuICAgICAgICAgICAgdGhpcy5yZXBsID0gbmV3IFdESU9SZXBsKFxuICAgICAgICAgICAgICAgIGNoaWxkUHJvY2VzcyxcbiAgICAgICAgICAgICAgICB7IHByb21wdDogYFske2NpZH1dIFxcdTIwM0EgYCwgLi4ucGF5bG9hZC5wYXJhbXMgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgdGhpcy5yZXBsLnN0YXJ0KCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXYgPSB7XG4gICAgICAgICAgICAgICAgICAgIG9yaWdpbjogJ2RlYnVnZ2VyJyxcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3N0b3AnXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNoaWxkUHJvY2Vzcy5zZW5kKGV2KVxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnbWVzc2FnZScsIGV2KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBoYW5kbGUgZGVidWdnZXIgcmVzdWx0c1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMucmVwbCAmJiBwYXlsb2FkLm9yaWdpbiA9PT0gJ2RlYnVnZ2VyJyAmJiBwYXlsb2FkLm5hbWUgPT09ICdyZXN1bHQnKSB7XG4gICAgICAgICAgICB0aGlzLnJlcGwub25SZXN1bHQocGF5bG9hZC5wYXJhbXMpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfaGFuZGxlRXJyb3IgKHBheWxvYWQpIHtcbiAgICAgICAgY29uc3QgeyBjaWQgfSA9IHRoaXNcbiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIE9iamVjdC5hc3NpZ24ocGF5bG9hZCwgeyBjaWQgfSkpXG4gICAgfVxuXG4gICAgX2hhbmRsZUV4aXQgKGV4aXRDb2RlKSB7XG4gICAgICAgIGNvbnN0IHsgY2lkLCBjaGlsZFByb2Nlc3MgfSA9IHRoaXNcblxuICAgICAgICAvKipcbiAgICAgICAgICogZGVsZXRlIHByb2Nlc3Mgb2Ygd29ya2VyXG4gICAgICAgICAqL1xuICAgICAgICBkZWxldGUgdGhpcy5jaGlsZFByb2Nlc3NcbiAgICAgICAgdGhpcy5pc0J1c3kgPSBmYWxzZVxuXG4gICAgICAgIGxvZy5kZWJ1ZyhgUnVubmVyICR7Y2lkfSBmaW5pc2hlZCB3aXRoIGV4aXQgY29kZSAke2V4aXRDb2RlfWApXG4gICAgICAgIHRoaXMuZW1pdCgnZXhpdCcsIHsgY2lkLCBleGl0Q29kZSB9KVxuICAgICAgICBjaGlsZFByb2Nlc3Mua2lsbCgnU0lHVEVSTScpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogc2VuZHMgbWVzc2FnZSB0byBzdWIgcHJvY2VzcyB0byBleGVjdXRlIGZ1bmN0aW9ucyBpbiB3ZGlvLXJ1bm5lclxuICAgICAqIEBwYXJhbSAge3N0cmluZ30gY29tbWFuZCAgbWV0aG9kIHRvIHJ1biBpbiB3ZGlvLXJ1bm5lclxuICAgICAqIEBwYXJhbSAge29iamVjdH0gYXJndiAgICAgYXJndW1lbnRzIGZvciBmdW5jdGlvbnMgdG8gY2FsbFxuICAgICAqIEByZXR1cm4gbnVsbFxuICAgICAqL1xuICAgIHBvc3RNZXNzYWdlIChjb21tYW5kLCBhcmd2KSB7XG4gICAgICAgIGNvbnN0IHsgY2lkLCBjb25maWdGaWxlLCBjYXBzLCBzcGVjcywgc2VydmVyLCBpc0J1c3kgfSA9IHRoaXNcblxuICAgICAgICBpZiAoaXNCdXN5ICYmIGNvbW1hbmQgIT09ICdlbmRTZXNzaW9uJykge1xuICAgICAgICAgICAgcmV0dXJuIGxvZy5pbmZvKGB3b3JrZXIgd2l0aCBjaWQgJHtjaWR9IGFscmVhZHkgYnVzeSBhbmQgY2FuJ3QgdGFrZSBuZXcgY29tbWFuZHNgKVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHN0YXJ0IHVwIHByb2Nlc3MgaWYgd29ya2VyIGhhc24ndCBkb25lIHlldCBvciBpZiBjaGlsZCBwcm9jZXNzXG4gICAgICAgICAqIGNsb3NlcyBhZnRlciBydW5uaW5nIGl0cyBqb2JcbiAgICAgICAgICovXG4gICAgICAgIGlmICghdGhpcy5jaGlsZFByb2Nlc3MpIHtcbiAgICAgICAgICAgIHRoaXMuY2hpbGRQcm9jZXNzID0gdGhpcy5zdGFydFByb2Nlc3MoKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jaGlsZFByb2Nlc3Muc2VuZCh7IGNpZCwgY29tbWFuZCwgY29uZmlnRmlsZSwgYXJndiwgY2Fwcywgc3BlY3MsIHNlcnZlciB9KVxuICAgICAgICB0aGlzLmlzQnVzeSA9IHRydWVcbiAgICB9XG59XG4iXX0=