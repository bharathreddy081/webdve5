"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _util = _interopRequireDefault(require("util"));

var _events = _interopRequireDefault(require("events"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _config = require("@wdio/config");

var _reporter = _interopRequireDefault(require("./reporter"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('wdio-runner');

class Runner extends _events.default {
  constructor() {
    super();
    this.configParser = new _config.ConfigParser();
    this.sigintWasCalled = false;
  }
  /**
   * run test suite
   * @param  {String}    cid            worker id (e.g. `0-0`)
   * @param  {Object}    argv           cli arguments passed into wdio command
   * @param  {String[]}  specs          list of spec files to run
   * @param  {Object}    caps           capabilties to run session with
   * @param  {String}    configFile     path to config file to get config from
   * @param  {Object}    server         modified WebDriver target
   * @return {Promise}                  resolves in number of failures for testrun
   */


  async run({
    cid,
    argv,
    specs,
    caps,
    configFile,
    server
  }) {
    var _context;

    this.cid = cid;
    this.specs = specs;
    this.caps = caps;
    /**
     * add config file
     */

    this.configParser.addConfigFile(configFile);
    /**
     * merge cli arguments into config
     */

    this.configParser.merge(argv);
    /**
     * merge host/port changes by service launcher into config
     */

    this.configParser.merge(server);
    this.config = this.configParser.getConfig();
    (0, _utils.initialiseServices)(this.config, caps).map((_context = this.configParser).addService.bind(_context));
    this.reporter = new _reporter.default(this.config, this.cid);
    this.inWatchMode = Boolean(this.config.watch);
    await (0, _utils.runHook)('beforeSession', this.config, this.caps, this.specs);
    const browser = await this._initSession(this.config, this.caps);
    const isMultiremote = Boolean(browser.isMultiremote);
    /**
     * return if session initialisation failed
     */

    if (!browser) {
      return this._shutdown(1);
    }
    /**
     * kill session of SIGINT signal showed up while trying to
     * get a session ID
     */


    if (this.sigintWasCalled) {
      log.info('SIGINT signal detected while starting session, shutting down...');
      await this.endSession();
      return this._shutdown(0);
    }
    /**
     * initialise framework
     */


    this.framework = (0, _config.initialisePlugin)(this.config.framework, 'framework');
    /**
     * initialisation successful, send start message
     */

    this.reporter.emit('runner:start', {
      cid,
      specs,
      config: this.config,
      isMultiremote,
      sessionId: browser.sessionId,
      capabilities: isMultiremote ? browser.instances.reduce((caps, browserName) => {
        caps[browserName] = browser[browserName].capabilities;
        return caps;
      }, {}) : browser.options.capabilities
    });
    /**
     * report sessionId and target connection information to worker
     */

    const {
      protocol,
      hostname,
      port,
      path,
      queryParams
    } = browser.options;
    const {
      isW3C,
      sessionId
    } = browser;
    process.send({
      origin: 'worker',
      name: 'sessionStarted',
      content: {
        sessionId,
        isW3C,
        protocol,
        hostname,
        port,
        path,
        queryParams
      }
    });
    /**
     * kick off tests in framework
     */

    let failures = 0;

    try {
      failures = failures = await this.framework.run(cid, this.config, specs, caps, this.reporter);
      await this._fetchDriverLogs(this.config);
    } catch (e) {
      log.error(e);
      this.emit('error', e);
      failures = 1;
    }
    /**
     * in watch mode we don't close the session and open a blank page instead
     */


    if (!argv.watch) {
      await this.endSession();
    } else {
      await global.browser.url('about:blank');
    }

    this.reporter.emit('runner:end', {
      failures,
      cid: this.cid
    });
    await this._shutdown(failures);
    return failures;
  }
  /**
   * init WebDriver session
   * @param  {object}  config        configuration of sessions
   * @param  {Object}  caps          desired cabilities of session
   * @return {Promise}               resolves with browser object or null if session couldn't get established
   */


  async _initSession(config, caps) {
    let browser = null;

    try {
      browser = global.browser = global.driver = await (0, _utils.initialiseInstance)(config, caps, this.isMultiremote);
    } catch (e) {
      log.error(e);
      this.emit('error', e);
      return browser;
    }

    browser.config = config;
    /**
     * register global helper method to fetch elements
     */

    global.$ = selector => browser.$(selector);

    global.$$ = selector => browser.$$(selector);
    /**
     * register command event
     */


    browser.on('command', command => this.reporter.emit('client:beforeCommand', Object.assign(command, {
      sessionId: browser.sessionId
    })));
    /**
     * register result event
     */

    browser.on('result', result => this.reporter.emit('client:afterCommand', Object.assign(result, {
      sessionId: browser.sessionId
    })));
    return browser;
  }
  /**
   * fetch logs provided by browser driver
   */


  async _fetchDriverLogs(config) {
    /**
     * only fetch logs if
     */
    if (
    /**
     * a log directory is given in config
     */
    !config.logDir ||
    /**
     * the session wasn't killed during start up phase
     */
    !global.browser.sessionId ||
    /**
     * driver supports it
     */
    typeof global.browser.getLogs === 'undefined') {
      return;
    }

    const logTypes = await global.browser.getLogTypes();
    log.debug(`Fetching logs for ${logTypes.join(', ')}`);
    return Promise.all(logTypes.map(async logType => {
      const logs = await global.browser.getLogs(logType);
      /**
       * don't write to file if no logs were captured
       */

      if (logs.length === 0) {
        return;
      }

      const stringLogs = logs.map(log => JSON.stringify(log)).join('\n');
      return _util.default.promisify(_fs.default.writeFile)(_path.default.join(config.logDir, `wdio-${this.cid}-${logType}.log`), stringLogs, 'utf-8');
    }));
  }
  /**
   * kill worker session
   */


  async _shutdown(failures) {
    await this.reporter.waitForSync();
    this.emit('exit', failures === 0 ? 0 : 1);
  }
  /**
   * end WebDriver session, a config object can be applied if object has changed
   * within a hook by the user
   */


  async endSession(shutdown) {
    /**
     * don't do anything if test framework returns after SIGINT
     * if endSession is called without shutdown flag we expect a session id
     */
    if (!shutdown && (!global.browser || !global.browser.sessionId)) {
      return;
    }
    /**
     * if shutdown was called but no session was created, wait until it was
     * and try to end it
     */


    if (shutdown && (!global.browser || !global.browser.sessionId)) {
      await new Promise(resolve => setTimeout(resolve, 250));
      return this.endSession(shutdown);
    }

    await global.browser.deleteSession();
    delete global.browser.sessionId;
    await (0, _utils.runHook)('afterSession', global.browser.config, this.caps, this.specs);

    if (shutdown) {
      await this._shutdown();
    }
  }

}

exports.default = Runner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2ciLCJSdW5uZXIiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZ1BhcnNlciIsIkNvbmZpZ1BhcnNlciIsInNpZ2ludFdhc0NhbGxlZCIsInJ1biIsImNpZCIsImFyZ3YiLCJzcGVjcyIsImNhcHMiLCJjb25maWdGaWxlIiwic2VydmVyIiwiYWRkQ29uZmlnRmlsZSIsIm1lcmdlIiwiY29uZmlnIiwiZ2V0Q29uZmlnIiwibWFwIiwiYWRkU2VydmljZSIsInJlcG9ydGVyIiwiQmFzZVJlcG9ydGVyIiwiaW5XYXRjaE1vZGUiLCJCb29sZWFuIiwid2F0Y2giLCJicm93c2VyIiwiX2luaXRTZXNzaW9uIiwiaXNNdWx0aXJlbW90ZSIsIl9zaHV0ZG93biIsImluZm8iLCJlbmRTZXNzaW9uIiwiZnJhbWV3b3JrIiwiZW1pdCIsInNlc3Npb25JZCIsImNhcGFiaWxpdGllcyIsImluc3RhbmNlcyIsInJlZHVjZSIsImJyb3dzZXJOYW1lIiwib3B0aW9ucyIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJwb3J0IiwicGF0aCIsInF1ZXJ5UGFyYW1zIiwiaXNXM0MiLCJwcm9jZXNzIiwic2VuZCIsIm9yaWdpbiIsIm5hbWUiLCJjb250ZW50IiwiZmFpbHVyZXMiLCJfZmV0Y2hEcml2ZXJMb2dzIiwiZSIsImVycm9yIiwiZ2xvYmFsIiwidXJsIiwiZHJpdmVyIiwiJCIsInNlbGVjdG9yIiwiJCQiLCJvbiIsImNvbW1hbmQiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXN1bHQiLCJsb2dEaXIiLCJnZXRMb2dzIiwibG9nVHlwZXMiLCJnZXRMb2dUeXBlcyIsImRlYnVnIiwiam9pbiIsIlByb21pc2UiLCJhbGwiLCJsb2dUeXBlIiwibG9ncyIsImxlbmd0aCIsInN0cmluZ0xvZ3MiLCJKU09OIiwic3RyaW5naWZ5IiwidXRpbCIsInByb21pc2lmeSIsImZzIiwid3JpdGVGaWxlIiwid2FpdEZvclN5bmMiLCJz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TSxJQUFJc0MsT0FBSixDQUFhYyxPQUFELElBQWFDLFVBQVUsQ0FBQ0QsT0FBRCxFQUFVLEdBQVYsQ0FBbkMsQ0FBTjtBQUNBLGFBQU8sS0FBS3ZELFVBQUwsQ0FBZ0JzRCxRQUFoQixDQUFQO0FBQ0g7O0FBRUQsVUFBTTlCLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZThELGFBQWYsRUFBTjtBQUNBLFdBQU9qQyxNQUFNLENBQUM3QixPQUFQLENBQWVRLFNBQXRCO0FBRUEsVUFBTSxvQkFBUSxjQUFSLEVBQXdCcUIsTUFBTSxDQUFDN0IsT0FBUCxDQUFlVCxNQUF2QyxFQUErQyxLQUFLTCxJQUFwRCxFQUEwRCxLQUFLRCxLQUEvRCxDQUFOOztBQUVBLFFBQUkwRSxRQUFKLEVBQWM7QUFDVixZQUFNLEtBQUt4RCxTQUFMLEVBQU47QUFDSDtBQUNKOztBQS9QNEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCdcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJ1xuXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCB7IENvbmZpZ1BhcnNlciwgaW5pdGlhbGlzZVBsdWdpbiB9IGZyb20gJ0B3ZGlvL2NvbmZpZydcblxuaW1wb3J0IEJhc2VSZXBvcnRlciBmcm9tICcuL3JlcG9ydGVyJ1xuaW1wb3J0IHsgcnVuSG9vaywgaW5pdGlhbGlzZVNlcnZpY2VzLCBpbml0aWFsaXNlSW5zdGFuY2UgfSBmcm9tICcuL3V0aWxzJ1xuXG5jb25zdCBsb2cgPSBsb2dnZXIoJ3dkaW8tcnVubmVyJylcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUnVubmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHN1cGVyKClcbiAgICAgICAgdGhpcy5jb25maWdQYXJzZXIgPSBuZXcgQ29uZmlnUGFyc2VyKClcbiAgICAgICAgdGhpcy5zaWdpbnRXYXNDYWxsZWQgPSBmYWxzZVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHJ1biB0ZXN0IHN1aXRlXG4gICAgICogQHBhcmFtICB7U3RyaW5nfSAgICBjaWQgICAgICAgICAgICB3b3JrZXIgaWQgKGUuZy4gYDAtMGApXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSAgICBhcmd2ICAgICAgICAgICBjbGkgYXJndW1lbnRzIHBhc3NlZCBpbnRvIHdkaW8gY29tbWFuZFxuICAgICAqIEBwYXJhbSAge1N0cmluZ1tdfSAgc3BlY3MgICAgICAgICAgbGlzdCBvZiBzcGVjIGZpbGVzIHRvIHJ1blxuICAgICAqIEBwYXJhbSAge09iamVjdH0gICAgY2FwcyAgICAgICAgICAgY2FwYWJpbHRpZXMgdG8gcnVuIHNlc3Npb24gd2l0aFxuICAgICAqIEBwYXJhbSAge1N0cmluZ30gICAgY29uZmlnRmlsZSAgICAgcGF0aCB0byBjb25maWcgZmlsZSB0byBnZXQgY29uZmlnIGZyb21cbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9ICAgIHNlcnZlciAgICAgICAgIG1vZGlmaWVkIFdlYkRyaXZlciB0YXJnZXRcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAgICAgICAgICAgICAgICAgIHJlc29sdmVzIGluIG51bWJlciBvZiBmYWlsdXJlcyBmb3IgdGVzdHJ1blxuICAgICAqL1xuICAgIGFzeW5jIHJ1biAoeyBjaWQsIGFyZ3YsIHNwZWNzLCBjYXBzLCBjb25maWdGaWxlLCBzZXJ2ZXIgfSkge1xuICAgICAgICB0aGlzLmNpZCA9IGNpZFxuICAgICAgICB0aGlzLnNwZWNzID0gc3BlY3NcbiAgICAgICAgdGhpcy5jYXBzID0gY2Fwc1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBhZGQgY29uZmlnIGZpbGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnUGFyc2VyLmFkZENvbmZpZ0ZpbGUoY29uZmlnRmlsZSlcblxuICAgICAgICAvKipcbiAgICAgICAgICogbWVyZ2UgY2xpIGFyZ3VtZW50cyBpbnRvIGNvbmZpZ1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWdQYXJzZXIubWVyZ2UoYXJndilcblxuICAgICAgICAvKipcbiAgICAgICAgICogbWVyZ2UgaG9zdC9wb3J0IGNoYW5nZXMgYnkgc2VydmljZSBsYXVuY2hlciBpbnRvIGNvbmZpZ1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWdQYXJzZXIubWVyZ2Uoc2VydmVyKVxuXG4gICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5jb25maWdQYXJzZXIuZ2V0Q29uZmlnKClcbiAgICAgICAgaW5pdGlhbGlzZVNlcnZpY2VzKHRoaXMuY29uZmlnLCBjYXBzKS5tYXAoOjp0aGlzLmNvbmZpZ1BhcnNlci5hZGRTZXJ2aWNlKVxuXG4gICAgICAgIHRoaXMucmVwb3J0ZXIgPSBuZXcgQmFzZVJlcG9ydGVyKHRoaXMuY29uZmlnLCB0aGlzLmNpZClcbiAgICAgICAgdGhpcy5pbldhdGNoTW9kZSA9IEJvb2xlYW4odGhpcy5jb25maWcud2F0Y2gpXG5cbiAgICAgICAgYXdhaXQgcnVuSG9vaygnYmVmb3JlU2Vzc2lvbicsIHRoaXMuY29uZmlnLCB0aGlzLmNhcHMsIHRoaXMuc3BlY3MpXG4gICAgICAgIGNvbnN0IGJyb3dzZXIgPSBhd2FpdCB0aGlzLl9pbml0U2Vzc2lvbih0aGlzLmNvbmZpZywgdGhpcy5jYXBzKVxuICAgICAgICBjb25zdCBpc011bHRpcmVtb3RlID0gQm9vbGVhbihicm93c2VyLmlzTXVsdGlyZW1vdGUpXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJldHVybiBpZiBzZXNzaW9uIGluaXRpYWxpc2F0aW9uIGZhaWxlZFxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKCFicm93c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc2h1dGRvd24oMSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBraWxsIHNlc3Npb24gb2YgU0lHSU5UIHNpZ25hbCBzaG93ZWQgdXAgd2hpbGUgdHJ5aW5nIHRvXG4gICAgICAgICAqIGdldCBhIHNlc3Npb24gSURcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLnNpZ2ludFdhc0NhbGxlZCkge1xuICAgICAgICAgICAgbG9nLmluZm8oJ1NJR0lOVCBzaWduYWwgZGV0ZWN0ZWQgd2hpbGUgc3RhcnRpbmcgc2Vzc2lvbiwgc2h1dHRpbmcgZG93bi4uLicpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVuZFNlc3Npb24oKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NodXRkb3duKDApXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogaW5pdGlhbGlzZSBmcmFtZXdvcmtcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrID0gaW5pdGlhbGlzZVBsdWdpbih0aGlzLmNvbmZpZy5mcmFtZXdvcmssICdmcmFtZXdvcmsnKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBpbml0aWFsaXNhdGlvbiBzdWNjZXNzZnVsLCBzZW5kIHN0YXJ0IG1lc3NhZ2VcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucmVwb3J0ZXIuZW1pdCgncnVubmVyOnN0YXJ0Jywge1xuICAgICAgICAgICAgY2lkLFxuICAgICAgICAgICAgc3BlY3MsXG4gICAgICAgICAgICBjb25maWc6IHRoaXMuY29uZmlnLFxuICAgICAgICAgICAgaXNNdWx0aXJlbW90ZSxcbiAgICAgICAgICAgIHNlc3Npb25JZDogYnJvd3Nlci5zZXNzaW9uSWQsXG4gICAgICAgICAgICBjYXBhYmlsaXRpZXM6IGlzTXVsdGlyZW1vdGVcbiAgICAgICAgICAgICAgICA/IGJyb3dzZXIuaW5zdGFuY2VzLnJlZHVjZSgoY2FwcywgYnJvd3Nlck5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2Fwc1ticm93c2VyTmFtZV0gPSBicm93c2VyW2Jyb3dzZXJOYW1lXS5jYXBhYmlsaXRpZXNcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhcHNcbiAgICAgICAgICAgICAgICB9LCB7fSlcbiAgICAgICAgICAgICAgICA6IGJyb3dzZXIub3B0aW9ucy5jYXBhYmlsaXRpZXNcbiAgICAgICAgfSlcblxuICAgICAgICAvKipcbiAgICAgICAgICogcmVwb3J0IHNlc3Npb25JZCBhbmQgdGFyZ2V0IGNvbm5lY3Rpb24gaW5mb3JtYXRpb24gdG8gd29ya2VyXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCB7IHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCwgcGF0aCwgcXVlcnlQYXJhbXMgfSA9IGJyb3dzZXIub3B0aW9uc1xuICAgICAgICBjb25zdCB7IGlzVzNDLCBzZXNzaW9uSWQgfSA9IGJyb3dzZXJcbiAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICAgIG9yaWdpbjogJ3dvcmtlcicsXG4gICAgICAgICAgICBuYW1lOiAnc2Vzc2lvblN0YXJ0ZWQnLFxuICAgICAgICAgICAgY29udGVudDogeyBzZXNzaW9uSWQsIGlzVzNDLCBwcm90b2NvbCwgaG9zdG5hbWUsIHBvcnQsIHBhdGgsIHF1ZXJ5UGFyYW1zIH1cbiAgICAgICAgfSlcblxuICAgICAgICAvKipcbiAgICAgICAgICoga2ljayBvZmYgdGVzdHMgaW4gZnJhbWV3b3JrXG4gICAgICAgICAqL1xuICAgICAgICBsZXQgZmFpbHVyZXMgPSAwXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBmYWlsdXJlcyA9IGZhaWx1cmVzID0gYXdhaXQgdGhpcy5mcmFtZXdvcmsucnVuKGNpZCwgdGhpcy5jb25maWcsIHNwZWNzLCBjYXBzLCB0aGlzLnJlcG9ydGVyKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmV0Y2hEcml2ZXJMb2dzKHRoaXMuY29uZmlnKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoZSlcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgICAgICAgICAgZmFpbHVyZXMgPSAxXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogaW4gd2F0Y2ggbW9kZSB3ZSBkb24ndCBjbG9zZSB0aGUgc2Vzc2lvbiBhbmQgb3BlbiBhIGJsYW5rIHBhZ2UgaW5zdGVhZFxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKCFhcmd2LndhdGNoKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVuZFNlc3Npb24oKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXdhaXQgZ2xvYmFsLmJyb3dzZXIudXJsKCdhYm91dDpibGFuaycpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnJlcG9ydGVyLmVtaXQoJ3J1bm5lcjplbmQnLCB7XG4gICAgICAgICAgICBmYWlsdXJlcyxcbiAgICAgICAgICAgIGNpZDogdGhpcy5jaWRcbiAgICAgICAgfSlcblxuICAgICAgICBhd2FpdCB0aGlzLl9zaHV0ZG93bihmYWlsdXJlcylcbiAgICAgICAgcmV0dXJuIGZhaWx1cmVzXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaW5pdCBXZWJEcml2ZXIgc2Vzc2lvblxuICAgICAqIEBwYXJhbSAge29iamVjdH0gIGNvbmZpZyAgICAgICAgY29uZmlndXJhdGlvbiBvZiBzZXNzaW9uc1xuICAgICAqIEBwYXJhbSAge09iamVjdH0gIGNhcHMgICAgICAgICAgZGVzaXJlZCBjYWJpbGl0aWVzIG9mIHNlc3Npb25cbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAgICAgICAgICAgICAgIHJlc29sdmVzIHdpdGggYnJvd3NlciBvYmplY3Qgb3IgbnVsbCBpZiBzZXNzaW9uIGNvdWxkbid0IGdldCBlc3RhYmxpc2hlZFxuICAgICAqL1xuICAgIGFzeW5jIF9pbml0U2Vzc2lvbiAoY29uZmlnLCBjYXBzKSB7XG4gICAgICAgIGxldCBicm93c2VyID0gbnVsbFxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBicm93c2VyID0gZ2xvYmFsLmJyb3dzZXIgPSBnbG9iYWwuZHJpdmVyID0gYXdhaXQgaW5pdGlhbGlzZUluc3RhbmNlKGNvbmZpZywgY2FwcywgdGhpcy5pc011bHRpcmVtb3RlKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoZSlcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXJcbiAgICAgICAgfVxuXG4gICAgICAgIGJyb3dzZXIuY29uZmlnID0gY29uZmlnXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlZ2lzdGVyIGdsb2JhbCBoZWxwZXIgbWV0aG9kIHRvIGZldGNoIGVsZW1lbnRzXG4gICAgICAgICAqL1xuICAgICAgICBnbG9iYWwuJCA9IChzZWxlY3RvcikgPT4gYnJvd3Nlci4kKHNlbGVjdG9yKVxuICAgICAgICBnbG9iYWwuJCQgPSAoc2VsZWN0b3IpID0+IGJyb3dzZXIuJCQoc2VsZWN0b3IpXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlZ2lzdGVyIGNvbW1hbmQgZXZlbnRcbiAgICAgICAgICovXG4gICAgICAgIGJyb3dzZXIub24oJ2NvbW1hbmQnLCAoY29tbWFuZCkgPT4gdGhpcy5yZXBvcnRlci5lbWl0KFxuICAgICAgICAgICAgJ2NsaWVudDpiZWZvcmVDb21tYW5kJyxcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY29tbWFuZCwgeyBzZXNzaW9uSWQ6IGJyb3dzZXIuc2Vzc2lvbklkIH0pXG4gICAgICAgICkpXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlZ2lzdGVyIHJlc3VsdCBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgYnJvd3Nlci5vbigncmVzdWx0JywgKHJlc3VsdCkgPT4gdGhpcy5yZXBvcnRlci5lbWl0KFxuICAgICAgICAgICAgJ2NsaWVudDphZnRlckNvbW1hbmQnLFxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihyZXN1bHQsIHsgc2Vzc2lvbklkOiBicm93c2VyLnNlc3Npb25JZCB9KVxuICAgICAgICApKVxuXG4gICAgICAgIHJldHVybiBicm93c2VyXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogZmV0Y2ggbG9ncyBwcm92aWRlZCBieSBicm93c2VyIGRyaXZlclxuICAgICAqL1xuICAgIGFzeW5jIF9mZXRjaERyaXZlckxvZ3MgKGNvbmZpZykge1xuICAgICAgICAvKipcbiAgICAgICAgICogb25seSBmZXRjaCBsb2dzIGlmXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGEgbG9nIGRpcmVjdG9yeSBpcyBnaXZlbiBpbiBjb25maWdcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgIWNvbmZpZy5sb2dEaXIgfHxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogdGhlIHNlc3Npb24gd2Fzbid0IGtpbGxlZCBkdXJpbmcgc3RhcnQgdXAgcGhhc2VcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgIWdsb2JhbC5icm93c2VyLnNlc3Npb25JZCB8fFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBkcml2ZXIgc3VwcG9ydHMgaXRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdHlwZW9mIGdsb2JhbC5icm93c2VyLmdldExvZ3MgPT09ICd1bmRlZmluZWQnXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsb2dUeXBlcyA9IGF3YWl0IGdsb2JhbC5icm93c2VyLmdldExvZ1R5cGVzKClcbiAgICAgICAgbG9nLmRlYnVnKGBGZXRjaGluZyBsb2dzIGZvciAke2xvZ1R5cGVzLmpvaW4oJywgJyl9YClcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGxvZ1R5cGVzLm1hcChhc3luYyAobG9nVHlwZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbG9ncyA9IGF3YWl0IGdsb2JhbC5icm93c2VyLmdldExvZ3MobG9nVHlwZSlcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBkb24ndCB3cml0ZSB0byBmaWxlIGlmIG5vIGxvZ3Mgd2VyZSBjYXB0dXJlZFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAobG9ncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgc3RyaW5nTG9ncyA9IGxvZ3MubWFwKChsb2cpID0+IEpTT04uc3RyaW5naWZ5KGxvZykpLmpvaW4oJ1xcbicpXG4gICAgICAgICAgICByZXR1cm4gdXRpbC5wcm9taXNpZnkoZnMud3JpdGVGaWxlKShcbiAgICAgICAgICAgICAgICBwYXRoLmpvaW4oY29uZmlnLmxvZ0RpciwgYHdkaW8tJHt0aGlzLmNpZH0tJHtsb2dUeXBlfS5sb2dgKSxcbiAgICAgICAgICAgICAgICBzdHJpbmdMb2dzLFxuICAgICAgICAgICAgICAgICd1dGYtOCdcbiAgICAgICAgICAgIClcbiAgICAgICAgfSkpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICoga2lsbCB3b3JrZXIgc2Vzc2lvblxuICAgICAqL1xuICAgIGFzeW5jIF9zaHV0ZG93biAoZmFpbHVyZXMpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZXBvcnRlci53YWl0Rm9yU3luYygpXG4gICAgICAgIHRoaXMuZW1pdCgnZXhpdCcsIGZhaWx1cmVzID09PSAwID8gMCA6IDEpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogZW5kIFdlYkRyaXZlciBzZXNzaW9uLCBhIGNvbmZpZyBvYmplY3QgY2FuIGJlIGFwcGxpZWQgaWYgb2JqZWN0IGhhcyBjaGFuZ2VkXG4gICAgICogd2l0aGluIGEgaG9vayBieSB0aGUgdXNlclxuICAgICAqL1xuICAgIGFzeW5jIGVuZFNlc3Npb24gKHNodXRkb3duKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBkb24ndCBkbyBhbnl0aGluZyBpZiB0ZXN0IGZyYW1ld29yayByZXR1cm5zIGFmdGVyIFNJR0lOVFxuICAgICAgICAgKiBpZiBlbmRTZXNzaW9uIGlzIGNhbGxlZCB3aXRob3V0IHNodXRkb3duIGZsYWcgd2UgZXhwZWN0IGEgc2Vzc2lvbiBpZFxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKCFzaHV0ZG93biAmJiAoIWdsb2JhbC5icm93c2VyIHx8ICFnbG9iYWwuYnJvd3Nlci5zZXNzaW9uSWQpKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBpZiBzaHV0ZG93biB3YXMgY2FsbGVkIGJ1dCBubyBzZXNzaW9uIHdhcyBjcmVhdGVkLCB3YWl0IHVudGlsIGl0IHdhc1xuICAgICAgICAgKiBhbmQgdHJ5IHRvIGVuZCBpdFxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHNodXRkb3duICYmICghZ2xvYmFsLmJyb3dzZXIgfHwgIWdsb2JhbC5icm93c2VyLnNlc3Npb25JZCkpIHtcbiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDI1MCkpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5lbmRTZXNzaW9uKHNodXRkb3duKVxuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgZ2xvYmFsLmJyb3dzZXIuZGVsZXRlU2Vzc2lvbigpXG4gICAgICAgIGRlbGV0ZSBnbG9iYWwuYnJvd3Nlci5zZXNzaW9uSWRcblxuICAgICAgICBhd2FpdCBydW5Ib29rKCdhZnRlclNlc3Npb24nLCBnbG9iYWwuYnJvd3Nlci5jb25maWcsIHRoaXMuY2FwcywgdGhpcy5zcGVjcylcblxuICAgICAgICBpZiAoc2h1dGRvd24pIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NodXRkb3duKClcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==