"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _config = require("@wdio/config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('wdio-runner');

const NOOP = () => {};

const DEFAULT_SYNC_TIMEOUT = 5000; // 5s

const DEFAULT_SYNC_INTERVAL = 100; // 100ms

/**
 * BaseReporter
 * responsible for initialising reporters for every testrun and propagating events
 * to all these reporters
 */

class BaseReporter {
  constructor(config, cid) {
    this.config = config;
    this.cid = cid;
    this.reporters = config.reporters.map(this.initReporter.bind(this));
    /**
     * these configurations are not publicly documented as there should be no desire for it
     */

    this.reporterSyncInterval = this.config.reporterSyncInterval || DEFAULT_SYNC_INTERVAL;
    this.reporterSyncTimeout = this.config.reporterSyncTimeout || DEFAULT_SYNC_TIMEOUT;
  }
  /**
   * emit events to all registered reporter and wdio launcer
   *
   * @param  {String} e       event name
   * @param  {object} payload event payload
   */


  emit(e, payload) {
    payload.cid = this.cid;
    this.reporters.forEach(reporter => reporter.emit(e, payload));
  }
  /**
   * returns name of log file
   */


  getLogFile(name) {
    if (!this.config.logDir) {
      return;
    }

    return _path.default.join(this.config.logDir, `wdio-${this.cid}-${name}-reporter.log`);
  }
  /**
   * return write stream object based on reporter name
   */


  getWriteStreamObject(reporter) {
    return {
      write:
      /* istanbul ignore next */
      content => process.send({
        origin: 'reporter',
        name: reporter,
        content
      })
    };
  }
  /**
   * wait for reporter to finish synchronization, e.g. when sending data asynchronous
   * to a server (e.g. sumo reporter)
   */


  waitForSync() {
    const startTime = Date.now();
    return new Promise((resolve, reject) => {
      const interval = setInterval(() => {
        const unsyncedReporter = this.reporters.filter(reporter => !reporter.isSynchronised).map(reporter => reporter.constructor.name);

        if (Date.now() - startTime > this.reporterSyncTimeout && unsyncedReporter.length) {
          clearInterval(interval);
          return reject(new Error(`Some reporters are still unsynced: ${unsyncedReporter.join(', ')}`));
        }
        /**
         * no reporter are in need to sync anymore, continue
         */


        if (!unsyncedReporter.length) {
          clearInterval(interval);
          return resolve(true);
        }

        log.info(`Wait for ${unsyncedReporter.length} reporter to synchronise`); // wait otherwise
      }, this.reporterSyncInterval);
    });
  }
  /**
   * initialise reporters
   */


  initReporter(reporter) {
    let ReporterClass;
    let options = {
      logLevel: this.config.logLevel,
      setLogFile: NOOP
      /**
       * check if reporter has custom options
       */

    };

    if (Array.isArray(reporter)) {
      options = Object.assign(options, reporter[1]);
      reporter = reporter[0];
    }
    /**
     * check if reporter was passed in from a file, e.g.
     *
     * ```js
     * const MyCustomeReporter = require('/some/path/MyCustomeReporter.js')
     * export.config = {
     *     //...
     *     reporters: [
     *         MyCustomeReporter, // or
     *         [MyCustomeReporter, { custom: 'option' }]
     *     ]
     *     //...
     * }
     * ```
     */


    if (typeof reporter === 'function') {
      ReporterClass = reporter;
      const customLogFile = options.setLogFile(this.cid, ReporterClass.name);
      options.logFile = customLogFile || this.getLogFile(ReporterClass.name);
      options.writeStream = this.getWriteStreamObject(ReporterClass.name);
      return new ReporterClass(options);
    }
    /**
     * check if reporter is a node package, e.g. wdio-dot reporter
     *
     * ```js
     * export.config = {
     *     //...
     *     reporters: [
     *         'dot', // or
     *         ['dot', { custom: 'option' }]
     *     ]
     *     //...
     * }
     * ```
     */


    if (typeof reporter === 'string') {
      ReporterClass = (0, _config.initialisePlugin)(reporter, 'reporter');
      const customLogFile = options.setLogFile(this.cid, reporter);
      options.logFile = customLogFile || this.getLogFile(reporter);
      options.writeStream = this.getWriteStreamObject(reporter);
      return new ReporterClass(options);
    }
    /**
     * throw error if reporter property was invalid
     */


    throw new Error('Invalid reporters config');
  }

}

exports.default = BaseReporter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRlci5qcyJdLCJuYW1lcyI6WyJsb2ciLCJOT09QIiwiREVGQVVMVF9TWU5DX1RJTUVPVVQiLCJERUZBVUxUX1NZTkNfSU5URVJWQUwiLCJCYXNlUmVwb3J0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImNpZCIsInJlcG9ydGVycyIsIm1hcCIsImluaXRSZXBvcnRlciIsInJlcG9ydGVyU3luY0ludGVydmFsIiwicmVwb3J0ZXJTeW5jVGltZW91dCIsImVtaXQiLCJlIiwicGF5bG9hZCIsImZvckVhY2giLCJyZXBvcnRlciIsImdldExvZ0ZpbGUiLCJuYW1lIiwibG9nRGlyIiwicGF0aCIsImpvaW4iLCJnZXRXcml0ZVN0cmVhbU9iamVjdCIsIndyaXRlIiwiY29udGVudCIsInByb2Nlc3MiLCJzZW5kIiwib3JpZ2luIiwid2FpdEZvclN5bmMiLCJzdGFydFRpbWUiLCJEYXRlIiwibm93IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJpbnRlcnZhbCIsInNldEludGVydmFsIiwidW5zeW5jZWRSZXBvcnRlciIsImZpbHRlciIsImlzU3luY2hyb25pc2VkIiwibGVuZ3RoIiwiY2xlYXJJbnRlcnZhbCIsIkVycm9yIiwiaW5mbyIsIlJlcG9ydGVyQ2xhc3MiLCJvcHRpb25zIiwibG9nTGV2ZWwiLCJzZXRMb2dGaWxlIiwiQXJyYXkiLCJpc0FycmF5IiwiT2JqZWN0IiwiYXNzaWduIiwiY3VzdG9tTG9nRmlsZSIsImxvZ0ZpbGUiLCJ3cml0ZVN0cmVhbSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUcscUJBQU8sYUFBUCxDQUFaOztBQUVBLE1BQU1DLElBQUksR0FBRyxNQUFNLENBQUUsQ0FBckI7O0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcsSUFBN0IsQyxDQUFrQzs7QUFDbEMsTUFBTUMscUJBQXFCLEdBQUcsR0FBOUIsQyxDQUFrQzs7QUFFbEM7Ozs7OztB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QyxHQUF4QixFQUE2QlUsUUFBN0IsQ0FBdEI7QUFDQTZCLE1BQUFBLE9BQU8sQ0FBQ1EsT0FBUixHQUFrQkQsYUFBYSxJQUFJLEtBQUtuQyxVQUFMLENBQWdCRCxRQUFoQixDQUFuQztBQUNBNkIsTUFBQUEsT0FBTyxDQUFDUyxXQUFSLEdBQXNCLEtBQUtoQyxvQkFBTCxDQUEwQk4sUUFBMUIsQ0FBdEI7QUFDQSxhQUFPLElBQUk0QixhQUFKLENBQWtCQyxPQUFsQixDQUFQO0FBQ0g7QUFFRDs7Ozs7QUFHQSxVQUFNLElBQUlILEtBQUosQ0FBVSwwQkFBVixDQUFOO0FBQ0g7O0FBako2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCB7IGluaXRpYWxpc2VQbHVnaW4gfSBmcm9tICdAd2Rpby9jb25maWcnXG5cbmNvbnN0IGxvZyA9IGxvZ2dlcignd2Rpby1ydW5uZXInKVxuXG5jb25zdCBOT09QID0gKCkgPT4ge31cbmNvbnN0IERFRkFVTFRfU1lOQ19USU1FT1VUID0gNTAwMCAvLyA1c1xuY29uc3QgREVGQVVMVF9TWU5DX0lOVEVSVkFMID0gMTAwIC8vIDEwMG1zXG5cbi8qKlxuICogQmFzZVJlcG9ydGVyXG4gKiByZXNwb25zaWJsZSBmb3IgaW5pdGlhbGlzaW5nIHJlcG9ydGVycyBmb3IgZXZlcnkgdGVzdHJ1biBhbmQgcHJvcGFnYXRpbmcgZXZlbnRzXG4gKiB0byBhbGwgdGhlc2UgcmVwb3J0ZXJzXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJhc2VSZXBvcnRlciB7XG4gICAgY29uc3RydWN0b3IgKGNvbmZpZywgY2lkKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnXG4gICAgICAgIHRoaXMuY2lkID0gY2lkXG4gICAgICAgIHRoaXMucmVwb3J0ZXJzID0gY29uZmlnLnJlcG9ydGVycy5tYXAoOjp0aGlzLmluaXRSZXBvcnRlcilcblxuICAgICAgICAvKipcbiAgICAgICAgICogdGhlc2UgY29uZmlndXJhdGlvbnMgYXJlIG5vdCBwdWJsaWNseSBkb2N1bWVudGVkIGFzIHRoZXJlIHNob3VsZCBiZSBubyBkZXNpcmUgZm9yIGl0XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnJlcG9ydGVyU3luY0ludGVydmFsID0gdGhpcy5jb25maWcucmVwb3J0ZXJTeW5jSW50ZXJ2YWwgfHwgREVGQVVMVF9TWU5DX0lOVEVSVkFMXG4gICAgICAgIHRoaXMucmVwb3J0ZXJTeW5jVGltZW91dCA9IHRoaXMuY29uZmlnLnJlcG9ydGVyU3luY1RpbWVvdXQgfHwgREVGQVVMVF9TWU5DX1RJTUVPVVRcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBlbWl0IGV2ZW50cyB0byBhbGwgcmVnaXN0ZXJlZCByZXBvcnRlciBhbmQgd2RpbyBsYXVuY2VyXG4gICAgICpcbiAgICAgKiBAcGFyYW0gIHtTdHJpbmd9IGUgICAgICAgZXZlbnQgbmFtZVxuICAgICAqIEBwYXJhbSAge29iamVjdH0gcGF5bG9hZCBldmVudCBwYXlsb2FkXG4gICAgICovXG4gICAgZW1pdCAoZSwgcGF5bG9hZCkge1xuICAgICAgICBwYXlsb2FkLmNpZCA9IHRoaXMuY2lkXG4gICAgICAgIHRoaXMucmVwb3J0ZXJzLmZvckVhY2goKHJlcG9ydGVyKSA9PiByZXBvcnRlci5lbWl0KGUsIHBheWxvYWQpKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHJldHVybnMgbmFtZSBvZiBsb2cgZmlsZVxuICAgICAqL1xuICAgIGdldExvZ0ZpbGUgKG5hbWUpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5sb2dEaXIpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXRoLmpvaW4odGhpcy5jb25maWcubG9nRGlyLCBgd2Rpby0ke3RoaXMuY2lkfS0ke25hbWV9LXJlcG9ydGVyLmxvZ2ApXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmV0dXJuIHdyaXRlIHN0cmVhbSBvYmplY3QgYmFzZWQgb24gcmVwb3J0ZXIgbmFtZVxuICAgICAqL1xuICAgIGdldFdyaXRlU3RyZWFtT2JqZWN0IChyZXBvcnRlcikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgd3JpdGU6IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovIChjb250ZW50KSA9PiBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgICAgICAgIG9yaWdpbjogJ3JlcG9ydGVyJyxcbiAgICAgICAgICAgICAgICBuYW1lOiByZXBvcnRlcixcbiAgICAgICAgICAgICAgICBjb250ZW50XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogd2FpdCBmb3IgcmVwb3J0ZXIgdG8gZmluaXNoIHN5bmNocm9uaXphdGlvbiwgZS5nLiB3aGVuIHNlbmRpbmcgZGF0YSBhc3luY2hyb25vdXNcbiAgICAgKiB0byBhIHNlcnZlciAoZS5nLiBzdW1vIHJlcG9ydGVyKVxuICAgICAqL1xuICAgIHdhaXRGb3JTeW5jICgpIHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKVxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdW5zeW5jZWRSZXBvcnRlciA9IHRoaXMucmVwb3J0ZXJzXG4gICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKHJlcG9ydGVyKSA9PiAhcmVwb3J0ZXIuaXNTeW5jaHJvbmlzZWQpXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoKHJlcG9ydGVyKSA9PiByZXBvcnRlci5jb25zdHJ1Y3Rvci5uYW1lKVxuXG4gICAgICAgICAgICAgICAgaWYgKChEYXRlLm5vdygpIC0gc3RhcnRUaW1lKSA+IHRoaXMucmVwb3J0ZXJTeW5jVGltZW91dCAmJiB1bnN5bmNlZFJlcG9ydGVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcihgU29tZSByZXBvcnRlcnMgYXJlIHN0aWxsIHVuc3luY2VkOiAke3Vuc3luY2VkUmVwb3J0ZXIuam9pbignLCAnKX1gKSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBubyByZXBvcnRlciBhcmUgaW4gbmVlZCB0byBzeW5jIGFueW1vcmUsIGNvbnRpbnVlXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKCF1bnN5bmNlZFJlcG9ydGVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKGBXYWl0IGZvciAke3Vuc3luY2VkUmVwb3J0ZXIubGVuZ3RofSByZXBvcnRlciB0byBzeW5jaHJvbmlzZWApXG4gICAgICAgICAgICAgICAgLy8gd2FpdCBvdGhlcndpc2VcbiAgICAgICAgICAgIH0sIHRoaXMucmVwb3J0ZXJTeW5jSW50ZXJ2YWwpXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaW5pdGlhbGlzZSByZXBvcnRlcnNcbiAgICAgKi9cbiAgICBpbml0UmVwb3J0ZXIgKHJlcG9ydGVyKSB7XG4gICAgICAgIGxldCBSZXBvcnRlckNsYXNzXG4gICAgICAgIGxldCBvcHRpb25zID0ge1xuICAgICAgICAgICAgbG9nTGV2ZWw6IHRoaXMuY29uZmlnLmxvZ0xldmVsLFxuICAgICAgICAgICAgc2V0TG9nRmlsZTogTk9PUFxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGNoZWNrIGlmIHJlcG9ydGVyIGhhcyBjdXN0b20gb3B0aW9uc1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVwb3J0ZXIpKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihvcHRpb25zLCByZXBvcnRlclsxXSlcbiAgICAgICAgICAgIHJlcG9ydGVyID0gcmVwb3J0ZXJbMF1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBjaGVjayBpZiByZXBvcnRlciB3YXMgcGFzc2VkIGluIGZyb20gYSBmaWxlLCBlLmcuXG4gICAgICAgICAqXG4gICAgICAgICAqIGBgYGpzXG4gICAgICAgICAqIGNvbnN0IE15Q3VzdG9tZVJlcG9ydGVyID0gcmVxdWlyZSgnL3NvbWUvcGF0aC9NeUN1c3RvbWVSZXBvcnRlci5qcycpXG4gICAgICAgICAqIGV4cG9ydC5jb25maWcgPSB7XG4gICAgICAgICAqICAgICAvLy4uLlxuICAgICAgICAgKiAgICAgcmVwb3J0ZXJzOiBbXG4gICAgICAgICAqICAgICAgICAgTXlDdXN0b21lUmVwb3J0ZXIsIC8vIG9yXG4gICAgICAgICAqICAgICAgICAgW015Q3VzdG9tZVJlcG9ydGVyLCB7IGN1c3RvbTogJ29wdGlvbicgfV1cbiAgICAgICAgICogICAgIF1cbiAgICAgICAgICogICAgIC8vLi4uXG4gICAgICAgICAqIH1cbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodHlwZW9mIHJlcG9ydGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBSZXBvcnRlckNsYXNzID0gcmVwb3J0ZXJcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbUxvZ0ZpbGUgPSBvcHRpb25zLnNldExvZ0ZpbGUodGhpcy5jaWQsIFJlcG9ydGVyQ2xhc3MubmFtZSlcbiAgICAgICAgICAgIG9wdGlvbnMubG9nRmlsZSA9IGN1c3RvbUxvZ0ZpbGUgfHwgdGhpcy5nZXRMb2dGaWxlKFJlcG9ydGVyQ2xhc3MubmFtZSlcbiAgICAgICAgICAgIG9wdGlvbnMud3JpdGVTdHJlYW0gPSB0aGlzLmdldFdyaXRlU3RyZWFtT2JqZWN0KFJlcG9ydGVyQ2xhc3MubmFtZSlcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVwb3J0ZXJDbGFzcyhvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGNoZWNrIGlmIHJlcG9ydGVyIGlzIGEgbm9kZSBwYWNrYWdlLCBlLmcuIHdkaW8tZG90IHJlcG9ydGVyXG4gICAgICAgICAqXG4gICAgICAgICAqIGBgYGpzXG4gICAgICAgICAqIGV4cG9ydC5jb25maWcgPSB7XG4gICAgICAgICAqICAgICAvLy4uLlxuICAgICAgICAgKiAgICAgcmVwb3J0ZXJzOiBbXG4gICAgICAgICAqICAgICAgICAgJ2RvdCcsIC8vIG9yXG4gICAgICAgICAqICAgICAgICAgWydkb3QnLCB7IGN1c3RvbTogJ29wdGlvbicgfV1cbiAgICAgICAgICogICAgIF1cbiAgICAgICAgICogICAgIC8vLi4uXG4gICAgICAgICAqIH1cbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodHlwZW9mIHJlcG9ydGVyID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgUmVwb3J0ZXJDbGFzcyA9IGluaXRpYWxpc2VQbHVnaW4ocmVwb3J0ZXIsICdyZXBvcnRlcicpXG4gICAgICAgICAgICBjb25zdCBjdXN0b21Mb2dGaWxlID0gb3B0aW9ucy5zZXRMb2dGaWxlKHRoaXMuY2lkLCByZXBvcnRlcilcbiAgICAgICAgICAgIG9wdGlvbnMubG9nRmlsZSA9IGN1c3RvbUxvZ0ZpbGUgfHwgdGhpcy5nZXRMb2dGaWxlKHJlcG9ydGVyKVxuICAgICAgICAgICAgb3B0aW9ucy53cml0ZVN0cmVhbSA9IHRoaXMuZ2V0V3JpdGVTdHJlYW1PYmplY3QocmVwb3J0ZXIpXG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlcG9ydGVyQ2xhc3Mob3B0aW9ucylcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiB0aHJvdyBlcnJvciBpZiByZXBvcnRlciBwcm9wZXJ0eSB3YXMgaW52YWxpZFxuICAgICAgICAgKi9cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJlcG9ydGVycyBjb25maWcnKVxuICAgIH1cbn1cbiJdfQ==