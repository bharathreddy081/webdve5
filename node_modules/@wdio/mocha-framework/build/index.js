"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.adapterFactory = exports.MochaAdapter = exports.default = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _mocha = _interopRequireDefault(require("mocha"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _config = require("@wdio/config");

var _utils = require("./utils");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('wdio-mocha-framework');
/**
* Extracts the mocha UI type following this convention:
*  - If the mochaOpts.ui provided doesn't contain a '-' then the full name
*      is taken as ui type (i.e. 'bdd','tdd','qunit')
*  - If it contains a '-' then it asumes we are providing a custom ui for
*      mocha. Then it extracts the text after the last '-' (ignoring .js if
*      provided) as the interface type. (i.e. strong-bdd in
*      https://github.com/strongloop/strong-mocha-interfaces)
*/

const MOCHA_UI_TYPE_EXTRACTOR = /^(?:.*-)?([^-.]+)(?:.js)?$/;
const DEFAULT_INTERFACE_TYPE = 'bdd';
/**
 * Mocha runner
 */

class MochaAdapter {
  constructor(cid, config, specs, capabilities, reporter) {
    this.cid = cid;
    this.capabilities = capabilities;
    this.reporter = reporter;
    this.specs = specs;
    this.config = Object.assign({
      mochaOpts: {}
    }, config);
    this.runner = {};
    this.level = 0;
    this.suiteCnt = new Map();
    this.hookCnt = new Map();
    this.testCnt = new Map();
    this.suiteIds = ['0'];
  }

  async run() {
    const {
      mochaOpts
    } = this.config;
    const mocha = this.mocha = new _mocha.default(mochaOpts);
    mocha.loadFiles();
    mocha.reporter(_constants.NOOP);
    mocha.fullTrace();
    this.specs.forEach(spec => mocha.addFile(spec));
    mocha.suite.on('pre-require', this.preRequire.bind(this));
    let runtimeError;
    await (0, _config.executeHooksWithArgs)(this.config.before, [this.capabilities, this.specs]);
    const result = await new Promise(resolve => {
      try {
        this.runner = mocha.run(resolve);
      } catch (e) {
        runtimeError = e;
        return resolve(1);
      }

      Object.keys(_constants.EVENTS).forEach(e => this.runner.on(e, this.emit.bind(this, _constants.EVENTS[e])));
      this.runner.suite.beforeAll(this.wrapHook('beforeSuite'));
      this.runner.suite.beforeEach(this.wrapHook('beforeTest'));
      this.runner.suite.afterEach(this.wrapHook('afterTest'));
      this.runner.suite.afterAll(this.wrapHook('afterSuite'));
    });
    await (0, _config.executeHooksWithArgs)(this.config.after, [runtimeError || result, this.capabilities, this.specs]);
    /**
     * in case the spec has a runtime error throw after the wdio hook
     */

    if (runtimeError) {
      throw runtimeError;
    }

    return result;
  }

  options(options, context) {
    let {
      require = [],
      compilers = []
    } = options;

    if (typeof require === 'string') {
      require = [require];
    }

    this.requireExternalModules([...compilers, ...require], context);
  }

  preRequire(context, file, mocha) {
    const options = this.config.mochaOpts;
    const match = MOCHA_UI_TYPE_EXTRACTOR.exec(options.ui);
    const type = match && _constants.INTERFACES[match[1]] && match[1] || DEFAULT_INTERFACE_TYPE;
    this.options(options, {
      context,
      file,
      mocha,
      options
    });

    _constants.INTERFACES[type].forEach(fnName => {
      let testCommand = _constants.INTERFACES[type][0];
      (0, _config.runTestInFiberContext)([testCommand, testCommand + '.only'], this.config.beforeHook, this.config.afterHook, fnName);
    });
  }
  /**
   * Hooks which are added as true Mocha hooks need to call done() to notify async
   */


  wrapHook(hookName) {
    return () => (0, _config.executeHooksWithArgs)(this.config[hookName], this.prepareMessage(hookName)).catch(e => {
      log.error(`Error in ${hookName} hook: ${e.stack.slice(7)}`);
    });
  }

  prepareMessage(hookName) {
    const params = {
      type: hookName
    };

    switch (hookName) {
      case 'beforeSuite':
      case 'afterSuite':
        params.payload = this.runner.suite.suites[0];
        break;

      case 'beforeTest':
      case 'afterTest':
        params.payload = this.runner.test;
        break;
    }

    params.err = this.lastError;
    delete this.lastError;
    return this.formatMessage(params);
  }

  formatMessage(params) {
    let message = {
      type: params.type
    };

    if (params.err) {
      message.error = {
        message: params.err.message,
        stack: params.err.stack,
        type: params.err.type || params.err.name,
        expected: params.err.expected,
        actual: params.err.actual
        /**
         * hook failures are emitted as "test:fail"
         */

      };

      if (params.payload && params.payload.title && params.payload.title.match(/^"(before|after)( all)*" hook/g)) {
        message.type = 'hook:end';
      }
    }

    if (params.payload) {
      message.title = params.payload.title;
      message.parent = params.payload.parent ? params.payload.parent.title : null;
      /**
       * get title for hooks in root suite
       */

      if (message.parent === '' && params.payload.parent && params.payload.parent.suites) {
        message.parent = params.payload.parent.suites[0].title;
      }

      message.fullTitle = params.payload.fullTitle ? params.payload.fullTitle() : message.parent + ' ' + message.title;
      message.pending = params.payload.pending || false;
      /**
       * Add the current test title to the payload for cases where it helps to
       * identify the test, e.g. when running inside a beforeEach hook
       */

      if (params.payload.ctx && params.payload.ctx.currentTest) {
        message.currentTest = params.payload.ctx.currentTest.title;
      }

      if (params.type.match(/Test/)) {
        message.passed = params.payload.state === 'passed';
        message.duration = params.payload.duration;
      }

      if (params.payload.context) {
        message.context = params.payload.context;
      }
    }

    return message;
  }

  requireExternalModules(modules, context) {
    modules.forEach(module => {
      if (!module) {
        return;
      }

      module = module.replace(/.*:/, '');

      if (module.substr(0, 1) === '.') {
        module = _path.default.join(process.cwd(), module);
      }

      (0, _utils.loadModule)(module, context);
    });
  }

  emit(event, payload, err) {
    /**
     * For some reason, Mocha fires a second 'suite:end' event for the root suite,
     * with no matching 'suite:start', so this can be ignored.
     */
    if (payload.root) return;
    let message = this.formatMessage({
      type: event,
      payload,
      err
    });
    message.cid = this.cid;
    message.specs = this.specs;
    message.uid = this.getUID(message);

    if (message.error) {
      this.lastError = message.error;
    }

    this.reporter.emit(message.type, message);
  }

  getSyncEventIdStart(type) {
    const prop = `${type}Cnt`;
    const suiteId = this.suiteIds[this.suiteIds.length - 1];
    const cnt = this[prop].has(suiteId) ? this[prop].get(suiteId) : 0;
    this[prop].set(suiteId, cnt + 1);
    return `${type}-${suiteId}-${cnt}`;
  }

  getSyncEventIdEnd(type) {
    const prop = `${type}Cnt`;
    const suiteId = this.suiteIds[this.suiteIds.length - 1];
    const cnt = this[prop].get(suiteId) - 1;
    return `${type}-${suiteId}-${cnt}`;
  }

  getUID(message) {
    if (message.type === 'suite:start') {
      const suiteCnt = this.suiteCnt.has(this.level) ? this.suiteCnt.get(this.level) : 0;
      const suiteId = `suite-${this.level}-${suiteCnt}`;

      if (this.suiteCnt.has(this.level)) {
        this.suiteCnt.set(this.level, this.suiteCnt.get(this.level) + 1);
      } else {
        this.suiteCnt.set(this.level, 1);
      } // const suiteId = this.getSyncEventIdStart('suite')


      this.suiteIds.push(`${this.level}${suiteCnt}`);
      this.level++;
      return suiteId;
    }

    if (message.type === 'suite:end') {
      this.level--;
      const suiteCnt = this.suiteCnt.get(this.level) - 1;
      const suiteId = `suite-${this.level}-${suiteCnt}`;
      this.suiteIds.pop();
      return suiteId;
    }

    if (message.type === 'hook:start') {
      return this.getSyncEventIdStart('hook');
    }

    if (message.type === 'hook:end') {
      return this.getSyncEventIdEnd('hook');
    }

    if (message.type === 'test:start') {
      return this.getSyncEventIdStart('test');
    }

    if (['test:pending', 'test:end', 'test:pass', 'test:fail'].includes(message.type)) {
      return this.getSyncEventIdEnd('test');
    }

    throw new Error(`Unknown message type : ${message.type}`);
  }

}

exports.MochaAdapter = MochaAdapter;
const adapterFactory = {};
exports.adapterFactory = adapterFactory;

adapterFactory.run = async function (...args) {
  const adapter = new MochaAdapter(...args);
  const result = await adapter.run();
  return result;
};

var _default = adapterFactory;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2ciLCJNT0NIQV9VSV9UWVBFX0VYVFJBQ1RPUiIsIkRFRkFVTFRfSU5URVJGQUNFX1RZUEUiLCJNb2NoYUFkYXB0ZXIiLCJjb25zdHJ1Y3RvciIsImNpZCIsImNvbmZpZyIsInNwZWNzIiwiY2FwYWJpbGl0aWVzIiwicmVwb3J0ZXIiLCJPYmplY3QiLCJhc3NpZ24iLCJtb2NoYU9wdHMiLCJydW5uZXIiLCJsZXZlbCIsInN1aXRlQ250IiwiTWFwIiwiaG9va0NudCIsInRlc3RDbnQiLCJzdWl0ZUlkcyIsInJ1biIsIm1vY2hhIiwiTW9jaGEiLCJsb2FkRmlsZXMiLCJOT09QIiwiZnVsbFRyYWNlIiwiZm9yRWFjaCIsInNwZWMiLCJhZGRGaWxlIiwic3VpdGUiLCJvbiIsInByZVJlcXVpcmUiLCJydW50aW1lRXJyb3IiLCJiZWZvcmUiLCJyZXN1bHQiLCJQcm9taXNlIiwicmVzb2x2ZSIsImUiLCJrZXlzIiwiRVZFTlRTIiwiZW1pdCIsImJpbmQiLCJiZWZvcmVBbGwiLCJ3cmFwSG9vayIsImJlZm9yZUVhY2giLCJhZnRlckVhY2giLCJhZnRlckFsbCIsImFmdGVyIiwib3B0aW9ucyIsImNvbnRleHQiLCJyZXF1aXJlIiwiY29tcGlsZXJzIiwicmVxdWlyZUV4dGVybmFsTW9kdWxlcyIsImZpbGUiLCJtYXRjaCIsImV4ZWMiLCJ1aSIsInR5cGUiLCJJTlRFUkZBQ0VTIiwiZm5OYW1lIiwidGVzdENvbW1hbmQiLCJiZWZvcmVIb29rIiwiYWZ0ZXJIb29rIiwiaG9va05hbWUiLCJwcmVwYXJlTWVzc2FnZSIsImNhdGNoIiwiZXJyb3IiLCJzdGFjayIsInNsaWNlIiwicGFyYW1zIiwicGF5bG9hZCIsInN1aXRlcyIsInRlc3QiLCJlcnIiLCJsYXN0RXJyb3IiLCJmb3JtYXRNZXNzYWdlIiwibWVzc2FnZSIsIm5hbWUiLCJleHBlY3RlZCIsImFjdHVhbCIsInRpdGxlIiwicGFyZW50IiwiZnVsbFRpdGxlIiwicGVuZGluZyIsImN0eCIsImN1cnJlbnRUZXN0IiwicGFzc2VkIiwic3RhdGUiLCJkdXJhdGlvbiIsIm1vZHVsZXMiLCJtb2R1bGUiLCJyZXBsYWNlIiwic3Vic3RyIiwicGF0aCIsImpvaW4iLCJwcm9jZXNzIiwiY3dkIiwiZXZlbnQiLCJyb290IiwidWlkIiwiZ2V0VUlEIiwiZ2V0U3luY0V2ZW50SWRTdGFydCIsInByb3AiLCJzdWl0ZUlkIiwibGVuZ3RoIiwiY250IiwiaGFzIiwiZ2V0Iiwic2V0IiwiZ2V0U3luY0V2ZW50SWRFbmQiLCJwdXNoIiwicG9wIiwiaW5jbHVkZXMiLCJFcnJvciIsImFkYXB0ZXJGYWN0b3J5IiwiYXJncyIsImFkYXB0ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHLHFCQUFPLHNCQUFQLENBQVo7QUFFQTs7Ozs7Ozs7OztBQVNBLE1BQU1DLHVCQUF1QixHQUFHLDRCQUFoQztBQUNBLE1BQU1DLHNCQUFzQixHQUFHLEtBQS9CO0FBRUE7Ozs7QUFHQSxNQUFNQyxZQUFOLENBQW1CO0FBQ2ZDLEVBQUFBLFdBQVcsQ0FBRUMsR0FBRixFQUFPQyxNQUFQLEVBQWVDLEtBQWYsRUFBc0JDLFlBQXRCLEVBQW9DQyxRQUFwQyxFQUE4QztBQUNyRCxTQUFLSixHQUFMLEdBQVdBLEdBQVg7QUFDQSxTQUFLRyxZQUFMLEdBQW9CQSxZQUFwQjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0YsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0QsTUFBTCxHQUFjSSxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUN4QkMsTUFBQUEsU0FBUyxFQUFFO0FBRGEsS0FBZCxFQUVYTixNQUZXLENBQWQ7QUFHQSxTQUFLTyxNQUFMLEdBQWMsRUFBZDtBQUNBLFNBQUtDLEtBQUwsR0FBYSxDQUFiO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQixJQUFJQyxHQUFKLEVBQWhCO0FBQ0EsU0FB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RUFBdkI7OztBQUVBQSxjQUFjLENBQUM5RixHQUFmLEdBQXFCLGdCQUFnQixHQUFHK0YsSUFBbkIsRUFBeUI7QUFDMUMsUUFBTUMsT0FBTyxHQUFHLElBQUlqSCxZQUFKLENBQWlCLEdBQUdnSCxJQUFwQixDQUFoQjtBQUNBLFFBQU1qRixNQUFNLEdBQUcsTUFBTWtGLE9BQU8sQ0FBQ2hHLEdBQVIsRUFBckI7QUFDQSxTQUFPYyxNQUFQO0FBQ0gsQ0FKRDs7ZUFNZWdGLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IE1vY2hhIGZyb20gJ21vY2hhJ1xuXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCB7IHJ1blRlc3RJbkZpYmVyQ29udGV4dCwgZXhlY3V0ZUhvb2tzV2l0aEFyZ3MgfSBmcm9tICdAd2Rpby9jb25maWcnXG5cbmltcG9ydCB7IGxvYWRNb2R1bGUgfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHsgSU5URVJGQUNFUywgRVZFTlRTLCBOT09QIH0gZnJvbSAnLi9jb25zdGFudHMnXG5cbmNvbnN0IGxvZyA9IGxvZ2dlcignd2Rpby1tb2NoYS1mcmFtZXdvcmsnKVxuXG4vKipcbiogRXh0cmFjdHMgdGhlIG1vY2hhIFVJIHR5cGUgZm9sbG93aW5nIHRoaXMgY29udmVudGlvbjpcbiogIC0gSWYgdGhlIG1vY2hhT3B0cy51aSBwcm92aWRlZCBkb2Vzbid0IGNvbnRhaW4gYSAnLScgdGhlbiB0aGUgZnVsbCBuYW1lXG4qICAgICAgaXMgdGFrZW4gYXMgdWkgdHlwZSAoaS5lLiAnYmRkJywndGRkJywncXVuaXQnKVxuKiAgLSBJZiBpdCBjb250YWlucyBhICctJyB0aGVuIGl0IGFzdW1lcyB3ZSBhcmUgcHJvdmlkaW5nIGEgY3VzdG9tIHVpIGZvclxuKiAgICAgIG1vY2hhLiBUaGVuIGl0IGV4dHJhY3RzIHRoZSB0ZXh0IGFmdGVyIHRoZSBsYXN0ICctJyAoaWdub3JpbmcgLmpzIGlmXG4qICAgICAgcHJvdmlkZWQpIGFzIHRoZSBpbnRlcmZhY2UgdHlwZS4gKGkuZS4gc3Ryb25nLWJkZCBpblxuKiAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9zdHJvbmdsb29wL3N0cm9uZy1tb2NoYS1pbnRlcmZhY2VzKVxuKi9cbmNvbnN0IE1PQ0hBX1VJX1RZUEVfRVhUUkFDVE9SID0gL14oPzouKi0pPyhbXi0uXSspKD86LmpzKT8kL1xuY29uc3QgREVGQVVMVF9JTlRFUkZBQ0VfVFlQRSA9ICdiZGQnXG5cbi8qKlxuICogTW9jaGEgcnVubmVyXG4gKi9cbmNsYXNzIE1vY2hhQWRhcHRlciB7XG4gICAgY29uc3RydWN0b3IgKGNpZCwgY29uZmlnLCBzcGVjcywgY2FwYWJpbGl0aWVzLCByZXBvcnRlcikge1xuICAgICAgICB0aGlzLmNpZCA9IGNpZFxuICAgICAgICB0aGlzLmNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdGllc1xuICAgICAgICB0aGlzLnJlcG9ydGVyID0gcmVwb3J0ZXJcbiAgICAgICAgdGhpcy5zcGVjcyA9IHNwZWNzXG4gICAgICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgICBtb2NoYU9wdHM6IHt9XG4gICAgICAgIH0sIGNvbmZpZylcbiAgICAgICAgdGhpcy5ydW5uZXIgPSB7fVxuICAgICAgICB0aGlzLmxldmVsID0gMFxuICAgICAgICB0aGlzLnN1aXRlQ250ID0gbmV3IE1hcCgpXG4gICAgICAgIHRoaXMuaG9va0NudCA9IG5ldyBNYXAoKVxuICAgICAgICB0aGlzLnRlc3RDbnQgPSBuZXcgTWFwKClcbiAgICAgICAgdGhpcy5zdWl0ZUlkcyA9IFsnMCddXG4gICAgfVxuXG4gICAgYXN5bmMgcnVuICgpIHtcbiAgICAgICAgY29uc3QgeyBtb2NoYU9wdHMgfSA9IHRoaXMuY29uZmlnXG4gICAgICAgIGNvbnN0IG1vY2hhID0gdGhpcy5tb2NoYSA9IG5ldyBNb2NoYShtb2NoYU9wdHMpXG4gICAgICAgIG1vY2hhLmxvYWRGaWxlcygpXG4gICAgICAgIG1vY2hhLnJlcG9ydGVyKE5PT1ApXG4gICAgICAgIG1vY2hhLmZ1bGxUcmFjZSgpXG5cbiAgICAgICAgdGhpcy5zcGVjcy5mb3JFYWNoKChzcGVjKSA9PiBtb2NoYS5hZGRGaWxlKHNwZWMpKVxuICAgICAgICBtb2NoYS5zdWl0ZS5vbigncHJlLXJlcXVpcmUnLCA6OnRoaXMucHJlUmVxdWlyZSlcblxuICAgICAgICBsZXQgcnVudGltZUVycm9yXG4gICAgICAgIGF3YWl0IGV4ZWN1dGVIb29rc1dpdGhBcmdzKHRoaXMuY29uZmlnLmJlZm9yZSwgW3RoaXMuY2FwYWJpbGl0aWVzLCB0aGlzLnNwZWNzXSlcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ydW5uZXIgPSBtb2NoYS5ydW4ocmVzb2x2ZSlcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBydW50aW1lRXJyb3IgPSBlXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoMSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgT2JqZWN0LmtleXMoRVZFTlRTKS5mb3JFYWNoKChlKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMucnVubmVyLm9uKGUsIHRoaXMuZW1pdC5iaW5kKHRoaXMsIEVWRU5UU1tlXSkpKVxuXG4gICAgICAgICAgICB0aGlzLnJ1bm5lci5zdWl0ZS5iZWZvcmVBbGwodGhpcy53cmFwSG9vaygnYmVmb3JlU3VpdGUnKSlcbiAgICAgICAgICAgIHRoaXMucnVubmVyLnN1aXRlLmJlZm9yZUVhY2godGhpcy53cmFwSG9vaygnYmVmb3JlVGVzdCcpKVxuICAgICAgICAgICAgdGhpcy5ydW5uZXIuc3VpdGUuYWZ0ZXJFYWNoKHRoaXMud3JhcEhvb2soJ2FmdGVyVGVzdCcpKVxuICAgICAgICAgICAgdGhpcy5ydW5uZXIuc3VpdGUuYWZ0ZXJBbGwodGhpcy53cmFwSG9vaygnYWZ0ZXJTdWl0ZScpKVxuICAgICAgICB9KVxuICAgICAgICBhd2FpdCBleGVjdXRlSG9va3NXaXRoQXJncyh0aGlzLmNvbmZpZy5hZnRlciwgW3J1bnRpbWVFcnJvciB8fCByZXN1bHQsIHRoaXMuY2FwYWJpbGl0aWVzLCB0aGlzLnNwZWNzXSlcblxuICAgICAgICAvKipcbiAgICAgICAgICogaW4gY2FzZSB0aGUgc3BlYyBoYXMgYSBydW50aW1lIGVycm9yIHRocm93IGFmdGVyIHRoZSB3ZGlvIGhvb2tcbiAgICAgICAgICovXG4gICAgICAgIGlmIChydW50aW1lRXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IHJ1bnRpbWVFcnJvclxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH1cblxuICAgIG9wdGlvbnMgKG9wdGlvbnMsIGNvbnRleHQpIHtcbiAgICAgICAgbGV0IHtyZXF1aXJlID0gW10sIGNvbXBpbGVycyA9IFtdfSA9IG9wdGlvbnNcblxuICAgICAgICBpZiAodHlwZW9mIHJlcXVpcmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXF1aXJlID0gW3JlcXVpcmVdXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnJlcXVpcmVFeHRlcm5hbE1vZHVsZXMoWy4uLmNvbXBpbGVycywgLi4ucmVxdWlyZV0sIGNvbnRleHQpXG4gICAgfVxuXG4gICAgcHJlUmVxdWlyZSAoY29udGV4dCwgZmlsZSwgbW9jaGEpIHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuY29uZmlnLm1vY2hhT3B0c1xuXG4gICAgICAgIGNvbnN0IG1hdGNoID0gTU9DSEFfVUlfVFlQRV9FWFRSQUNUT1IuZXhlYyhvcHRpb25zLnVpKVxuICAgICAgICBjb25zdCB0eXBlID0gKG1hdGNoICYmIElOVEVSRkFDRVNbbWF0Y2hbMV1dICYmIG1hdGNoWzFdKSB8fCBERUZBVUxUX0lOVEVSRkFDRV9UWVBFXG5cbiAgICAgICAgdGhpcy5vcHRpb25zKG9wdGlvbnMsIHsgY29udGV4dCwgZmlsZSwgbW9jaGEsIG9wdGlvbnMgfSlcbiAgICAgICAgSU5URVJGQUNFU1t0eXBlXS5mb3JFYWNoKChmbk5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCB0ZXN0Q29tbWFuZCA9IElOVEVSRkFDRVNbdHlwZV1bMF1cblxuICAgICAgICAgICAgcnVuVGVzdEluRmliZXJDb250ZXh0KFxuICAgICAgICAgICAgICAgIFt0ZXN0Q29tbWFuZCwgdGVzdENvbW1hbmQgKyAnLm9ubHknXSxcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5iZWZvcmVIb29rLFxuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLmFmdGVySG9vayxcbiAgICAgICAgICAgICAgICBmbk5hbWVcbiAgICAgICAgICAgIClcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBIb29rcyB3aGljaCBhcmUgYWRkZWQgYXMgdHJ1ZSBNb2NoYSBob29rcyBuZWVkIHRvIGNhbGwgZG9uZSgpIHRvIG5vdGlmeSBhc3luY1xuICAgICAqL1xuICAgIHdyYXBIb29rIChob29rTmFtZSkge1xuICAgICAgICByZXR1cm4gKCkgPT4gZXhlY3V0ZUhvb2tzV2l0aEFyZ3MoXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ1tob29rTmFtZV0sXG4gICAgICAgICAgICB0aGlzLnByZXBhcmVNZXNzYWdlKGhvb2tOYW1lKVxuICAgICAgICApLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoYEVycm9yIGluICR7aG9va05hbWV9IGhvb2s6ICR7ZS5zdGFjay5zbGljZSg3KX1gKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHByZXBhcmVNZXNzYWdlIChob29rTmFtZSkge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSB7IHR5cGU6IGhvb2tOYW1lIH1cblxuICAgICAgICBzd2l0Y2ggKGhvb2tOYW1lKSB7XG4gICAgICAgIGNhc2UgJ2JlZm9yZVN1aXRlJzpcbiAgICAgICAgY2FzZSAnYWZ0ZXJTdWl0ZSc6XG4gICAgICAgICAgICBwYXJhbXMucGF5bG9hZCA9IHRoaXMucnVubmVyLnN1aXRlLnN1aXRlc1swXVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnYmVmb3JlVGVzdCc6XG4gICAgICAgIGNhc2UgJ2FmdGVyVGVzdCc6XG4gICAgICAgICAgICBwYXJhbXMucGF5bG9hZCA9IHRoaXMucnVubmVyLnRlc3RcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cblxuICAgICAgICBwYXJhbXMuZXJyID0gdGhpcy5sYXN0RXJyb3JcbiAgICAgICAgZGVsZXRlIHRoaXMubGFzdEVycm9yXG4gICAgICAgIHJldHVybiB0aGlzLmZvcm1hdE1lc3NhZ2UocGFyYW1zKVxuICAgIH1cblxuICAgIGZvcm1hdE1lc3NhZ2UgKHBhcmFtcykge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHtcbiAgICAgICAgICAgIHR5cGU6IHBhcmFtcy50eXBlXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFyYW1zLmVycikge1xuICAgICAgICAgICAgbWVzc2FnZS5lcnJvciA9IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBwYXJhbXMuZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgc3RhY2s6IHBhcmFtcy5lcnIuc3RhY2ssXG4gICAgICAgICAgICAgICAgdHlwZTogcGFyYW1zLmVyci50eXBlIHx8IHBhcmFtcy5lcnIubmFtZSxcbiAgICAgICAgICAgICAgICBleHBlY3RlZDogcGFyYW1zLmVyci5leHBlY3RlZCxcbiAgICAgICAgICAgICAgICBhY3R1YWw6IHBhcmFtcy5lcnIuYWN0dWFsXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogaG9vayBmYWlsdXJlcyBhcmUgZW1pdHRlZCBhcyBcInRlc3Q6ZmFpbFwiXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmIChwYXJhbXMucGF5bG9hZCAmJiBwYXJhbXMucGF5bG9hZC50aXRsZSAmJiBwYXJhbXMucGF5bG9hZC50aXRsZS5tYXRjaCgvXlwiKGJlZm9yZXxhZnRlcikoIGFsbCkqXCIgaG9vay9nKSkge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9ICdob29rOmVuZCdcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYXJhbXMucGF5bG9hZCkge1xuICAgICAgICAgICAgbWVzc2FnZS50aXRsZSA9IHBhcmFtcy5wYXlsb2FkLnRpdGxlXG4gICAgICAgICAgICBtZXNzYWdlLnBhcmVudCA9IHBhcmFtcy5wYXlsb2FkLnBhcmVudCA/IHBhcmFtcy5wYXlsb2FkLnBhcmVudC50aXRsZSA6IG51bGxcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBnZXQgdGl0bGUgZm9yIGhvb2tzIGluIHJvb3Qgc3VpdGVcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2UucGFyZW50ID09PSAnJyAmJiBwYXJhbXMucGF5bG9hZC5wYXJlbnQgJiYgcGFyYW1zLnBheWxvYWQucGFyZW50LnN1aXRlcykge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UucGFyZW50ID0gcGFyYW1zLnBheWxvYWQucGFyZW50LnN1aXRlc1swXS50aXRsZVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBtZXNzYWdlLmZ1bGxUaXRsZSA9IHBhcmFtcy5wYXlsb2FkLmZ1bGxUaXRsZSA/IHBhcmFtcy5wYXlsb2FkLmZ1bGxUaXRsZSgpIDogbWVzc2FnZS5wYXJlbnQgKyAnICcgKyBtZXNzYWdlLnRpdGxlXG4gICAgICAgICAgICBtZXNzYWdlLnBlbmRpbmcgPSBwYXJhbXMucGF5bG9hZC5wZW5kaW5nIHx8IGZhbHNlXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQWRkIHRoZSBjdXJyZW50IHRlc3QgdGl0bGUgdG8gdGhlIHBheWxvYWQgZm9yIGNhc2VzIHdoZXJlIGl0IGhlbHBzIHRvXG4gICAgICAgICAgICAgKiBpZGVudGlmeSB0aGUgdGVzdCwgZS5nLiB3aGVuIHJ1bm5pbmcgaW5zaWRlIGEgYmVmb3JlRWFjaCBob29rXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmIChwYXJhbXMucGF5bG9hZC5jdHggJiYgcGFyYW1zLnBheWxvYWQuY3R4LmN1cnJlbnRUZXN0KSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZS5jdXJyZW50VGVzdCA9IHBhcmFtcy5wYXlsb2FkLmN0eC5jdXJyZW50VGVzdC50aXRsZVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGFyYW1zLnR5cGUubWF0Y2goL1Rlc3QvKSkge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UucGFzc2VkID0gKHBhcmFtcy5wYXlsb2FkLnN0YXRlID09PSAncGFzc2VkJylcbiAgICAgICAgICAgICAgICBtZXNzYWdlLmR1cmF0aW9uID0gcGFyYW1zLnBheWxvYWQuZHVyYXRpb25cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBhcmFtcy5wYXlsb2FkLmNvbnRleHQpIHsgbWVzc2FnZS5jb250ZXh0ID0gcGFyYW1zLnBheWxvYWQuY29udGV4dCB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWVzc2FnZVxuICAgIH1cblxuICAgIHJlcXVpcmVFeHRlcm5hbE1vZHVsZXMgKG1vZHVsZXMsIGNvbnRleHQpIHtcbiAgICAgICAgbW9kdWxlcy5mb3JFYWNoKG1vZHVsZSA9PiB7XG4gICAgICAgICAgICBpZiAoIW1vZHVsZSkge1xuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGUucmVwbGFjZSgvLio6LywgJycpXG5cbiAgICAgICAgICAgIGlmIChtb2R1bGUuc3Vic3RyKDAsIDEpID09PSAnLicpIHtcbiAgICAgICAgICAgICAgICBtb2R1bGUgPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgbW9kdWxlKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsb2FkTW9kdWxlKG1vZHVsZSwgY29udGV4dClcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBlbWl0IChldmVudCwgcGF5bG9hZCwgZXJyKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGb3Igc29tZSByZWFzb24sIE1vY2hhIGZpcmVzIGEgc2Vjb25kICdzdWl0ZTplbmQnIGV2ZW50IGZvciB0aGUgcm9vdCBzdWl0ZSxcbiAgICAgICAgICogd2l0aCBubyBtYXRjaGluZyAnc3VpdGU6c3RhcnQnLCBzbyB0aGlzIGNhbiBiZSBpZ25vcmVkLlxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHBheWxvYWQucm9vdCkgcmV0dXJuXG5cbiAgICAgICAgbGV0IG1lc3NhZ2UgPSB0aGlzLmZvcm1hdE1lc3NhZ2Uoe3R5cGU6IGV2ZW50LCBwYXlsb2FkLCBlcnJ9KVxuXG4gICAgICAgIG1lc3NhZ2UuY2lkID0gdGhpcy5jaWRcbiAgICAgICAgbWVzc2FnZS5zcGVjcyA9IHRoaXMuc3BlY3NcbiAgICAgICAgbWVzc2FnZS51aWQgPSB0aGlzLmdldFVJRChtZXNzYWdlKVxuXG4gICAgICAgIGlmIChtZXNzYWdlLmVycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IG1lc3NhZ2UuZXJyb3JcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucmVwb3J0ZXIuZW1pdChtZXNzYWdlLnR5cGUsIG1lc3NhZ2UpXG4gICAgfVxuXG4gICAgZ2V0U3luY0V2ZW50SWRTdGFydCAodHlwZSkge1xuICAgICAgICBjb25zdCBwcm9wID0gYCR7dHlwZX1DbnRgXG4gICAgICAgIGNvbnN0IHN1aXRlSWQgPSB0aGlzLnN1aXRlSWRzW3RoaXMuc3VpdGVJZHMubGVuZ3RoIC0gMV1cbiAgICAgICAgY29uc3QgY250ID0gdGhpc1twcm9wXS5oYXMoc3VpdGVJZClcbiAgICAgICAgICAgID8gdGhpc1twcm9wXS5nZXQoc3VpdGVJZClcbiAgICAgICAgICAgIDogMFxuICAgICAgICB0aGlzW3Byb3BdLnNldChzdWl0ZUlkLCBjbnQgKyAxKVxuICAgICAgICByZXR1cm4gYCR7dHlwZX0tJHtzdWl0ZUlkfS0ke2NudH1gXG4gICAgfVxuXG4gICAgZ2V0U3luY0V2ZW50SWRFbmQgKHR5cGUpIHtcbiAgICAgICAgY29uc3QgcHJvcCA9IGAke3R5cGV9Q250YFxuICAgICAgICBjb25zdCBzdWl0ZUlkID0gdGhpcy5zdWl0ZUlkc1t0aGlzLnN1aXRlSWRzLmxlbmd0aCAtIDFdXG4gICAgICAgIGNvbnN0IGNudCA9IHRoaXNbcHJvcF0uZ2V0KHN1aXRlSWQpIC0gMVxuICAgICAgICByZXR1cm4gYCR7dHlwZX0tJHtzdWl0ZUlkfS0ke2NudH1gXG4gICAgfVxuXG4gICAgZ2V0VUlEIChtZXNzYWdlKSB7XG4gICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09ICdzdWl0ZTpzdGFydCcpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1aXRlQ250ID0gdGhpcy5zdWl0ZUNudC5oYXModGhpcy5sZXZlbClcbiAgICAgICAgICAgICAgICA/IHRoaXMuc3VpdGVDbnQuZ2V0KHRoaXMubGV2ZWwpXG4gICAgICAgICAgICAgICAgOiAwXG4gICAgICAgICAgICBjb25zdCBzdWl0ZUlkID0gYHN1aXRlLSR7dGhpcy5sZXZlbH0tJHtzdWl0ZUNudH1gXG5cbiAgICAgICAgICAgIGlmICh0aGlzLnN1aXRlQ250Lmhhcyh0aGlzLmxldmVsKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3VpdGVDbnQuc2V0KHRoaXMubGV2ZWwsIHRoaXMuc3VpdGVDbnQuZ2V0KHRoaXMubGV2ZWwpICsgMSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdWl0ZUNudC5zZXQodGhpcy5sZXZlbCwgMSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gY29uc3Qgc3VpdGVJZCA9IHRoaXMuZ2V0U3luY0V2ZW50SWRTdGFydCgnc3VpdGUnKVxuICAgICAgICAgICAgdGhpcy5zdWl0ZUlkcy5wdXNoKGAke3RoaXMubGV2ZWx9JHtzdWl0ZUNudH1gKVxuICAgICAgICAgICAgdGhpcy5sZXZlbCsrXG4gICAgICAgICAgICByZXR1cm4gc3VpdGVJZFxuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09ICdzdWl0ZTplbmQnKSB7XG4gICAgICAgICAgICB0aGlzLmxldmVsLS1cbiAgICAgICAgICAgIGNvbnN0IHN1aXRlQ250ID0gdGhpcy5zdWl0ZUNudC5nZXQodGhpcy5sZXZlbCkgLSAxXG4gICAgICAgICAgICBjb25zdCBzdWl0ZUlkID0gYHN1aXRlLSR7dGhpcy5sZXZlbH0tJHtzdWl0ZUNudH1gXG4gICAgICAgICAgICB0aGlzLnN1aXRlSWRzLnBvcCgpXG4gICAgICAgICAgICByZXR1cm4gc3VpdGVJZFxuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09ICdob29rOnN0YXJ0Jykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3luY0V2ZW50SWRTdGFydCgnaG9vaycpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ2hvb2s6ZW5kJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3luY0V2ZW50SWRFbmQoJ2hvb2snKVxuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09ICd0ZXN0OnN0YXJ0Jykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3luY0V2ZW50SWRTdGFydCgndGVzdCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKFsndGVzdDpwZW5kaW5nJywgJ3Rlc3Q6ZW5kJywgJ3Rlc3Q6cGFzcycsICd0ZXN0OmZhaWwnXS5pbmNsdWRlcyhtZXNzYWdlLnR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTeW5jRXZlbnRJZEVuZCgndGVzdCcpXG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gbWVzc2FnZSB0eXBlIDogJHttZXNzYWdlLnR5cGV9YClcbiAgICB9XG59XG5cbmNvbnN0IGFkYXB0ZXJGYWN0b3J5ID0ge31cblxuYWRhcHRlckZhY3RvcnkucnVuID0gYXN5bmMgZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICBjb25zdCBhZGFwdGVyID0gbmV3IE1vY2hhQWRhcHRlciguLi5hcmdzKVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGFkYXB0ZXIucnVuKClcbiAgICByZXR1cm4gcmVzdWx0XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFkYXB0ZXJGYWN0b3J5XG5leHBvcnQgeyBNb2NoYUFkYXB0ZXIsIGFkYXB0ZXJGYWN0b3J5IH1cbiJdfQ==