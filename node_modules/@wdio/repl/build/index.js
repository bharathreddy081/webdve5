"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _vm = _interopRequireDefault(require("vm"));

var _repl = _interopRequireDefault(require("repl"));

var _config = require("@wdio/config");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class WDIORepl {
  constructor(config) {
    this.config = Object.assign({
      commandTimeout: 5000,
      eval: this.eval.bind(this),
      prompt: '\u203A ',
      useGlobal: true,
      useColor: true
    }, config);
    this.isCommandRunning = false;
  }

  eval(cmd, context, filename, callback) {
    if (this.isCommandRunning) {
      return;
    }

    if (cmd && _constants.STATIC_RETURNS[cmd.trim()]) {
      return callback(null, _constants.STATIC_RETURNS[cmd.trim()]);
    }

    _vm.default.createContext(context);

    this.isCommandRunning = true;
    /* istanbul ignore if */

    if (_config.hasWdioSyncSupport) {
      return (0, _config.runFnInFiberContext)(() => {
        return this._runCmd(cmd, context, callback);
      })();
    }

    return this._runCmd(cmd, context, callback);
  }

  _runCmd(cmd, context, callback) {
    try {
      const result = _vm.default.runInContext(cmd, context);

      return this._handleResult(result, callback);
    } catch (e) {
      this.isCommandRunning = false;
      return callback(e);
    }
  }

  _handleResult(result, callback) {
    if (!result || typeof result.then !== 'function') {
      this.isCommandRunning = false;
      return callback(null, result);
    }

    const timeout = setTimeout(() => {
      callback(new Error('Command execution timed out'));
      this.isCommandRunning = false;
    }, this.config.commandTimeout);
    result.then(res => {
      /**
       * don't do anything if timeout was called
       */
      if (timeout._called) {
        return;
      }

      this.isCommandRunning = false;
      clearTimeout(timeout);
      return callback(null, res);
    }, e => {
      /**
       * don't do anything if timeout was called
       */
      if (timeout._called) {
        return;
      }

      this.isCommandRunning = false;
      clearTimeout(timeout);
      const commandError = new Error(e.message);
      delete commandError.stack;
      return callback(commandError);
    });
  }

  start(context) {
    if (this.replServer) {
      throw new Error('a repl was already initialised');
    }

    if (context) {
      const evalFn = this.config.eval;

      this.config.eval = (cmd, _, filename, callback) => evalFn(cmd, context, filename, callback);
    }

    this.replServer = _repl.default.start(this.config);
    return new Promise(resolve => this.replServer.on('exit', resolve));
  }

}

exports.default = WDIORepl;

_defineProperty(WDIORepl, "introMessage", _constants.INTRO_MESSAGE);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJXRElPUmVwbCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiT2JqZWN0IiwiYXNzaWduIiwiY29tbWFuZFRpbWVvdXQiLCJldmFsIiwicHJvbXB0IiwidXNlR2xvYmFsIiwidXNlQ29sb3IiLCJpc0NvbW1hbmRSdW5uaW5nIiwiY21kIiwiY29udGV4dCIsImZpbGVuYW1lIiwiY2FsbGJhY2siLCJTVEFUSUNfUkVUVVJOUyIsInRyaW0iLCJ2bSIsImNyZWF0ZUNvbnRleHQiLCJoYXNXZGlvU3luY1N1cHBvcnQiLCJfcnVuQ21kIiwicmVzdWx0IiwicnVuSW5Db250ZXh0IiwiX2hhbmRsZVJlc3VsdCIsImUiLCJ0aGVuIiwidGltZW91dCIsInNldFRpbWVvdXQiLCJFcnJvciIsInJlcyIsIl9jYWxsZWQiLCJjbGVhclRpbWVvdXQiLCJjb21tYW5kRXJyb3IiLCJtZXNzYWdlIiwic3RhY2siLCJzdGFydCIsInJlcGxTZXJ2ZXIiLCJldmFsRm4iLCJfIiwicmVwbCIsIlByb21pc2UiLCJyZXNvbHZlIiwib24iLCJJTlRST19NRVNTQUdFIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7Ozs7OztBQUVlLE1BQU1BLFFBQU4sQ0FBZTtBQUcxQkMsRUFBQUEsV0FBVyxDQUFFQyxNQUFGLEVBQVU7QUFDakIsU0FBS0EsTUFBTCxHQUFjQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUN4QkMsTUFBQUEsY0FBYyxFQUFFLElBRFE7QUFFeEJDLE1BQUFBLElBQUksRUFBSSxLQUFLQSxJQUFULE1BQUksSUFBSixDQUZvQjtBQUd4QkMsTUFBQUEsTUFBTSxFQUFFLFNBSGdCO0FBSXhCQyxNQUFBQSxTQUFTLEVBQUUsSUFKYTtBQUt4QkMsTUFBQUEsUUFBUSxFQUFFO0FBTGMsS0FBZCxFQU1YUCxNQU5XLENBQWQ7QUFRQSxTQUFLUSxnQkFBTCxHQUF3QixLQUF4QjtBQUNIOztBQUVESixFQUFB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LENBQVlJLElBQTNCOztBQUNBLFdBQUtKLE1BQUwsQ0FBWUksSUFBWixHQUFtQixDQUFDSyxHQUFELEVBQU0yQixDQUFOLEVBQVN6QixRQUFULEVBQW1CQyxRQUFuQixLQUFnQ3VCLE1BQU0sQ0FBQzFCLEdBQUQsRUFBTUMsT0FBTixFQUFlQyxRQUFmLEVBQXlCQyxRQUF6QixDQUF6RDtBQUNIOztBQUVELFNBQUtzQixVQUFMLEdBQWtCRyxjQUFLSixLQUFMLENBQVcsS0FBS2pDLE1BQWhCLENBQWxCO0FBRUEsV0FBTyxJQUFJc0MsT0FBSixDQUNGQyxPQUFELElBQWEsS0FBS0wsVUFBTCxDQUFnQk0sRUFBaEIsQ0FBbUIsTUFBbkIsRUFBMkJELE9BQTNCLENBRFYsQ0FBUDtBQUVIOztBQXJHeUI7Ozs7Z0JBQVR6QyxRLGtCQUNLMkMsd0IiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8qKlxuICpcbiAqIFRoaXMgY29tbWFuZCBoZWxwcyB5b3UgdG8gZGVidWcgeW91ciBpbnRlZ3JhdGlvbiB0ZXN0cy4gSXQgc3RvcHMgdGhlIHJ1bm5pbmcgYnJvd3NlciBhbmQgZ2l2ZXNcbiAqIHlvdSB0aW1lIHRvIGp1bXAgaW50byBpdCBhbmQgY2hlY2sgdGhlIHN0YXRlIG9mIHlvdXIgYXBwbGljYXRpb24gKGUuZy4gdXNpbmcgZGV2IHRvb2xzKS5cbiAqIFlvdXIgdGVybWluYWwgdHJhbnNmb3JtcyBpbnRvIGEgW1JFUExdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1JlYWQlRTIlODAlOTNldmFsJUUyJTgwJTkzcHJpbnRfbG9vcClcbiAqIGludGVyZmFjZSB0aGF0IHdpbGwgYWxsb3cgeW91IHRvIHRyeSBvdXQgY2VydGFpbiBjb21tYW5kcywgZmluZCBlbGVtZW50cyBhbmQgdGVzdCBhY3Rpb25zIG9uXG4gKiB0aGVtLlxuICpcbiAqIFshW1dlYmRyaXZlcklPIFJFUExdKGh0dHA6Ly93ZWJkcml2ZXIuaW8vaW1hZ2VzL3JlcGwuZ2lmKV0oaHR0cDovL3dlYmRyaXZlci5pby9pbWFnZXMvcmVwbC5naWYpXG4gKlxuICogSWYgeW91IHJ1biB0aGUgV0RJTyB0ZXN0cnVubmVyIG1ha2Ugc3VyZSB5b3UgaW5jcmVhc2UgdGhlIHRpbWVvdXQgcHJvcGVydHkgb2YgdGhlIHRlc3QgZnJhbWV3b3JrXG4gKiB5b3UgYXJlIHVzaW5nIChlLmcuIE1vY2hhIG9yIEphc21pbmUpIGluIG9yZGVyIHRvIHByZXZlbnQgdGVzdCB0ZXJtaW5hdGlvbiBkdWUgdG8gYSB0ZXN0IHRpbWVvdXQuXG4gKiBBbHNvIGF2b2lkIGV4ZWN1dGluZyB0aGUgY29tbWFuZCB3aXRoIG11bHRpcGxlIGNhcGFiaWxpdGllcyBydW5uaW5nIGF0IHRoZSBzYW1lIHRpbWUuXG4gKlxuICogPGlmcmFtZSB3aWR0aD1cIjU2MFwiIGhlaWdodD1cIjMxNVwiIHNyYz1cImh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL2VtYmVkL3hXd1AtM0JfWXlFXCIgZnJhbWVib3JkZXI9XCIwXCIgYWxsb3dmdWxsc2NyZWVuPjwvaWZyYW1lPlxuICpcbiAqIDxleGFtcGxlPlxuICAgIDpkZWJ1Zy5qc1xuICAgIGl0KCdzaG91bGQgZGVtb25zdHJhdGUgdGhlIGRlYnVnIGNvbW1hbmQnLCAoKSA9PiB7XG4gICAgICAgICQoJyNpbnB1dCcpLnNldFZhbHVlKCdGT08nKVxuICAgICAgICBicm93c2VyLmRlYnVnKCkgLy8ganVtcGluZyBpbnRvIHRoZSBicm93c2VyIGFuZCBjaGFuZ2UgdmFsdWUgb2YgI2lucHV0IHRvICdCQVInXG4gICAgICAgIGNvbnN0IHZhbHVlID0gJCgnI2lucHV0JykuZ2V0VmFsdWUoKVxuICAgICAgICBjb25zb2xlLmxvZyh2YWx1ZSkgLy8gb3V0cHV0czogXCJCQVJcIlxuICAgIH0pXG4gKiA8L2V4YW1wbGU+XG4gKlxuICogQGFsaWFzIGJyb3dzZXIuZGVidWdcbiAqIEB0eXBlIHV0aWxpdHlcbiAqXG4gKi9cblxuaW1wb3J0IHZtIGZyb20gJ3ZtJ1xuaW1wb3J0IHJlcGwgZnJvbSAncmVwbCdcblxuaW1wb3J0IHsgcnVuRm5JbkZpYmVyQ29udGV4dCwgaGFzV2Rpb1N5bmNTdXBwb3J0IH0gZnJvbSAnQHdkaW8vY29uZmlnJ1xuXG5pbXBvcnQgeyBTVEFUSUNfUkVUVVJOUywgSU5UUk9fTUVTU0FHRSB9IGZyb20gJy4vY29uc3RhbnRzJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXRElPUmVwbCB7XG4gICAgc3RhdGljIGludHJvTWVzc2FnZSA9IElOVFJPX01FU1NBR0VcblxuICAgIGNvbnN0cnVjdG9yIChjb25maWcpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgICAgIGNvbW1hbmRUaW1lb3V0OiA1MDAwLFxuICAgICAgICAgICAgZXZhbDogOjp0aGlzLmV2YWwsXG4gICAgICAgICAgICBwcm9tcHQ6ICdcXHUyMDNBICcsXG4gICAgICAgICAgICB1c2VHbG9iYWw6IHRydWUsXG4gICAgICAgICAgICB1c2VDb2xvcjogdHJ1ZVxuICAgICAgICB9LCBjb25maWcpXG5cbiAgICAgICAgdGhpcy5pc0NvbW1hbmRSdW5uaW5nID0gZmFsc2VcbiAgICB9XG5cbiAgICBldmFsIChjbWQsIGNvbnRleHQsIGZpbGVuYW1lLCBjYWxsYmFjaykge1xuICAgICAgICBpZiAodGhpcy5pc0NvbW1hbmRSdW5uaW5nKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjbWQgJiYgU1RBVElDX1JFVFVSTlNbY21kLnRyaW0oKV0pIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBTVEFUSUNfUkVUVVJOU1tjbWQudHJpbSgpXSlcbiAgICAgICAgfVxuXG4gICAgICAgIHZtLmNyZWF0ZUNvbnRleHQoY29udGV4dClcbiAgICAgICAgdGhpcy5pc0NvbW1hbmRSdW5uaW5nID0gdHJ1ZVxuXG4gICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqL1xuICAgICAgICBpZiAoaGFzV2Rpb1N5bmNTdXBwb3J0KSB7XG4gICAgICAgICAgICByZXR1cm4gcnVuRm5JbkZpYmVyQ29udGV4dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1bkNtZChjbWQsIGNvbnRleHQsIGNhbGxiYWNrKVxuICAgICAgICAgICAgfSkoKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3J1bkNtZChjbWQsIGNvbnRleHQsIGNhbGxiYWNrKVxuICAgIH1cblxuICAgIF9ydW5DbWQgKGNtZCwgY29udGV4dCwgY2FsbGJhY2spIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHZtLnJ1bkluQ29udGV4dChjbWQsIGNvbnRleHQpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlUmVzdWx0KHJlc3VsdCwgY2FsbGJhY2spXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMuaXNDb21tYW5kUnVubmluZyA9IGZhbHNlXG4gICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9oYW5kbGVSZXN1bHQgKHJlc3VsdCwgY2FsbGJhY2spIHtcbiAgICAgICAgaWYgKCFyZXN1bHQgfHwgdHlwZW9mIHJlc3VsdC50aGVuICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aGlzLmlzQ29tbWFuZFJ1bm5pbmcgPSBmYWxzZVxuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJlc3VsdClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KFxuICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignQ29tbWFuZCBleGVjdXRpb24gdGltZWQgb3V0JykpXG4gICAgICAgICAgICAgICAgdGhpcy5pc0NvbW1hbmRSdW5uaW5nID0gZmFsc2VcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5jb21tYW5kVGltZW91dFxuICAgICAgICApXG5cbiAgICAgICAgcmVzdWx0LnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBkb24ndCBkbyBhbnl0aGluZyBpZiB0aW1lb3V0IHdhcyBjYWxsZWRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKHRpbWVvdXQuX2NhbGxlZCkge1xuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5pc0NvbW1hbmRSdW5uaW5nID0gZmFsc2VcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KVxuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJlcylcbiAgICAgICAgfSwgKGUpID0+IHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogZG9uJ3QgZG8gYW55dGhpbmcgaWYgdGltZW91dCB3YXMgY2FsbGVkXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmICh0aW1lb3V0Ll9jYWxsZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5pc0NvbW1hbmRSdW5uaW5nID0gZmFsc2VcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KVxuICAgICAgICAgICAgY29uc3QgY29tbWFuZEVycm9yID0gbmV3IEVycm9yKGUubWVzc2FnZSlcbiAgICAgICAgICAgIGRlbGV0ZSBjb21tYW5kRXJyb3Iuc3RhY2tcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhjb21tYW5kRXJyb3IpXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgc3RhcnQgKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKHRoaXMucmVwbFNlcnZlcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdhIHJlcGwgd2FzIGFscmVhZHkgaW5pdGlhbGlzZWQnKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRleHQpIHtcbiAgICAgICAgICAgIGNvbnN0IGV2YWxGbiA9IHRoaXMuY29uZmlnLmV2YWxcbiAgICAgICAgICAgIHRoaXMuY29uZmlnLmV2YWwgPSAoY21kLCBfLCBmaWxlbmFtZSwgY2FsbGJhY2spID0+IGV2YWxGbihjbWQsIGNvbnRleHQsIGZpbGVuYW1lLCBjYWxsYmFjaylcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucmVwbFNlcnZlciA9IHJlcGwuc3RhcnQodGhpcy5jb25maWcpXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKFxuICAgICAgICAgICAgKHJlc29sdmUpID0+IHRoaXMucmVwbFNlcnZlci5vbignZXhpdCcsIHJlc29sdmUpKVxuICAgIH1cbn1cbiJdfQ==