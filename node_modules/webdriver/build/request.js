"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _url = _interopRequireDefault(require("url"));

var _http = _interopRequireDefault(require("http"));

var _path = _interopRequireDefault(require("path"));

var _https = _interopRequireDefault(require("https"));

var _request = _interopRequireDefault(require("request"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _events = _interopRequireDefault(require("events"));

var _utils = require("./utils");

var _package = _interopRequireDefault(require("../package.json"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('webdriver');
const agents = {
  http: new _http.default.Agent({
    keepAlive: true
  }),
  https: new _https.default.Agent({
    keepAlive: true
  })
};

class WebDriverRequest extends _events.default {
  constructor(method, endpoint, body) {
    super();
    this.method = method;
    this.endpoint = endpoint;
    this.requiresSessionId = this.endpoint.match(/:sessionId/);
    this.defaultOptions = {
      method,
      body,
      followAllRedirects: true,
      json: true,
      headers: {
        'Connection': 'keep-alive',
        'Accept': 'application/json',
        'User-Agent': 'webdriver/' + _package.default.version
      }
    };
  }

  makeRequest(options, sessionId) {
    const fullRequestOptions = Object.assign(this.defaultOptions, this._createOptions(options, sessionId));
    this.emit('request', fullRequestOptions);
    return this._request(fullRequestOptions, options.connectionRetryCount);
  }

  _createOptions(options, sessionId) {
    const requestOptions = {
      agent: agents[options.protocol],
      headers: typeof options.headers === 'object' ? options.headers : {},
      qs: typeof this.defaultOptions.queryParams === 'object' ? options.queryParams : {}
      /**
       * if we don't have a session id we set it here, unless we call commands that don't require session ids, for
       * example /sessions. The call to /sessions is not connected to a session itself and it therefore doesn't
       * require it
       */

    };

    if (this.requiresSessionId && !sessionId) {
      throw new Error('A sessionId is required for this command');
    }

    requestOptions.uri = _url.default.parse(`${options.protocol}://` + `${options.hostname}:${options.port}` + _path.default.join(`${options.path}${this.endpoint.replace(':sessionId', sessionId)}`));
    /**
     * send authentication credentials only when creating new session
     */

    if (this.endpoint === '/session' && options.user && options.key) {
      requestOptions.auth = {
        user: options.user,
        pass: options.key
      };
    }

    return requestOptions;
  }

  _request(fullRequestOptions, totalRetryCount = 0, retryCount = 0) {
    log.info(`[${fullRequestOptions.method}] ${fullRequestOptions.uri.href}`);

    if (fullRequestOptions.body && Object.keys(fullRequestOptions.body).length) {
      log.info('DATA', fullRequestOptions.body);
    }

    return new Promise((resolve, reject) => (0, _request.default)(fullRequestOptions, (err, response, body) => {
      const error = new Error(err || (body && body.value ? body.value.message : body));
      /**
       * Resolve only if successful response
       */

      if (!err && (0, _utils.isSuccessfulResponse)(response)) {
        this.emit('response', {
          result: body
        });
        return resolve(body);
      }
      /**
       *  stop retrying as this will never be successful.
       *  we will handle this at the elementErrorHandler
       */


      if (error.message.includes('stale element reference')) {
        log.warn('Request encountered a stale element - terminating request');
        this.emit('response', {
          error
        });
        return reject(error);
      }
      /**
       * stop retrying if totalRetryCount was exceeded or there is no reason to
       * retry, e.g. if sessionId is invalid
       */


      if (retryCount >= totalRetryCount || error.message.includes('invalid session id')) {
        log.error('Request failed due to', error);
        this.emit('response', {
          error
        });
        return reject(error);
      }

      ++retryCount;
      this.emit('retry', {
        error,
        retryCount
      });
      log.warn('Request failed due to', error.message);
      log.info(`Retrying ${retryCount}/${totalRetryCount}`);

      this._request(fullRequestOptions, totalRetryCount, retryCount).then(resolve, reject);
    }));
  }

}

exports.default = WebDriverRequest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXF1ZXN0LmpzIl0sIm5hbWVzIjpbImxvZyIsImFnZW50cyIsImh0dHAiLCJBZ2VudCIsImtlZXBBbGl2ZSIsImh0dHBzIiwiV2ViRHJpdmVyUmVxdWVzdCIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwibWV0aG9kIiwiZW5kcG9pbnQiLCJib2R5IiwicmVxdWlyZXNTZXNzaW9uSWQiLCJtYXRjaCIsImRlZmF1bHRPcHRpb25zIiwiZm9sbG93QWxsUmVkaXJlY3RzIiwianNvbiIsImhlYWRlcnMiLCJwa2ciLCJ2ZXJzaW9uIiwibWFrZVJlcXVlc3QiLCJvcHRpb25zIiwic2Vzc2lvbklkIiwiZnVsbFJlcXVlc3RPcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiX2NyZWF0ZU9wdGlvbnMiLCJlbWl0IiwiX3JlcXVlc3QiLCJjb25uZWN0aW9uUmV0cnlDb3VudCIsInJlcXVlc3RPcHRpb25zIiwiYWdlbnQiLCJwcm90b2NvbCIsInFzIiwicXVlcnlQYXJhbXMiLCJFcnJvciIsInVyaSIsInVybCIsInBhcnNlIiwiaG9zdG5hbWUiLCJwb3J0IiwicGF0aCIsImpvaW4iLCJyZXBsYWNlIiwidXNlciIsImtleSIsImF1dGgiLCJwYXNzIiwidG90YWxSZXRyeUNvdW50IiwicmV0cnlDb3VudCIsImluZm8iLCJocmVmIiwia2V5cyIsImxlbmd0aCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwicmVzcG9uc2UiLCJlcnJvciIsInZhbHVlIiwibWVzc2FnZSIsInJlc3VsdCIsImluY2x1ZGVzIiwid2FybiIsInRoZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHLHFCQUFPLFdBQVAsQ0FBWjtBQUNBLE1BQU1DLE1BQU0sR0FBRztBQUNYQyxFQUFBQSxJQUFJLEVBQUUsSUFBSUEsY0FBS0Ms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QSxhQUFLckMsSUFBTCxDQUFVLFVBQVYsRUFBc0I7QUFBRWdDLFVBQUFBO0FBQUYsU0FBdEI7QUFDQSxlQUFPSCxNQUFNLENBQUNHLEtBQUQsQ0FBYjtBQUNIO0FBRUQ7Ozs7OztBQUlBLFVBQUlWLFVBQVUsSUFBSUQsZUFBZCxJQUFpQ1csS0FBSyxDQUFDRSxPQUFOLENBQWNFLFFBQWQsQ0FBdUIsb0JBQXZCLENBQXJDLEVBQW1GO0FBQy9FL0QsUUFBQUEsR0FBRyxDQUFDMkQsS0FBSixDQUFVLHVCQUFWLEVBQW1DQSxLQUFuQztBQUNBLGFBQUtoQyxJQUFMLENBQVUsVUFBVixFQUFzQjtBQUFFZ0MsVUFBQUE7QUFBRixTQUF0QjtBQUNBLGVBQU9ILE1BQU0sQ0FBQ0csS0FBRCxDQUFiO0FBQ0g7O0FBRUQsUUFBRVYsVUFBRjtBQUNBLFdBQUt0QixJQUFMLENBQVUsT0FBVixFQUFtQjtBQUFFZ0MsUUFBQUEsS0FBRjtBQUFTVixRQUFBQTtBQUFULE9BQW5CO0FBQ0FqRCxNQUFBQSxHQUFHLENBQUNnRSxJQUFKLENBQVMsdUJBQVQsRUFBa0NMLEtBQUssQ0FBQ0UsT0FBeEM7QUFDQTdELE1BQUFBLEdBQUcsQ0FBQ2tELElBQUosQ0FBVSxZQUFXRCxVQUFXLElBQUdELGVBQWdCLEVBQW5EOztBQUNBLFdBQUtwQixRQUFMLENBQWNMLGtCQUFkLEVBQWtDeUIsZUFBbEMsRUFBbURDLFVBQW5ELEVBQStEZ0IsSUFBL0QsQ0FBb0VWLE9BQXBFLEVBQTZFQyxNQUE3RTtBQUNILEtBckN1QyxDQUFqQyxDQUFQO0FBc0NIOztBQXpHc0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXJsIGZyb20gJ3VybCdcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IGh0dHBzIGZyb20gJ2h0dHBzJ1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdCdcbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnXG5cbmltcG9ydCB7IGlzU3VjY2Vzc2Z1bFJlc3BvbnNlIH0gZnJvbSAnLi91dGlscydcbmltcG9ydCBwa2cgZnJvbSAnLi4vcGFja2FnZS5qc29uJ1xuXG5jb25zdCBsb2cgPSBsb2dnZXIoJ3dlYmRyaXZlcicpXG5jb25zdCBhZ2VudHMgPSB7XG4gICAgaHR0cDogbmV3IGh0dHAuQWdlbnQoeyBrZWVwQWxpdmU6IHRydWUgfSksXG4gICAgaHR0cHM6IG5ldyBodHRwcy5BZ2VudCh7IGtlZXBBbGl2ZTogdHJ1ZSB9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXZWJEcml2ZXJSZXF1ZXN0IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAobWV0aG9kLCBlbmRwb2ludCwgYm9keSkge1xuICAgICAgICBzdXBlcigpXG4gICAgICAgIHRoaXMubWV0aG9kID0gbWV0aG9kXG4gICAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludFxuICAgICAgICB0aGlzLnJlcXVpcmVzU2Vzc2lvbklkID0gdGhpcy5lbmRwb2ludC5tYXRjaCgvOnNlc3Npb25JZC8pXG4gICAgICAgIHRoaXMuZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICBib2R5LFxuICAgICAgICAgICAgZm9sbG93QWxsUmVkaXJlY3RzOiB0cnVlLFxuICAgICAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAnQ29ubmVjdGlvbic6ICdrZWVwLWFsaXZlJyxcbiAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICdVc2VyLUFnZW50JzogJ3dlYmRyaXZlci8nICsgcGtnLnZlcnNpb25cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1ha2VSZXF1ZXN0IChvcHRpb25zLCBzZXNzaW9uSWQpIHtcbiAgICAgICAgY29uc3QgZnVsbFJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLmRlZmF1bHRPcHRpb25zLCB0aGlzLl9jcmVhdGVPcHRpb25zKG9wdGlvbnMsIHNlc3Npb25JZCkpXG4gICAgICAgIHRoaXMuZW1pdCgncmVxdWVzdCcsIGZ1bGxSZXF1ZXN0T3B0aW9ucylcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlcXVlc3QoZnVsbFJlcXVlc3RPcHRpb25zLCBvcHRpb25zLmNvbm5lY3Rpb25SZXRyeUNvdW50KVxuICAgIH1cblxuICAgIF9jcmVhdGVPcHRpb25zIChvcHRpb25zLCBzZXNzaW9uSWQpIHtcbiAgICAgICAgY29uc3QgcmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICBhZ2VudDogYWdlbnRzW29wdGlvbnMucHJvdG9jb2xdLFxuICAgICAgICAgICAgaGVhZGVyczogdHlwZW9mIG9wdGlvbnMuaGVhZGVycyA9PT0gJ29iamVjdCcgPyBvcHRpb25zLmhlYWRlcnMgOiB7fSxcbiAgICAgICAgICAgIHFzOiB0eXBlb2YgdGhpcy5kZWZhdWx0T3B0aW9ucy5xdWVyeVBhcmFtcyA9PT0gJ29iamVjdCcgPyBvcHRpb25zLnF1ZXJ5UGFyYW1zIDoge31cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBpZiB3ZSBkb24ndCBoYXZlIGEgc2Vzc2lvbiBpZCB3ZSBzZXQgaXQgaGVyZSwgdW5sZXNzIHdlIGNhbGwgY29tbWFuZHMgdGhhdCBkb24ndCByZXF1aXJlIHNlc3Npb24gaWRzLCBmb3JcbiAgICAgICAgICogZXhhbXBsZSAvc2Vzc2lvbnMuIFRoZSBjYWxsIHRvIC9zZXNzaW9ucyBpcyBub3QgY29ubmVjdGVkIHRvIGEgc2Vzc2lvbiBpdHNlbGYgYW5kIGl0IHRoZXJlZm9yZSBkb2Vzbid0XG4gICAgICAgICAqIHJlcXVpcmUgaXRcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLnJlcXVpcmVzU2Vzc2lvbklkICYmICFzZXNzaW9uSWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQSBzZXNzaW9uSWQgaXMgcmVxdWlyZWQgZm9yIHRoaXMgY29tbWFuZCcpXG4gICAgICAgIH1cblxuICAgICAgICByZXF1ZXN0T3B0aW9ucy51cmkgPSB1cmwucGFyc2UoXG4gICAgICAgICAgICBgJHtvcHRpb25zLnByb3RvY29sfTovL2AgK1xuICAgICAgICAgICAgYCR7b3B0aW9ucy5ob3N0bmFtZX06JHtvcHRpb25zLnBvcnR9YCArXG4gICAgICAgICAgICBwYXRoLmpvaW4oYCR7b3B0aW9ucy5wYXRofSR7dGhpcy5lbmRwb2ludC5yZXBsYWNlKCc6c2Vzc2lvbklkJywgc2Vzc2lvbklkKX1gKVxuICAgICAgICApXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHNlbmQgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMgb25seSB3aGVuIGNyZWF0aW5nIG5ldyBzZXNzaW9uXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5lbmRwb2ludCA9PT0gJy9zZXNzaW9uJyAmJiBvcHRpb25zLnVzZXIgJiYgb3B0aW9ucy5rZXkpIHtcbiAgICAgICAgICAgIHJlcXVlc3RPcHRpb25zLmF1dGggPSB7XG4gICAgICAgICAgICAgICAgdXNlcjogb3B0aW9ucy51c2VyLFxuICAgICAgICAgICAgICAgIHBhc3M6IG9wdGlvbnMua2V5XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVxdWVzdE9wdGlvbnNcbiAgICB9XG5cbiAgICBfcmVxdWVzdCAoZnVsbFJlcXVlc3RPcHRpb25zLCB0b3RhbFJldHJ5Q291bnQgPSAwLCByZXRyeUNvdW50ID0gMCkge1xuICAgICAgICBsb2cuaW5mbyhgWyR7ZnVsbFJlcXVlc3RPcHRpb25zLm1ldGhvZH1dICR7ZnVsbFJlcXVlc3RPcHRpb25zLnVyaS5ocmVmfWApXG5cbiAgICAgICAgaWYgKGZ1bGxSZXF1ZXN0T3B0aW9ucy5ib2R5ICYmIE9iamVjdC5rZXlzKGZ1bGxSZXF1ZXN0T3B0aW9ucy5ib2R5KS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKCdEQVRBJywgZnVsbFJlcXVlc3RPcHRpb25zLmJvZHkpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gcmVxdWVzdChmdWxsUmVxdWVzdE9wdGlvbnMsIChlcnIsIHJlc3BvbnNlLCBib2R5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihlcnIgfHwgKGJvZHkgJiYgYm9keS52YWx1ZSA/IGJvZHkudmFsdWUubWVzc2FnZSA6IGJvZHkpKVxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIFJlc29sdmUgb25seSBpZiBzdWNjZXNzZnVsIHJlc3BvbnNlXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmICghZXJyICYmIGlzU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3BvbnNlKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgncmVzcG9uc2UnLCB7IHJlc3VsdDogYm9keSB9KVxuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGJvZHkpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogIHN0b3AgcmV0cnlpbmcgYXMgdGhpcyB3aWxsIG5ldmVyIGJlIHN1Y2Nlc3NmdWwuXG4gICAgICAgICAgICAgKiAgd2Ugd2lsbCBoYW5kbGUgdGhpcyBhdCB0aGUgZWxlbWVudEVycm9ySGFuZGxlclxuICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgIGlmKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ3N0YWxlIGVsZW1lbnQgcmVmZXJlbmNlJykpIHtcbiAgICAgICAgICAgICAgICBsb2cud2FybignUmVxdWVzdCBlbmNvdW50ZXJlZCBhIHN0YWxlIGVsZW1lbnQgLSB0ZXJtaW5hdGluZyByZXF1ZXN0JylcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3Jlc3BvbnNlJywgeyBlcnJvciB9KVxuICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogc3RvcCByZXRyeWluZyBpZiB0b3RhbFJldHJ5Q291bnQgd2FzIGV4Y2VlZGVkIG9yIHRoZXJlIGlzIG5vIHJlYXNvbiB0b1xuICAgICAgICAgICAgICogcmV0cnksIGUuZy4gaWYgc2Vzc2lvbklkIGlzIGludmFsaWRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKHJldHJ5Q291bnQgPj0gdG90YWxSZXRyeUNvdW50IHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ2ludmFsaWQgc2Vzc2lvbiBpZCcpKSB7XG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKCdSZXF1ZXN0IGZhaWxlZCBkdWUgdG8nLCBlcnJvcilcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3Jlc3BvbnNlJywgeyBlcnJvciB9KVxuICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICsrcmV0cnlDb3VudFxuICAgICAgICAgICAgdGhpcy5lbWl0KCdyZXRyeScsIHsgZXJyb3IsIHJldHJ5Q291bnQgfSlcbiAgICAgICAgICAgIGxvZy53YXJuKCdSZXF1ZXN0IGZhaWxlZCBkdWUgdG8nLCBlcnJvci5tZXNzYWdlKVxuICAgICAgICAgICAgbG9nLmluZm8oYFJldHJ5aW5nICR7cmV0cnlDb3VudH0vJHt0b3RhbFJldHJ5Q291bnR9YClcbiAgICAgICAgICAgIHRoaXMuX3JlcXVlc3QoZnVsbFJlcXVlc3RPcHRpb25zLCB0b3RhbFJldHJ5Q291bnQsIHJldHJ5Q291bnQpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KVxuICAgICAgICB9KSlcbiAgICB9XG59XG4iXX0=