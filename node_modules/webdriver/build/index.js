"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "webdriverMonad", {
  enumerable: true,
  get: function () {
    return _monad.default;
  }
});
Object.defineProperty(exports, "getPrototype", {
  enumerable: true,
  get: function () {
    return _utils.getPrototype;
  }
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _config = require("@wdio/config");

var _monad = _interopRequireDefault(require("./monad"));

var _request = _interopRequireDefault(require("./request"));

var _constants = require("./constants");

var _utils = require("./utils");

var _webdriver = _interopRequireDefault(require("../protocol/webdriver.json"));

var _jsonwp = _interopRequireDefault(require("../protocol/jsonwp.json"));

var _mjsonwp = _interopRequireDefault(require("../protocol/mjsonwp.json"));

var _appium = _interopRequireDefault(require("../protocol/appium.json"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class WebDriver {
  static async newSession(options = {}, modifier, proto = {}, commandWrapper) {
    const params = (0, _config.validateConfig)(_constants.DEFAULTS, options);

    _logger.default.setLevel('webdriver', params.logLevel);
    /**
     * the user could have passed in either w3c style or jsonwp style caps
     * and we want to pass both styles to the server, which means we need
     * to check what style the user sent in so we know how to construct the
     * object for the other style
     */


    const [w3cCaps, jsonwpCaps] = params.capabilities && params.capabilities.alwaysMatch
    /**
     * in case W3C compliant capabilities are provided
     */
    ? [params.capabilities, params.capabilities.alwaysMatch]
    /**
     * otherwise assume they passed in jsonwp-style caps (flat object)
     */
    : [{
      alwaysMatch: params.capabilities,
      firstMatch: [{}]
    }, params.capabilities];
    const sessionRequest = new _request.default('POST', '/session', {
      capabilities: w3cCaps,
      // W3C compliant
      desiredCapabilities: jsonwpCaps // JSONWP compliant

    });
    const response = await sessionRequest.makeRequest(params);
    /**
     * save original set of capabilities to allow to request the same session again
     * (e.g. for reloadSession command in WebdriverIO)
     */

    params.requestedCapabilities = {
      w3cCaps,
      jsonwpCaps
      /**
       * save actual receveived session details
       */

    };
    params.capabilities = response.value.capabilities || response.value;
    params.isW3C = (0, _utils.isW3CSession)(response.value);
    const prototype = Object.assign((0, _utils.getPrototype)(params.isW3C), proto);
    const monad = (0, _monad.default)(params, modifier, prototype);
    return monad(response.value.sessionId || response.sessionId, commandWrapper);
  }
  /**
   * allows user to attach to existing sessions
   */


  static attachToSession(options = {}, modifier, proto = {}, commandWrapper) {
    if (typeof options.sessionId !== 'string') {
      throw new Error('sessionId is required to attach to existing session');
    }

    _logger.default.setLevel('webdriver', options.logLevel);

    options.capabilities = options.capabilities || {};
    options.isW3C = options.isW3C || true;
    const prototype = Object.assign((0, _utils.getPrototype)(options.isW3C), proto);
    const monad = (0, _monad.default)(options, modifier, prototype);
    return monad(options.sessionId, commandWrapper);
  }

  static get WebDriver() {
    return WebDriver;
  }

  static get DEFAULTS() {
    return _constants.DEFAULTS;
  }
  /**
   * Protocols
   */


  static get WebDriverProtocol() {
    return _webdriver.default;
  }

  static get JsonWProtocol() {
    return _jsonwp.default;
  }

  static get MJsonWProtocol() {
    return _mjsonwp.default;
  }

  static get AppiumProtocol() {
    return _appium.default;
  }

}
/**
 * Helper methods consumed by webdriverio package
 */


exports.default = WebDriver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJXZWJEcml2ZXIiLCJuZXdTZXNzaW9uIiwib3B0aW9ucyIsIm1vZGlmaWVyIiwicHJvdG8iLCJjb21tYW5kV3JhcHBlciIsInBhcmFtcyIsIkRFRkFVTFRTIiwibG9nZ2VyIiwic2V0TGV2ZWwiLCJsb2dMZXZlbCIsInczY0NhcHMiLCJqc29ud3BDYXBzIiwiY2FwYWJpbGl0aWVzIiwiYWx3YXlzTWF0Y2giLCJmaXJzdE1hdGNoIiwic2Vzc2lvblJlcXVlc3QiLCJXZWJEcml2ZXJSZXF1ZXN0IiwiZGVzaXJlZENhcGFiaWxpdGllcyIsInJlc3BvbnNlIiwibWFrZVJlcXVlc3QiLCJyZXF1ZXN0ZWRDYXBhYmlsaXRpZXMiLCJ2YWx1ZSIsImlzVzNDIiwicHJvdG90eXBlIiwiT2JqZWN0IiwiYXNzaWduIiwibW9uYWQiLCJzZXNzaW9uSWQiLCJhdHRhY2hUb1Nlc3Npb24iLCJFcnJvciIsIldlYkRyaXZlclByb3RvY29sIiwiSnNvbldQcm90b2NvbCIsIk1Kc29uV1Byb3RvY29sIiwiQXBwaXVtUHJvdG9jb2wiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRWUsTUFBTUEsU0FBTixDQUFnQjtBQUMzQixlQUFhQyxVQUFiLENBQXlCQyxPQUFPLEdBQUcsRUFBbkMsRUFBdUNDLFFBQXZDLEVBQWlEQyxLQUFLLEdBQUcsRUFBekQsRUFBNkRDLGNBQTdELEVBQTZFO0FBQ3pFLFVBQU1DLE1BQU0sR0FBRyw0QkFBZUMsbUJBQWYsRUFBeUJMLE9BQXpCLENBQWY7O0FBQ0FNLG9CQUFPQyxRQUFQLENBQWdCLFdBQWhCLEVBQTZCSCxNQUFNLENBQUNJLFFBQXBDO0FBRUE7Ozs7Ozs7O0FBTUEsVUFBTSxDQUFDQyxPQUFELEVBQVVDLFVBQVYsSUFBd0JOLE1BQU0sQ0FBQ08sWUFBUCxJQUF1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QUFQO0FBQ0g7O0FBQ0QsYUFBV0MsY0FBWCxHQUE2QjtBQUN6QixXQUFPQSxlQUFQO0FBQ0g7O0FBckYwQjtBQXdGL0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCB7IHZhbGlkYXRlQ29uZmlnIH0gZnJvbSAnQHdkaW8vY29uZmlnJ1xuXG5pbXBvcnQgd2ViZHJpdmVyTW9uYWQgZnJvbSAnLi9tb25hZCdcbmltcG9ydCBXZWJEcml2ZXJSZXF1ZXN0IGZyb20gJy4vcmVxdWVzdCdcbmltcG9ydCB7IERFRkFVTFRTIH0gZnJvbSAnLi9jb25zdGFudHMnXG5pbXBvcnQgeyBnZXRQcm90b3R5cGUsIGlzVzNDU2Vzc2lvbiB9IGZyb20gJy4vdXRpbHMnXG5cbmltcG9ydCBXZWJEcml2ZXJQcm90b2NvbCBmcm9tICcuLi9wcm90b2NvbC93ZWJkcml2ZXIuanNvbidcbmltcG9ydCBKc29uV1Byb3RvY29sIGZyb20gJy4uL3Byb3RvY29sL2pzb253cC5qc29uJ1xuaW1wb3J0IE1Kc29uV1Byb3RvY29sIGZyb20gJy4uL3Byb3RvY29sL21qc29ud3AuanNvbidcbmltcG9ydCBBcHBpdW1Qcm90b2NvbCBmcm9tICcuLi9wcm90b2NvbC9hcHBpdW0uanNvbidcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2ViRHJpdmVyIHtcbiAgICBzdGF0aWMgYXN5bmMgbmV3U2Vzc2lvbiAob3B0aW9ucyA9IHt9LCBtb2RpZmllciwgcHJvdG8gPSB7fSwgY29tbWFuZFdyYXBwZXIpIHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gdmFsaWRhdGVDb25maWcoREVGQVVMVFMsIG9wdGlvbnMpXG4gICAgICAgIGxvZ2dlci5zZXRMZXZlbCgnd2ViZHJpdmVyJywgcGFyYW1zLmxvZ0xldmVsKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiB0aGUgdXNlciBjb3VsZCBoYXZlIHBhc3NlZCBpbiBlaXRoZXIgdzNjIHN0eWxlIG9yIGpzb253cCBzdHlsZSBjYXBzXG4gICAgICAgICAqIGFuZCB3ZSB3YW50IHRvIHBhc3MgYm90aCBzdHlsZXMgdG8gdGhlIHNlcnZlciwgd2hpY2ggbWVhbnMgd2UgbmVlZFxuICAgICAgICAgKiB0byBjaGVjayB3aGF0IHN0eWxlIHRoZSB1c2VyIHNlbnQgaW4gc28gd2Uga25vdyBob3cgdG8gY29uc3RydWN0IHRoZVxuICAgICAgICAgKiBvYmplY3QgZm9yIHRoZSBvdGhlciBzdHlsZVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgW3czY0NhcHMsIGpzb253cENhcHNdID0gcGFyYW1zLmNhcGFiaWxpdGllcyAmJiBwYXJhbXMuY2FwYWJpbGl0aWVzLmFsd2F5c01hdGNoXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGluIGNhc2UgVzNDIGNvbXBsaWFudCBjYXBhYmlsaXRpZXMgYXJlIHByb3ZpZGVkXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgID8gW3BhcmFtcy5jYXBhYmlsaXRpZXMsIHBhcmFtcy5jYXBhYmlsaXRpZXMuYWx3YXlzTWF0Y2hdXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIG90aGVyd2lzZSBhc3N1bWUgdGhleSBwYXNzZWQgaW4ganNvbndwLXN0eWxlIGNhcHMgKGZsYXQgb2JqZWN0KVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICA6IFt7IGFsd2F5c01hdGNoOiBwYXJhbXMuY2FwYWJpbGl0aWVzLCBmaXJzdE1hdGNoOiBbe31dIH0sIHBhcmFtcy5jYXBhYmlsaXRpZXNdXG5cbiAgICAgICAgY29uc3Qgc2Vzc2lvblJlcXVlc3QgPSBuZXcgV2ViRHJpdmVyUmVxdWVzdChcbiAgICAgICAgICAgICdQT1NUJyxcbiAgICAgICAgICAgICcvc2Vzc2lvbicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiB3M2NDYXBzLCAvLyBXM0MgY29tcGxpYW50XG4gICAgICAgICAgICAgICAgZGVzaXJlZENhcGFiaWxpdGllczoganNvbndwQ2FwcyAvLyBKU09OV1AgY29tcGxpYW50XG4gICAgICAgICAgICB9XG4gICAgICAgIClcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlc3Npb25SZXF1ZXN0Lm1ha2VSZXF1ZXN0KHBhcmFtcylcbiAgICAgICAgLyoqXG4gICAgICAgICAqIHNhdmUgb3JpZ2luYWwgc2V0IG9mIGNhcGFiaWxpdGllcyB0byBhbGxvdyB0byByZXF1ZXN0IHRoZSBzYW1lIHNlc3Npb24gYWdhaW5cbiAgICAgICAgICogKGUuZy4gZm9yIHJlbG9hZFNlc3Npb24gY29tbWFuZCBpbiBXZWJkcml2ZXJJTylcbiAgICAgICAgICovXG4gICAgICAgIHBhcmFtcy5yZXF1ZXN0ZWRDYXBhYmlsaXRpZXMgPSB7IHczY0NhcHMsIGpzb253cENhcHMgfVxuICAgICAgICAvKipcbiAgICAgICAgICogc2F2ZSBhY3R1YWwgcmVjZXZlaXZlZCBzZXNzaW9uIGRldGFpbHNcbiAgICAgICAgICovXG4gICAgICAgIHBhcmFtcy5jYXBhYmlsaXRpZXMgPSByZXNwb25zZS52YWx1ZS5jYXBhYmlsaXRpZXMgfHwgcmVzcG9uc2UudmFsdWVcbiAgICAgICAgcGFyYW1zLmlzVzNDID0gaXNXM0NTZXNzaW9uKHJlc3BvbnNlLnZhbHVlKVxuXG4gICAgICAgIGNvbnN0IHByb3RvdHlwZSA9IE9iamVjdC5hc3NpZ24oZ2V0UHJvdG90eXBlKHBhcmFtcy5pc1czQyksIHByb3RvKVxuICAgICAgICBjb25zdCBtb25hZCA9IHdlYmRyaXZlck1vbmFkKHBhcmFtcywgbW9kaWZpZXIsIHByb3RvdHlwZSlcbiAgICAgICAgcmV0dXJuIG1vbmFkKHJlc3BvbnNlLnZhbHVlLnNlc3Npb25JZCB8fCByZXNwb25zZS5zZXNzaW9uSWQsIGNvbW1hbmRXcmFwcGVyKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGFsbG93cyB1c2VyIHRvIGF0dGFjaCB0byBleGlzdGluZyBzZXNzaW9uc1xuICAgICAqL1xuICAgIHN0YXRpYyBhdHRhY2hUb1Nlc3Npb24gKG9wdGlvbnMgPSB7fSwgbW9kaWZpZXIsIHByb3RvID0ge30sIGNvbW1hbmRXcmFwcGVyKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5zZXNzaW9uSWQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Nlc3Npb25JZCBpcyByZXF1aXJlZCB0byBhdHRhY2ggdG8gZXhpc3Rpbmcgc2Vzc2lvbicpXG4gICAgICAgIH1cblxuICAgICAgICBsb2dnZXIuc2V0TGV2ZWwoJ3dlYmRyaXZlcicsIG9wdGlvbnMubG9nTGV2ZWwpXG5cbiAgICAgICAgb3B0aW9ucy5jYXBhYmlsaXRpZXMgPSBvcHRpb25zLmNhcGFiaWxpdGllcyB8fCB7fVxuICAgICAgICBvcHRpb25zLmlzVzNDID0gb3B0aW9ucy5pc1czQyB8fCB0cnVlXG4gICAgICAgIGNvbnN0IHByb3RvdHlwZSA9IE9iamVjdC5hc3NpZ24oZ2V0UHJvdG90eXBlKG9wdGlvbnMuaXNXM0MpLCBwcm90bylcbiAgICAgICAgY29uc3QgbW9uYWQgPSB3ZWJkcml2ZXJNb25hZChvcHRpb25zLCBtb2RpZmllciwgcHJvdG90eXBlKVxuICAgICAgICByZXR1cm4gbW9uYWQob3B0aW9ucy5zZXNzaW9uSWQsIGNvbW1hbmRXcmFwcGVyKVxuICAgIH1cblxuICAgIHN0YXRpYyBnZXQgV2ViRHJpdmVyICgpIHtcbiAgICAgICAgcmV0dXJuIFdlYkRyaXZlclxuICAgIH1cbiAgICBzdGF0aWMgZ2V0IERFRkFVTFRTICgpIHtcbiAgICAgICAgcmV0dXJuIERFRkFVTFRTXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJvdG9jb2xzXG4gICAgICovXG4gICAgc3RhdGljIGdldCBXZWJEcml2ZXJQcm90b2NvbCAoKSB7XG4gICAgICAgIHJldHVybiBXZWJEcml2ZXJQcm90b2NvbFxuICAgIH1cbiAgICBzdGF0aWMgZ2V0IEpzb25XUHJvdG9jb2wgKCkge1xuICAgICAgICByZXR1cm4gSnNvbldQcm90b2NvbFxuICAgIH1cbiAgICBzdGF0aWMgZ2V0IE1Kc29uV1Byb3RvY29sICgpIHtcbiAgICAgICAgcmV0dXJuIE1Kc29uV1Byb3RvY29sXG4gICAgfVxuICAgIHN0YXRpYyBnZXQgQXBwaXVtUHJvdG9jb2wgKCkge1xuICAgICAgICByZXR1cm4gQXBwaXVtUHJvdG9jb2xcbiAgICB9XG59XG5cbi8qKlxuICogSGVscGVyIG1ldGhvZHMgY29uc3VtZWQgYnkgd2ViZHJpdmVyaW8gcGFja2FnZVxuICovXG5leHBvcnQge1xuICAgIHdlYmRyaXZlck1vbmFkLFxuICAgIGdldFByb3RvdHlwZVxufVxuIl19