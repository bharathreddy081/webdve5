"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isSuccessfulResponse = isSuccessfulResponse;
exports.isValidParameter = isValidParameter;
exports.getPrototype = getPrototype;
exports.commandCallStructure = commandCallStructure;
exports.isW3CSession = isW3CSession;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _command = _interopRequireDefault(require("./command"));

var _webdriver = _interopRequireDefault(require("../protocol/webdriver.json"));

var _mjsonwp = _interopRequireDefault(require("../protocol/mjsonwp.json"));

var _jsonwp = _interopRequireDefault(require("../protocol/jsonwp.json"));

var _appium = _interopRequireDefault(require("../protocol/appium.json"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('webdriver');
/**
 * check if WebDriver requests was successful
 * @param  {Object}  body  body payload of response
 * @return {Boolean}       true if request was successful
 */

function isSuccessfulResponse({
  body,
  statusCode
} = {}) {
  /**
   * response contains a body
   */
  if (!body || typeof body.value === 'undefined') {
    log.debug('request failed due to missing body');
    return false;
  }
  /**
   * ignore failing element request to enable lazy loading capability
   */


  if (body.status && body.status === 7 && body.value.message && body.value.message.startsWith('no such element')) {
    return true;
  }
  /**
   * if it has a status property, it should be 0
   * (just here to stay backwards compatible to the jsonwire protocol)
   */


  if (body.status && body.status !== 0) {
    log.debug(`request failed due to status ${body.status}`);
    return false;
  }

  const hasErrorResponse = body.value && (body.value.error || body.value.stackTrace || body.value.stacktrace);
  /**
   * check status code
   */

  if (statusCode === 200 && !hasErrorResponse) {
    return true;
  }
  /**
   * if an element was not found we don't flag it as failed request because
   * we lazy load it
   */


  if (statusCode === 404 && body.value && body.value.error === 'no such element') {
    return true;
  }
  /**
   * that has no error property (Appium only)
   */


  if (hasErrorResponse) {
    log.debug('request failed due to response error:', body.value.error);
    return false;
  }

  return true;
}
/**
 * checks if command argument is valid according to specificiation
 *
 * @param  {*}       arg           command argument
 * @param  {Object}  expectedType  parameter type (e.g. `number`, `string[]` or `(number|string)`)
 * @return {Boolean}               true if argument is valid
 */


function isValidParameter(arg, expectedType) {
  let shouldBeArray = false;

  if (expectedType.slice(-2) === '[]') {
    expectedType = expectedType.slice(0, -2);
    shouldBeArray = true;
  }
  /**
   * check type of each individual array element
   */


  if (shouldBeArray) {
    if (!Array.isArray(arg)) {
      return false;
    }
  } else {
    /**
     * transform to array to have a unified check
     */
    arg = [arg];
  }

  for (const argEntity of arg) {
    if (!(typeof argEntity).match(expectedType)) {
      return false;
    }
  }

  return true;
}
/**
 * creates the base prototype for the webdriver monad
 */


function getPrototype(isW3C) {
  const prototype = {};
  const ProtocolCommands = Object.assign(isW3C ? _webdriver.default : _jsonwp.default, _mjsonwp.default, _appium.default);

  for (const [endpoint, methods] of Object.entries(ProtocolCommands)) {
    for (const [method, commandData] of Object.entries(methods)) {
      prototype[commandData.command] = {
        value: (0, _command.default)(method, endpoint, commandData)
      };
    }
  }

  return prototype;
}
/**
 * get command call structure
 * (for logging purposes)
 */


function commandCallStructure(commandName, args) {
  const callArgs = args.map(arg => {
    if (typeof arg === 'string') {
      arg = `"${arg}"`;
    } else if (typeof arg === 'function') {
      arg = '<fn>';
    } else if (arg === null) {
      arg = 'null';
    } else if (typeof arg === 'object') {
      arg = '<object>';
    } else if (typeof arg === 'undefined') {
      arg = typeof arg;
    }

    return arg;
  }).join(', ');
  return `${commandName}(${callArgs})`;
}
/**
 * check if session is based on W3C protocol based on the /session response
 * @param  {Object}  capabilities  caps of session response
 * @return {Boolean}               true if W3C (browser)
 */


function isW3CSession({
  capabilities
}) {
  /**
   * JSONWire protocol doesn't return a property `capabilities`.
   * Also check for Appium response as it is using JSONWire protocol for most of the part.
   */
  if (!capabilities) {
    return false;
  }
  /**
   * assume session to be a WebDriver session when
   * - capabilities are returned
   *   (https://w3c.github.io/webdriver/#dfn-new-sessions)
   * - platformName is returned which is not defined in the JSONWire protocol
   */


  const isAppium = capabilities.automationName || capabilities.deviceName;
  return Boolean(capabilities.platformName || isAppium);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJsb2ciLCJpc1N1Y2Nlc3NmdWxSZXNwb25zZSIsImJvZHkiLCJzdGF0dXNDb2RlIiwidmFsdWUiLCJkZWJ1ZyIsInN0YXR1cyIsIm1lc3NhZ2UiLCJzdGFydHNXaXRoIiwiaGFzRXJyb3JSZXNwb25zZSIsImVycm9yIiwic3RhY2tUcmFjZSIsInN0YWNrdHJhY2UiLCJpc1ZhbGlkUGFyYW1ldGVyIiwiYXJnIiwiZXhwZWN0ZWRUeXBlIiwic2hvdWxkQmVBcnJheSIsInNsaWNlIiwiQXJyYXkiLCJpc0FycmF5IiwiYXJnRW50aXR5IiwibWF0Y2giLCJnZXRQcm90b3R5cGUiLCJpc1czQyIsInByb3RvdHlwZSIsIlByb3RvY29sQ29tbWFuZHMiLCJPYmplY3QiLCJhc3NpZ24iLCJXZWJEcml2ZXJQcm90b2NvbCIsIkpzb25XUHJvdG9jb2wiLCJNSnNvbldQcm90b2NvbCIsIkFwcGl1bVByb3RvY29sIiwiZW5kcG9pbnQiLCJtZXRob2RzIiwiZW50cmllcyIsIm1ldGhvZCIsImNvbW1hbmREYXRhIiwiY29tbWFuZCIsImNvbW1hbmRDYWxsU3RydWN0dXJlIiwiY29tbWFuZE5hbWUiLCJhcmdzIiwiY2FsbEFyZ3MiLCJtYXAiLCJqb2luIiwiaXNXM0NTZXNzaW9uIiwiY2FwYWJpbGl0aWVzIiwiaXNBcHBpdW0iLCJhdXRvbWF0aW9uTmFtZSIsImRldmljZU5hbWUiLCJCb29sZWFuIiwicGxhdGZvcm1OYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUcscUJBQU8sV0FBUCxDQUFaO0FBRUE7Ozs7OztBQUtPLFNBQVNDLG9CQUFULENBQStCO0FBQUVDLEVBQUFBLElBQUY7QUFBUUMsRUFBQUE7QUFBUixJQUF1QixFQUF0RCxFQUEwRDtBQUM3RDs7O0FBR0EsTUFBSSxDQUFDRCxJQUFELElBQVMsT0FBT0Es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QXNCO0FBQUVDLEVBQUFBO0FBQUYsQ0FBdEIsRUFBd0M7QUFDM0M7Ozs7QUFJQSxNQUFJLENBQUNBLFlBQUwsRUFBbUI7QUFDZixXQUFPLEtBQVA7QUFDSDtBQUVEOzs7Ozs7OztBQU1BLFFBQU1DLFFBQVEsR0FBR0QsWUFBWSxDQUFDRSxjQUFiLElBQStCRixZQUFZLENBQUNHLFVBQTdEO0FBQ0EsU0FBT0MsT0FBTyxDQUFDSixZQUFZLENBQUNLLFlBQWIsSUFBNkJKLFFBQTlCLENBQWQ7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuXG5pbXBvcnQgY29tbWFuZCBmcm9tICcuL2NvbW1hbmQnXG5pbXBvcnQgV2ViRHJpdmVyUHJvdG9jb2wgZnJvbSAnLi4vcHJvdG9jb2wvd2ViZHJpdmVyLmpzb24nXG5pbXBvcnQgTUpzb25XUHJvdG9jb2wgZnJvbSAnLi4vcHJvdG9jb2wvbWpzb253cC5qc29uJ1xuaW1wb3J0IEpzb25XUHJvdG9jb2wgZnJvbSAnLi4vcHJvdG9jb2wvanNvbndwLmpzb24nXG5pbXBvcnQgQXBwaXVtUHJvdG9jb2wgZnJvbSAnLi4vcHJvdG9jb2wvYXBwaXVtLmpzb24nXG5cbmNvbnN0IGxvZyA9IGxvZ2dlcignd2ViZHJpdmVyJylcblxuLyoqXG4gKiBjaGVjayBpZiBXZWJEcml2ZXIgcmVxdWVzdHMgd2FzIHN1Y2Nlc3NmdWxcbiAqIEBwYXJhbSAge09iamVjdH0gIGJvZHkgIGJvZHkgcGF5bG9hZCBvZiByZXNwb25zZVxuICogQHJldHVybiB7Qm9vbGVhbn0gICAgICAgdHJ1ZSBpZiByZXF1ZXN0IHdhcyBzdWNjZXNzZnVsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1N1Y2Nlc3NmdWxSZXNwb25zZSAoeyBib2R5LCBzdGF0dXNDb2RlIH0gPSB7fSkge1xuICAgIC8qKlxuICAgICAqIHJlc3BvbnNlIGNvbnRhaW5zIGEgYm9keVxuICAgICAqL1xuICAgIGlmICghYm9keSB8fCB0eXBlb2YgYm9keS52YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdyZXF1ZXN0IGZhaWxlZCBkdWUgdG8gbWlzc2luZyBib2R5JylcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaWdub3JlIGZhaWxpbmcgZWxlbWVudCByZXF1ZXN0IHRvIGVuYWJsZSBsYXp5IGxvYWRpbmcgY2FwYWJpbGl0eVxuICAgICAqL1xuICAgIGlmIChib2R5LnN0YXR1cyAmJiBib2R5LnN0YXR1cyA9PT0gNyAmJiBib2R5LnZhbHVlLm1lc3NhZ2UgJiYgYm9keS52YWx1ZS5tZXNzYWdlLnN0YXJ0c1dpdGgoJ25vIHN1Y2ggZWxlbWVudCcpKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaWYgaXQgaGFzIGEgc3RhdHVzIHByb3BlcnR5LCBpdCBzaG91bGQgYmUgMFxuICAgICAqIChqdXN0IGhlcmUgdG8gc3RheSBiYWNrd2FyZHMgY29tcGF0aWJsZSB0byB0aGUganNvbndpcmUgcHJvdG9jb2wpXG4gICAgICovXG4gICAgaWYgKGJvZHkuc3RhdHVzICYmIGJvZHkuc3RhdHVzICE9PSAwKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgcmVxdWVzdCBmYWlsZWQgZHVlIHRvIHN0YXR1cyAke2JvZHkuc3RhdHVzfWApXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGNvbnN0IGhhc0Vycm9yUmVzcG9uc2UgPSBib2R5LnZhbHVlICYmIChib2R5LnZhbHVlLmVycm9yIHx8IGJvZHkudmFsdWUuc3RhY2tUcmFjZSB8fCBib2R5LnZhbHVlLnN0YWNrdHJhY2UpXG5cbiAgICAvKipcbiAgICAgKiBjaGVjayBzdGF0dXMgY29kZVxuICAgICAqL1xuICAgIGlmIChzdGF0dXNDb2RlID09PSAyMDAgJiYgIWhhc0Vycm9yUmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBpZiBhbiBlbGVtZW50IHdhcyBub3QgZm91bmQgd2UgZG9uJ3QgZmxhZyBpdCBhcyBmYWlsZWQgcmVxdWVzdCBiZWNhdXNlXG4gICAgICogd2UgbGF6eSBsb2FkIGl0XG4gICAgICovXG4gICAgaWYgKHN0YXR1c0NvZGUgPT09IDQwNCAmJiBib2R5LnZhbHVlICYmIGJvZHkudmFsdWUuZXJyb3IgPT09ICdubyBzdWNoIGVsZW1lbnQnKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogdGhhdCBoYXMgbm8gZXJyb3IgcHJvcGVydHkgKEFwcGl1bSBvbmx5KVxuICAgICAqL1xuICAgIGlmIChoYXNFcnJvclJlc3BvbnNlKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygncmVxdWVzdCBmYWlsZWQgZHVlIHRvIHJlc3BvbnNlIGVycm9yOicsIGJvZHkudmFsdWUuZXJyb3IpXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlXG59XG5cbi8qKlxuICogY2hlY2tzIGlmIGNvbW1hbmQgYXJndW1lbnQgaXMgdmFsaWQgYWNjb3JkaW5nIHRvIHNwZWNpZmljaWF0aW9uXG4gKlxuICogQHBhcmFtICB7Kn0gICAgICAgYXJnICAgICAgICAgICBjb21tYW5kIGFyZ3VtZW50XG4gKiBAcGFyYW0gIHtPYmplY3R9ICBleHBlY3RlZFR5cGUgIHBhcmFtZXRlciB0eXBlIChlLmcuIGBudW1iZXJgLCBgc3RyaW5nW11gIG9yIGAobnVtYmVyfHN0cmluZylgKVxuICogQHJldHVybiB7Qm9vbGVhbn0gICAgICAgICAgICAgICB0cnVlIGlmIGFyZ3VtZW50IGlzIHZhbGlkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1ZhbGlkUGFyYW1ldGVyIChhcmcsIGV4cGVjdGVkVHlwZSkge1xuICAgIGxldCBzaG91bGRCZUFycmF5ID0gZmFsc2VcblxuICAgIGlmIChleHBlY3RlZFR5cGUuc2xpY2UoLTIpID09PSAnW10nKSB7XG4gICAgICAgIGV4cGVjdGVkVHlwZSA9IGV4cGVjdGVkVHlwZS5zbGljZSgwLCAtMilcbiAgICAgICAgc2hvdWxkQmVBcnJheSA9IHRydWVcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBjaGVjayB0eXBlIG9mIGVhY2ggaW5kaXZpZHVhbCBhcnJheSBlbGVtZW50XG4gICAgICovXG4gICAgaWYgKHNob3VsZEJlQXJyYXkpIHtcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGFyZykpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIHRyYW5zZm9ybSB0byBhcnJheSB0byBoYXZlIGEgdW5pZmllZCBjaGVja1xuICAgICAgICAgKi9cbiAgICAgICAgYXJnID0gW2FyZ11cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGFyZ0VudGl0eSBvZiBhcmcpIHtcbiAgICAgICAgaWYgKCEodHlwZW9mIGFyZ0VudGl0eSkubWF0Y2goZXhwZWN0ZWRUeXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZVxufVxuXG4vKipcbiAqIGNyZWF0ZXMgdGhlIGJhc2UgcHJvdG90eXBlIGZvciB0aGUgd2ViZHJpdmVyIG1vbmFkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm90b3R5cGUgKGlzVzNDKSB7XG4gICAgY29uc3QgcHJvdG90eXBlID0ge31cbiAgICBjb25zdCBQcm90b2NvbENvbW1hbmRzID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgaXNXM0MgPyBXZWJEcml2ZXJQcm90b2NvbCA6IEpzb25XUHJvdG9jb2wsXG4gICAgICAgIE1Kc29uV1Byb3RvY29sLFxuICAgICAgICBBcHBpdW1Qcm90b2NvbFxuICAgIClcblxuICAgIGZvciAoY29uc3QgW2VuZHBvaW50LCBtZXRob2RzXSBvZiBPYmplY3QuZW50cmllcyhQcm90b2NvbENvbW1hbmRzKSkge1xuICAgICAgICBmb3IgKGNvbnN0IFttZXRob2QsIGNvbW1hbmREYXRhXSBvZiBPYmplY3QuZW50cmllcyhtZXRob2RzKSkge1xuICAgICAgICAgICAgcHJvdG90eXBlW2NvbW1hbmREYXRhLmNvbW1hbmRdID0geyB2YWx1ZTogY29tbWFuZChtZXRob2QsIGVuZHBvaW50LCBjb21tYW5kRGF0YSkgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb3RvdHlwZVxufVxuXG4vKipcbiAqIGdldCBjb21tYW5kIGNhbGwgc3RydWN0dXJlXG4gKiAoZm9yIGxvZ2dpbmcgcHVycG9zZXMpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21tYW5kQ2FsbFN0cnVjdHVyZSAoY29tbWFuZE5hbWUsIGFyZ3MpIHtcbiAgICBjb25zdCBjYWxsQXJncyA9IGFyZ3MubWFwKChhcmcpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBhcmcgPSBgXCIke2FyZ31cImBcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBhcmcgPSAnPGZuPidcbiAgICAgICAgfSBlbHNlIGlmIChhcmcgPT09IG51bGwpIHtcbiAgICAgICAgICAgIGFyZyA9ICdudWxsJ1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICBhcmcgPSAnPG9iamVjdD4nXG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGFyZyA9IHR5cGVvZiBhcmdcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhcmdcbiAgICB9KS5qb2luKCcsICcpXG5cbiAgICByZXR1cm4gYCR7Y29tbWFuZE5hbWV9KCR7Y2FsbEFyZ3N9KWBcbn1cblxuLyoqXG4gKiBjaGVjayBpZiBzZXNzaW9uIGlzIGJhc2VkIG9uIFczQyBwcm90b2NvbCBiYXNlZCBvbiB0aGUgL3Nlc3Npb24gcmVzcG9uc2VcbiAqIEBwYXJhbSAge09iamVjdH0gIGNhcGFiaWxpdGllcyAgY2FwcyBvZiBzZXNzaW9uIHJlc3BvbnNlXG4gKiBAcmV0dXJuIHtCb29sZWFufSAgICAgICAgICAgICAgIHRydWUgaWYgVzNDIChicm93c2VyKVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNXM0NTZXNzaW9uKHsgY2FwYWJpbGl0aWVzIH0pIHtcbiAgICAvKipcbiAgICAgKiBKU09OV2lyZSBwcm90b2NvbCBkb2Vzbid0IHJldHVybiBhIHByb3BlcnR5IGBjYXBhYmlsaXRpZXNgLlxuICAgICAqIEFsc28gY2hlY2sgZm9yIEFwcGl1bSByZXNwb25zZSBhcyBpdCBpcyB1c2luZyBKU09OV2lyZSBwcm90b2NvbCBmb3IgbW9zdCBvZiB0aGUgcGFydC5cbiAgICAgKi9cbiAgICBpZiAoIWNhcGFiaWxpdGllcykge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBhc3N1bWUgc2Vzc2lvbiB0byBiZSBhIFdlYkRyaXZlciBzZXNzaW9uIHdoZW5cbiAgICAgKiAtIGNhcGFiaWxpdGllcyBhcmUgcmV0dXJuZWRcbiAgICAgKiAgIChodHRwczovL3czYy5naXRodWIuaW8vd2ViZHJpdmVyLyNkZm4tbmV3LXNlc3Npb25zKVxuICAgICAqIC0gcGxhdGZvcm1OYW1lIGlzIHJldHVybmVkIHdoaWNoIGlzIG5vdCBkZWZpbmVkIGluIHRoZSBKU09OV2lyZSBwcm90b2NvbFxuICAgICAqL1xuICAgIGNvbnN0IGlzQXBwaXVtID0gY2FwYWJpbGl0aWVzLmF1dG9tYXRpb25OYW1lIHx8IGNhcGFiaWxpdGllcy5kZXZpY2VOYW1lXG4gICAgcmV0dXJuIEJvb2xlYW4oY2FwYWJpbGl0aWVzLnBsYXRmb3JtTmFtZSB8fCBpc0FwcGl1bSlcbn1cbiJdfQ==