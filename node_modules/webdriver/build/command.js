"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _request = _interopRequireDefault(require("./request"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('webdriver');

function _default(method, endpointUri, commandInfo) {
  const {
    command,
    ref,
    parameters,
    variables = []
  } = commandInfo;
  return function (...args) {
    let endpoint = endpointUri; // clone endpointUri in case we change it

    const commandParams = [...variables.map(v => Object.assign(v, {
      /**
       * url variables are:
       */
      required: true,
      // always required as they are part of the endpoint
      type: 'string' // have to be always type of string

    })), ...parameters];
    const commandUsage = `${command}(${commandParams.map(p => p.name).join(', ')})`;
    const moreInfo = `\n\nFor more info see ${ref}\n`;
    const body = {};
    /**
     * parameter check
     */

    const minAllowedParams = commandParams.filter(param => param.required).length;

    if (args.length < minAllowedParams || args.length > commandParams.length) {
      const parameterDescription = commandParams.length ? `\n\nProperty Description:\n${commandParams.map(p => `  "${p.name}" (${p.type}): ${p.description}`).join('\n')}` : '';
      throw new Error(`Wrong parameters applied for ${command}\n` + `Usage: ${commandUsage}` + parameterDescription + moreInfo);
    }
    /**
     * parameter type check
     */


    for (const [i, arg] of Object.entries(args)) {
      const commandParam = commandParams[i];

      if (!(0, _utils.isValidParameter)(arg, commandParam.type)) {
        /**
         * ignore if argument is not required
         */
        if (typeof arg === 'undefined' && !commandParam.required) {
          continue;
        }

        throw new Error(`Malformed type for "${commandParam.name}" parameter of command ${command}\n` + `Expected: ${commandParam.type}\n` + `Actual: ${typeof arg}` + moreInfo);
      }
      /**
       * inject url variables
       */


      if (i < variables.length) {
        endpoint = endpoint.replace(`:${commandParams[i].name}`, arg);
        continue;
      }
      /**
       * rest of args are part of body payload
       */


      body[commandParams[i].name] = arg;
    }

    const request = new _request.default(method, endpoint, body);
    this.emit('command', {
      method,
      endpoint,
      body
    });
    log.info('COMMAND', (0, _utils.commandCallStructure)(command, args));
    return request.makeRequest(this.options, this.sessionId).then(result => {
      if (result.value) {
        log.info('RESULT', result.value);
      }

      this.emit('result', {
        method,
        endpoint,
        body,
        result
      });
      return result.value;
    });
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLmpzIl0sIm5hbWVzIjpbImxvZyIsIm1ldGhvZCIsImVuZHBvaW50VXJpIiwiY29tbWFuZEluZm8iLCJjb21tYW5kIiwicmVmIiwicGFyYW1ldGVycyIsInZhcmlhYmxlcyIsImFyZ3MiLCJlbmRwb2ludCIsImNvbW1hbmRQYXJhbXMiLCJtYXAiLCJ2IiwiT2JqZWN0IiwiYXNzaWduIiwicmVxdWlyZWQiLCJ0eXBlIiwiY29tbWFuZFVzYWdlIiwicCIsIm5hbWUiLCJqb2luIiwibW9yZUluZm8iLCJib2R5IiwibWluQWxsb3dlZFBhcmFtcyIsImZpbHRlciIsInBhcmFtIiwibGVuZ3RoIiwicGFyYW1ldGVyRGVzY3JpcHRpb24iLCJkZXNjcmlwdGlvbiIsIkVycm9yIiwiaSIsImFyZyIsImVudHJpZXMiLCJjb21tYW5kUGFyYW0iLCJyZXBsYWNlIiwicmVxdWVzdCIsIldlYkRyaXZlclJlcXVlc3QiLCJlbWl0IiwiaW5mbyIsIm1ha2VSZXF1ZXN0Iiwib3B0aW9ucyIsInNlc3Npb25JZCIsInRoZW4iLCJyZXN1bHQiLCJ2YWx1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUcscUJBQU8sV0FBUCxDQUFaOztBQUVlLGtCQUFVQyxNQUFWLEVBQWtCQyxXQUFsQixFQUErQkMsV0FBL0IsRUFBNEM7QUFDdkQsUUFBTTtBQUFFQyxJQUFBQSxPQUFGO0FBQVdDLElBQUFBLEdBQVg7QUFBZ0JDLElBQUFBLFVBQWhCO0FBQTRCQyxJQUFBQSxTQUFTLEdBQUc7QUFBeEMsTUFBK0NKLFdBQXJEO0FBRUEsU0FBTyxVQUFVLEdBQUdLLElBQWIsRUFBbUI7QUFDdEIsUUFBSUMsUUFBUSxHQUFHUCxXQUFmLENBRHNCLENBQ0s7O0FBQzNCLFVBQU1RLGFBQWEsR0FBRyxDQUFDLEdBQUdILFNBQVMsQ0FBQ0ksR0FBVixDQUFlQyxDQUFELElBQU9DLE1BQU0sQ0FBQ0MsTUFBUCxDQUFj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QTlCLENBQXBCO0FBQ0EsV0FBTzJCLE9BQU8sQ0FBQ0ksV0FBUixDQUFvQixLQUFLQyxPQUF6QixFQUFrQyxLQUFLQyxTQUF2QyxFQUFrREMsSUFBbEQsQ0FBd0RDLE1BQUQsSUFBWTtBQUN0RSxVQUFJQSxNQUFNLENBQUNDLEtBQVgsRUFBa0I7QUFDZDVDLFFBQUFBLEdBQUcsQ0FBQ3NDLElBQUosQ0FBUyxRQUFULEVBQW1CSyxNQUFNLENBQUNDLEtBQTFCO0FBQ0g7O0FBRUQsV0FBS1AsSUFBTCxDQUFVLFFBQVYsRUFBb0I7QUFBRXBDLFFBQUFBLE1BQUY7QUFBVVEsUUFBQUEsUUFBVjtBQUFvQmEsUUFBQUEsSUFBcEI7QUFBMEJxQixRQUFBQTtBQUExQixPQUFwQjtBQUNBLGFBQU9BLE1BQU0sQ0FBQ0MsS0FBZDtBQUNILEtBUE0sQ0FBUDtBQVFILEdBOUVEO0FBK0VIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZ2dlciBmcm9tICdAd2Rpby9sb2dnZXInXG5pbXBvcnQgV2ViRHJpdmVyUmVxdWVzdCBmcm9tICcuL3JlcXVlc3QnXG5pbXBvcnQgeyBpc1ZhbGlkUGFyYW1ldGVyLCBjb21tYW5kQ2FsbFN0cnVjdHVyZSB9IGZyb20gJy4vdXRpbHMnXG5cbmNvbnN0IGxvZyA9IGxvZ2dlcignd2ViZHJpdmVyJylcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKG1ldGhvZCwgZW5kcG9pbnRVcmksIGNvbW1hbmRJbmZvKSB7XG4gICAgY29uc3QgeyBjb21tYW5kLCByZWYsIHBhcmFtZXRlcnMsIHZhcmlhYmxlcyA9IFtdIH0gPSBjb21tYW5kSW5mb1xuXG4gICAgcmV0dXJuIGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgIGxldCBlbmRwb2ludCA9IGVuZHBvaW50VXJpIC8vIGNsb25lIGVuZHBvaW50VXJpIGluIGNhc2Ugd2UgY2hhbmdlIGl0XG4gICAgICAgIGNvbnN0IGNvbW1hbmRQYXJhbXMgPSBbLi4udmFyaWFibGVzLm1hcCgodikgPT4gT2JqZWN0LmFzc2lnbih2LCB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHVybCB2YXJpYWJsZXMgYXJlOlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSwgLy8gYWx3YXlzIHJlcXVpcmVkIGFzIHRoZXkgYXJlIHBhcnQgb2YgdGhlIGVuZHBvaW50XG4gICAgICAgICAgICB0eXBlOiAnc3RyaW5nJyAgLy8gaGF2ZSB0byBiZSBhbHdheXMgdHlwZSBvZiBzdHJpbmdcbiAgICAgICAgfSkpLCAuLi5wYXJhbWV0ZXJzXVxuXG4gICAgICAgIGNvbnN0IGNvbW1hbmRVc2FnZSA9IGAke2NvbW1hbmR9KCR7Y29tbWFuZFBhcmFtcy5tYXAoKHApID0+IHAubmFtZSkuam9pbignLCAnKX0pYFxuICAgICAgICBjb25zdCBtb3JlSW5mbyA9IGBcXG5cXG5Gb3IgbW9yZSBpbmZvIHNlZSAke3JlZn1cXG5gXG4gICAgICAgIGNvbnN0IGJvZHkgPSB7fVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBwYXJhbWV0ZXIgY2hlY2tcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IG1pbkFsbG93ZWRQYXJhbXMgPSBjb21tYW5kUGFyYW1zLmZpbHRlcigocGFyYW0pID0+IHBhcmFtLnJlcXVpcmVkKS5sZW5ndGhcbiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgbWluQWxsb3dlZFBhcmFtcyB8fCBhcmdzLmxlbmd0aCA+IGNvbW1hbmRQYXJhbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJEZXNjcmlwdGlvbiA9IGNvbW1hbmRQYXJhbXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgPyBgXFxuXFxuUHJvcGVydHkgRGVzY3JpcHRpb246XFxuJHtjb21tYW5kUGFyYW1zLm1hcCgocCkgPT4gYCAgXCIke3AubmFtZX1cIiAoJHtwLnR5cGV9KTogJHtwLmRlc2NyaXB0aW9ufWApLmpvaW4oJ1xcbicpfWBcbiAgICAgICAgICAgICAgICA6ICcnXG5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICBgV3JvbmcgcGFyYW1ldGVycyBhcHBsaWVkIGZvciAke2NvbW1hbmR9XFxuYCArXG4gICAgICAgICAgICAgICAgYFVzYWdlOiAke2NvbW1hbmRVc2FnZX1gICtcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJEZXNjcmlwdGlvbiArXG4gICAgICAgICAgICAgICAgbW9yZUluZm9cbiAgICAgICAgICAgIClcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBwYXJhbWV0ZXIgdHlwZSBjaGVja1xuICAgICAgICAgKi9cbiAgICAgICAgZm9yIChjb25zdCBbaSwgYXJnXSBvZiBPYmplY3QuZW50cmllcyhhcmdzKSkge1xuICAgICAgICAgICAgY29uc3QgY29tbWFuZFBhcmFtID0gY29tbWFuZFBhcmFtc1tpXVxuXG4gICAgICAgICAgICBpZiAoIWlzVmFsaWRQYXJhbWV0ZXIoYXJnLCBjb21tYW5kUGFyYW0udHlwZSkpIHtcbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBpZ25vcmUgaWYgYXJndW1lbnQgaXMgbm90IHJlcXVpcmVkXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnICYmICFjb21tYW5kUGFyYW0ucmVxdWlyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgICAgIGBNYWxmb3JtZWQgdHlwZSBmb3IgXCIke2NvbW1hbmRQYXJhbS5uYW1lfVwiIHBhcmFtZXRlciBvZiBjb21tYW5kICR7Y29tbWFuZH1cXG5gICtcbiAgICAgICAgICAgICAgICAgICAgYEV4cGVjdGVkOiAke2NvbW1hbmRQYXJhbS50eXBlfVxcbmAgK1xuICAgICAgICAgICAgICAgICAgICBgQWN0dWFsOiAke3R5cGVvZiBhcmd9YCArXG4gICAgICAgICAgICAgICAgICAgIG1vcmVJbmZvXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGluamVjdCB1cmwgdmFyaWFibGVzXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmIChpIDwgdmFyaWFibGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGVuZHBvaW50ID0gZW5kcG9pbnQucmVwbGFjZShgOiR7Y29tbWFuZFBhcmFtc1tpXS5uYW1lfWAsIGFyZylcbiAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHJlc3Qgb2YgYXJncyBhcmUgcGFydCBvZiBib2R5IHBheWxvYWRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgYm9keVtjb21tYW5kUGFyYW1zW2ldLm5hbWVdID0gYXJnXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFdlYkRyaXZlclJlcXVlc3QobWV0aG9kLCBlbmRwb2ludCwgYm9keSlcbiAgICAgICAgdGhpcy5lbWl0KCdjb21tYW5kJywgeyBtZXRob2QsIGVuZHBvaW50LCBib2R5IH0pXG4gICAgICAgIGxvZy5pbmZvKCdDT01NQU5EJywgY29tbWFuZENhbGxTdHJ1Y3R1cmUoY29tbWFuZCwgYXJncykpXG4gICAgICAgIHJldHVybiByZXF1ZXN0Lm1ha2VSZXF1ZXN0KHRoaXMub3B0aW9ucywgdGhpcy5zZXNzaW9uSWQpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC52YWx1ZSkge1xuICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdSRVNVTFQnLCByZXN1bHQudmFsdWUpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZW1pdCgncmVzdWx0JywgeyBtZXRob2QsIGVuZHBvaW50LCBib2R5LCByZXN1bHQgfSlcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQudmFsdWVcbiAgICAgICAgfSlcbiAgICB9XG59XG4iXX0=