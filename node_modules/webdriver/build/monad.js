"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = WebDriver;

require("source-map-support/register");

var _events = require("events");

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const SCOPE_TYPES = {
  'browser': function Browser() {},
  'element': function Element() {}
};

function WebDriver(options, modifier, propertiesObject = {}) {
  /**
   * In order to allow named scopes for elements we have to propagate that
   * info within the `propertiesObject` object. This doesn't have any functional
   * advantages just provides better description of objects when debugging them
   */
  const scopeType = SCOPE_TYPES[propertiesObject.scope] || SCOPE_TYPES['browser'];
  delete propertiesObject.scope;
  const prototype = Object.create(scopeType.prototype, {
    isW3C: {
      value: options.isW3C
    }
  });
  const log = (0, _logger.default)('webdriver');
  const eventHandler = new _events.EventEmitter();
  const EVENTHANDLER_FUNCTIONS = Object.getPrototypeOf(eventHandler);
  /**
   * WebDriver monad
   */

  function unit(sessionId, commandWrapper) {
    propertiesObject.commandList = {
      value: Object.keys(propertiesObject)
    };
    propertiesObject.options = {
      value: options
      /**
       * allow to wrap commands if necessary
       * e.g. in wdio-cli to make them synchronous
       */

    };

    if (typeof commandWrapper === 'function') {
      for (const [commandName, {
        value
      }] of Object.entries(propertiesObject)) {
        if (typeof value !== 'function') {
          continue;
        }

        propertiesObject[commandName].value = commandWrapper(commandName, value);
      }
    }

    let client = Object.create(prototype, propertiesObject);
    client.sessionId = sessionId;
    /**
     * register capabilities only to browser scope
     */

    if (scopeType.name === 'Browser') {
      client.capabilities = options.capabilities;
    }

    if (typeof modifier === 'function') {
      client = modifier(client, options);
    }

    client.addCommand = function (name, func, proto) {
      unit.lift(name, commandWrapper(name, func), proto);
    };

    return client;
  }
  /**
   * Enhance monad prototype with function
   * @param  {String}   name   name of function to attach to prototype
   * @param  {Function} func   function to be added to prototype
   * @param  {Object}   proto  prototype to add function to (optional)
   */


  unit.lift = function (name, func, proto) {
    (proto || prototype)[name] = function next(...args) {
      const client = unit(this.sessionId);
      log.info('COMMAND', (0, _utils.commandCallStructure)(name, args));
      /**
       * set name of function for better error stack
       */

      Object.defineProperty(func, 'name', {
        value: name,
        writable: false
      });
      const result = func.apply(client, args);
      /**
       * always transform result into promise as we don't know whether or not
       * the user is running tests with wdio-sync or not
       */

      Promise.resolve(result).then(res => {
        log.info('RESULT', res);
        this.emit('result', {
          name,
          result: res
        });
      });
      return result;
    };
  };
  /**
   * register event emitter
   */


  for (let eventCommand in EVENTHANDLER_FUNCTIONS) {
    prototype[eventCommand] = function (...args) {
      eventHandler[eventCommand](...args);
      return this;
    };
  }

  return unit;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb25hZC5qcyJdLCJuYW1lcyI6WyJTQ09QRV9UWVBFUyIsIkJyb3dzZXIiLCJFbGVtZW50IiwiV2ViRHJpdmVyIiwib3B0aW9ucyIsIm1vZGlmaWVyIiwicHJvcGVydGllc09iamVjdCIsInNjb3BlVHlwZSIsInNjb3BlIiwicHJvdG90eXBlIiwiT2JqZWN0IiwiY3JlYXRlIiwiaXNXM0MiLCJ2YWx1ZSIsImxvZyIsImV2ZW50SGFuZGxlciIsIkV2ZW50RW1pdHRlciIsIkVWRU5USEFORExFUl9GVU5DVElPTlMiLCJnZXRQcm90b3R5cGVPZiIsInVuaXQiLCJzZXNzaW9uSWQiLCJjb21tYW5kV3JhcHBlciIsImNvbW1hbmRMaXN0Iiwia2V5cyIsImNvbW1hbmROYW1lIiwiZW50cmllcyIsImNsaWVudCIsIm5hbWUiLCJjYXBhYmlsaXRpZXMiLCJhZGRDb21tYW5kIiwiZnVuYyIsInByb3RvIiwibGlmdCIsIm5leHQiLCJhcmdzIiwiaW5mbyIsImRlZmluZVByb3BlcnR5Iiwid3JpdGFibGUiLCJyZXN1bHQiLCJhcHBseSIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsInJlcyIsImVtaXQiLCJldmVudENvbW1hbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOzs7O0FBRUEsTUFBTUEsV0FBVyxHQUFHO0FBQ2hCLGFBQVcsU0FBU0MsT0FBVCxHQUFvQixDQUFFLENBRGpCO0FBRWhCLGFBQVcsU0FBU0MsT0FBVCxHQUFvQixDQUFFO0FBRmpCLENBQXBCOztBQUtlLFNBQVNDLFNBQVQsQ0FBb0JDLE9BQXBCLEVBQTZCQyxRQUE3QixFQUF1Q0MsZ0JBQWdCLEdBQUcsRUFBMUQsRUFBOEQ7QUFDekU7Ozs7O0FBS0EsUUFBTUMsU0FBUyxHQUFHUCxXQUFXLENBQUNNLGdCQUFnQixDQUFDRSxLQUFsQixDQUFYLElBQXVDUixXQUFXLENBQUMsU0FBRCxDQUFwRTtBQUNBLFNBQU9NLGdCQUFnQixDQUFDRSxLQUF4QjtBQUVB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QUFNLEdBQUdSLElBQUksQ0FBQ1MsS0FBTCxDQUFXYixNQUFYLEVBQW1CUSxJQUFuQixDQUFmO0FBRUE7Ozs7O0FBSUFNLE1BQUFBLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQkgsTUFBaEIsRUFBd0JJLElBQXhCLENBQThCQyxHQUFELElBQVM7QUFDbEM3QixRQUFBQSxHQUFHLENBQUNxQixJQUFKLENBQVMsUUFBVCxFQUFtQlEsR0FBbkI7QUFDQSxhQUFLQyxJQUFMLENBQVUsUUFBVixFQUFvQjtBQUFFakIsVUFBQUEsSUFBRjtBQUFRVyxVQUFBQSxNQUFNLEVBQUVLO0FBQWhCLFNBQXBCO0FBQ0gsT0FIRDtBQUtBLGFBQU9MLE1BQVA7QUFDSCxLQXhCRDtBQXlCSCxHQTFCRDtBQTRCQTs7Ozs7QUFHQSxPQUFLLElBQUlPLFlBQVQsSUFBeUI1QixzQkFBekIsRUFBaUQ7QUFDN0NSLElBQUFBLFNBQVMsQ0FBQ29DLFlBQUQsQ0FBVCxHQUEwQixVQUFVLEdBQUdYLElBQWIsRUFBbUI7QUFDekNuQixNQUFBQSxZQUFZLENBQUM4QixZQUFELENBQVosQ0FBMkIsR0FBR1gsSUFBOUI7QUFDQSxhQUFPLElBQVA7QUFDSCxLQUhEO0FBSUg7O0FBRUQsU0FBT2YsSUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJ1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAd2Rpby9sb2dnZXInXG5cbmltcG9ydCB7IGNvbW1hbmRDYWxsU3RydWN0dXJlIH0gZnJvbSAnLi91dGlscydcblxuY29uc3QgU0NPUEVfVFlQRVMgPSB7XG4gICAgJ2Jyb3dzZXInOiBmdW5jdGlvbiBCcm93c2VyICgpIHt9LFxuICAgICdlbGVtZW50JzogZnVuY3Rpb24gRWxlbWVudCAoKSB7fVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBXZWJEcml2ZXIgKG9wdGlvbnMsIG1vZGlmaWVyLCBwcm9wZXJ0aWVzT2JqZWN0ID0ge30pIHtcbiAgICAvKipcbiAgICAgKiBJbiBvcmRlciB0byBhbGxvdyBuYW1lZCBzY29wZXMgZm9yIGVsZW1lbnRzIHdlIGhhdmUgdG8gcHJvcGFnYXRlIHRoYXRcbiAgICAgKiBpbmZvIHdpdGhpbiB0aGUgYHByb3BlcnRpZXNPYmplY3RgIG9iamVjdC4gVGhpcyBkb2Vzbid0IGhhdmUgYW55IGZ1bmN0aW9uYWxcbiAgICAgKiBhZHZhbnRhZ2VzIGp1c3QgcHJvdmlkZXMgYmV0dGVyIGRlc2NyaXB0aW9uIG9mIG9iamVjdHMgd2hlbiBkZWJ1Z2dpbmcgdGhlbVxuICAgICAqL1xuICAgIGNvbnN0IHNjb3BlVHlwZSA9IFNDT1BFX1RZUEVTW3Byb3BlcnRpZXNPYmplY3Quc2NvcGVdIHx8IFNDT1BFX1RZUEVTWydicm93c2VyJ11cbiAgICBkZWxldGUgcHJvcGVydGllc09iamVjdC5zY29wZVxuXG4gICAgY29uc3QgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzY29wZVR5cGUucHJvdG90eXBlLCB7XG4gICAgICAgIGlzVzNDOiB7IHZhbHVlOiBvcHRpb25zLmlzVzNDIH1cbiAgICB9KVxuICAgIGNvbnN0IGxvZyA9IGxvZ2dlcignd2ViZHJpdmVyJylcblxuICAgIGNvbnN0IGV2ZW50SGFuZGxlciA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuICAgIGNvbnN0IEVWRU5USEFORExFUl9GVU5DVElPTlMgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoZXZlbnRIYW5kbGVyKVxuXG4gICAgLyoqXG4gICAgICogV2ViRHJpdmVyIG1vbmFkXG4gICAgICovXG4gICAgZnVuY3Rpb24gdW5pdCAoc2Vzc2lvbklkLCBjb21tYW5kV3JhcHBlcikge1xuICAgICAgICBwcm9wZXJ0aWVzT2JqZWN0LmNvbW1hbmRMaXN0ID0geyB2YWx1ZTogT2JqZWN0LmtleXMocHJvcGVydGllc09iamVjdCkgfVxuICAgICAgICBwcm9wZXJ0aWVzT2JqZWN0Lm9wdGlvbnMgPSB7IHZhbHVlOiBvcHRpb25zIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogYWxsb3cgdG8gd3JhcCBjb21tYW5kcyBpZiBuZWNlc3NhcnlcbiAgICAgICAgICogZS5nLiBpbiB3ZGlvLWNsaSB0byBtYWtlIHRoZW0gc3luY2hyb25vdXNcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0eXBlb2YgY29tbWFuZFdyYXBwZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgW2NvbW1hbmROYW1lLCB7IHZhbHVlIH1dIG9mIE9iamVjdC5lbnRyaWVzKHByb3BlcnRpZXNPYmplY3QpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHByb3BlcnRpZXNPYmplY3RbY29tbWFuZE5hbWVdLnZhbHVlID0gY29tbWFuZFdyYXBwZXIoY29tbWFuZE5hbWUsIHZhbHVlKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNsaWVudCA9IE9iamVjdC5jcmVhdGUocHJvdG90eXBlLCBwcm9wZXJ0aWVzT2JqZWN0KVxuICAgICAgICBjbGllbnQuc2Vzc2lvbklkID0gc2Vzc2lvbklkXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlZ2lzdGVyIGNhcGFiaWxpdGllcyBvbmx5IHRvIGJyb3dzZXIgc2NvcGVcbiAgICAgICAgICovXG4gICAgICAgIGlmIChzY29wZVR5cGUubmFtZSA9PT0gJ0Jyb3dzZXInKSB7XG4gICAgICAgICAgICBjbGllbnQuY2FwYWJpbGl0aWVzID0gb3B0aW9ucy5jYXBhYmlsaXRpZXNcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgbW9kaWZpZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNsaWVudCA9IG1vZGlmaWVyKGNsaWVudCwgb3B0aW9ucylcbiAgICAgICAgfVxuXG4gICAgICAgIGNsaWVudC5hZGRDb21tYW5kID0gZnVuY3Rpb24gKG5hbWUsIGZ1bmMsIHByb3RvKSB7XG4gICAgICAgICAgICB1bml0LmxpZnQobmFtZSwgY29tbWFuZFdyYXBwZXIobmFtZSwgZnVuYyksIHByb3RvKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEVuaGFuY2UgbW9uYWQgcHJvdG90eXBlIHdpdGggZnVuY3Rpb25cbiAgICAgKiBAcGFyYW0gIHtTdHJpbmd9ICAgbmFtZSAgIG5hbWUgb2YgZnVuY3Rpb24gdG8gYXR0YWNoIHRvIHByb3RvdHlwZVxuICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmdW5jICAgZnVuY3Rpb24gdG8gYmUgYWRkZWQgdG8gcHJvdG90eXBlXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSAgIHByb3RvICBwcm90b3R5cGUgdG8gYWRkIGZ1bmN0aW9uIHRvIChvcHRpb25hbClcbiAgICAgKi9cbiAgICB1bml0LmxpZnQgPSBmdW5jdGlvbiAobmFtZSwgZnVuYywgcHJvdG8pIHtcbiAgICAgICAgKHByb3RvIHx8IHByb3RvdHlwZSlbbmFtZV0gPSBmdW5jdGlvbiBuZXh0ICguLi5hcmdzKSB7XG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSB1bml0KHRoaXMuc2Vzc2lvbklkKVxuICAgICAgICAgICAgbG9nLmluZm8oJ0NPTU1BTkQnLCBjb21tYW5kQ2FsbFN0cnVjdHVyZShuYW1lLCBhcmdzKSlcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBzZXQgbmFtZSBvZiBmdW5jdGlvbiBmb3IgYmV0dGVyIGVycm9yIHN0YWNrXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmdW5jLCAnbmFtZScsIHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogbmFtZSxcbiAgICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBmdW5jLmFwcGx5KGNsaWVudCwgYXJncylcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBhbHdheXMgdHJhbnNmb3JtIHJlc3VsdCBpbnRvIHByb21pc2UgYXMgd2UgZG9uJ3Qga25vdyB3aGV0aGVyIG9yIG5vdFxuICAgICAgICAgICAgICogdGhlIHVzZXIgaXMgcnVubmluZyB0ZXN0cyB3aXRoIHdkaW8tc3luYyBvciBub3RcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCkudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1JFU1VMVCcsIHJlcylcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3Jlc3VsdCcsIHsgbmFtZSwgcmVzdWx0OiByZXMgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHJlZ2lzdGVyIGV2ZW50IGVtaXR0ZXJcbiAgICAgKi9cbiAgICBmb3IgKGxldCBldmVudENvbW1hbmQgaW4gRVZFTlRIQU5ETEVSX0ZVTkNUSU9OUykge1xuICAgICAgICBwcm90b3R5cGVbZXZlbnRDb21tYW5kXSA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgICAgICBldmVudEhhbmRsZXJbZXZlbnRDb21tYW5kXSguLi5hcmdzKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB1bml0XG59XG4iXX0=